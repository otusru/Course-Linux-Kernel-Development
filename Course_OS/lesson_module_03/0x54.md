–û—Ç–ª–∏—á–Ω–æ! üöÄ –ü–æ–≥—Ä—É–∂–∞–µ–º—Å—è –µ—â—ë –≥–ª—É–±–∂–µ.

---

## üîπ –£—Ä–æ–∫ 54. –ú–µ—Ö–∞–Ω–∏–∑–º TLB, INVLPG –∏ —É—Å–∫–æ—Ä–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å –ø–∞–º—è—Ç—å—é üß†‚öôÔ∏è

---

### üß† –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å (–æ–±—ä—ë–º: \~2500 —Å–ª–æ–≤)

–í –ø—Ä–æ—à–ª—ã—Ö —É—Ä–æ–∫–∞—Ö –º—ã –ø–æ—Å—Ç—Ä–æ–∏–ª–∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü, —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª–∏ –∏–∑–æ–ª—è—Ü–∏—é –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –ø–æ–Ω—è–ª–∏, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å. –û–¥–Ω–∞–∫–æ –º–µ–∂–¥—É –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º –∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–º –∞–¥—Ä–µ—Å–æ–º –Ω—É–∂–Ω–æ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –¥–µ–ª–∞—Ç—å —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å *–º–µ–¥–ª–µ–Ω–Ω–æ*... –µ—Å–ª–∏ –±—ã –Ω–µ üí° **TLB ‚Äî Translation Lookaside Buffer**.

#### üìå –ß—Ç–æ —Ç–∞–∫–æ–µ TLB?

**TLB** ‚Äî —ç—Ç–æ –Ω–µ–±–æ–ª—å—à–æ–π, –Ω–æ –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–π –∫—ç—à –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞. –û–Ω —Ö—Ä–∞–Ω–∏—Ç —Ç–∞–±–ª–∏—Ü—É –Ω–µ–¥–∞–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤ –≤ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü, –∫–æ—Ç–æ—Ä–∞—è –ª–µ–∂–∏—Ç –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏, TLB –Ω–∞—Ö–æ–¥–∏—Ç—Å—è *–≤–Ω—É—Ç—Ä–∏ —Å–∞–º–æ–≥–æ CPU* –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ.

* –ï—Å–ª–∏ –Ω—É–∂–Ω—ã–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å —É–∂–µ –µ—Å—Ç—å –≤ TLB ‚Üí *–º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è* ‚úÖ
* –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è —á–∏—Ç–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å—Ç—Ä–∞–Ω–∏—Ü –∏–∑ –ø–∞–º—è—Ç–∏ ‚Üí *–¥–æ—Ä–æ–≥–æ* ‚ùå

> –í —Å—Ä–µ–¥–Ω–µ–º, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å TLB –¥–æ—Å—Ç–∏–≥–∞–µ—Ç 98‚Äì99%. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –µ–≥–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã.

---

### üìå –ö–æ–≥–¥–∞ TLB —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è?

* –ü—Ä–∏ —Å–º–µ–Ω–µ CR3 (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü)
* –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤—Ä—É—á–Ω—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–∏ –∏–ª–∏ –≤—ã–¥–µ–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–π –ø–∞–º—è—Ç–∏)
* –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ `INVLPG` (Invalidate Page)

---

### üìå –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è `invlpg`

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è `INVLPG` —Å–æ–æ–±—â–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—É, —á—Ç–æ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞ –±–æ–ª—å—à–µ –Ω–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞, –∏ –µ—ë –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–∑ TLB.

```nasm
invlpg [eax]  ; —É–¥–∞–ª–∏—Ç—å –∏–∑ TLB —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é –ø–æ –∞–¥—Ä–µ—Å—É –≤ eax
```

–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ —è–¥—Ä–µ, –æ–±—ã—á–Ω–æ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü.

---

### üß™ –ü—Ä–∏–º–µ—Ä –Ω–∞ C23 + –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∞—Å—Å–µ–º–±–ª–µ—Ä

```c
#include <stdint.h>

// –£–¥–∞–ª—è–µ—Ç –æ–¥–Ω—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑ TLB
void invalidate_page(uint32_t addr) {
    asm volatile("invlpg (%0)" :: "r" (addr) : "memory");
}
```

üìå –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü, –µ—Å–ª–∏ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ CR3.

---

### üß© –†–∞–±–æ—Ç–∞ —Å TLB –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

–ö–∞–∂–¥—ã–π –ø—Ä–æ—Ü–µ—Å—Å –∏–º–µ–µ—Ç —Å–≤–æ—ë –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ ‚Üí –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ *–æ—á–∏—Å—Ç–∏—Ç—å TLB*:

```c
void switch_directory(uint32_t* new_directory) {
    asm volatile("mov %0, %%cr3" :: "r"(new_directory));
}
```

–°–º–µ–Ω–∞ CR3 —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç TLB –ø–æ–ª–Ω–æ—Å—Ç—å—é. –≠—Ç–æ *–Ω–∞–¥—ë–∂–Ω—ã–π* —Å–ø–æ—Å–æ–± —Å–±—Ä–æ—Å–∞ –∫—ç—à–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.

---

### ‚ö†Ô∏è –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã –∏ TLB

üß† –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ CPU Intel/AMD –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç **TLB tagging –ø–æ ASID (Address Space ID)** ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –ø–∞–º—è—Ç–∏. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç *–Ω–µ –æ—á–∏—â–∞—Ç—å* –≤–µ—Å—å TLB –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.

‚õî –û–¥–Ω–∞–∫–æ, –±–µ–∑ –≤–∫–ª—é—á–µ–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ASID (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ Extended Page Tables, EPT –∏–ª–∏ –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞—Ö —Å —è–¥—Ä–æ–º –Ω–∞ ARM) –≤–∞–º –ø—Ä–∏–¥—ë—Ç—Å—è –≤—Ä—É—á–Ω—É—é —É–ø—Ä–∞–≤–ª—è—Ç—å TLB —Å–±—Ä–æ—Å–∞–º–∏.

---

### üìö –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

* Intel¬Æ Software Developer Manual Vol. 3 ‚Äî Chapter 4: Paging
* OSDev Wiki: [TLB and Paging](https://wiki.osdev.org/TLB)
* –ö–Ω–∏–≥–∞: ‚ÄúModern Operating Systems‚Äù ‚Äî Andrew S. Tanenbaum
* –ö—É—Ä—Å MIT 6.828: [Lecture on Paging and TLB](https://pdos.csail.mit.edu/6.828/)

---

### ‚úÖ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ

**–ó–∞–¥–∞—á–∞:** –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É TLB-–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ —Å–≤–æ–µ–π –û–°.

1. –û–±–Ω–æ–≤–∏—Ç–µ –≤–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç—å—é —Ç–∞–∫, —á—Ç–æ–±—ã:

   * –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—ã–∑—ã–≤–∞–ª—Å—è `invalidate_page(addr)`
   * –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∞ –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —á–µ—Ä–µ–∑ `mov cr3, new_dir`

2. –ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥:

   * –ò–∑–º–µ–Ω–∏—Ç–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
   * –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥—Ä–µ—Å—É –î–û –∏ –ü–û–°–õ–ï —Å–±—Ä–æ—Å–∞ TLB.
   * –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å.

```c
// –ü—Ä–∏–º–µ—Ä —Ç–µ—Å—Ç–∞
write_to_page(0x1000, 0xAABBCCDD);
change_mapping(0x1000, new_phys_addr);
invalidate_page(0x1000);
assert(read_from_page(0x1000) == expected_new_value);
```

---

üî¢ **–°–ª–æ–∂–Ω–æ—Å—Ç—å**: 6/10
üïí **–í—Ä–µ–º—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ**: 5‚Äì6 —á–∞—Å–æ–≤
üéì **–ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è**: —Å—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã TLB ‚Üí –ª–µ–∫—Ü–∏—è ‚Üí –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è ‚Üí —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è ‚Üí —Ç–µ—Å—Ç—ã

---

–ì–æ—Ç–æ–≤—ã –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É? –ù–∞–ø–∏—à–∏—Ç–µ **–¥–∞–¥–∞–¥–∞** ‚Äî –∏ –º—ã –¥–≤–∏–Ω–µ–º—Å—è –¥–∞–ª—å—à–µ! üß†üíª
