–û—Ç–ª–∏—á–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º! üöÄ

---

üîπ **–£—Ä–æ–∫ 44. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: —Å–æ–∑–¥–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–Ω—ã—Ö –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤ –∏ –±–∞–∑–æ–≤—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü** üß±üîê

---

### –¢–µ–º–∞ —É—Ä–æ–∫–∞

* –ó–∞—á–µ–º –Ω—É–∂–Ω—ã –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∞–¥—Ä–µ—Å–Ω—ã–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
* –û—Å–Ω–æ–≤—ã –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏ –∏ —Å—Ç—Ä–∞–Ω–∏—Ü
* –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü —Å—Ç—Ä–∞–Ω–∏—Ü –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ x86\_64
* –í—ã–¥–µ–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü –ø–æ–¥ –ø—Ä–æ—Ü–µ—Å—Å—ã
* –†–∞–±–æ—Ç–∞ —Å CR3 –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–∞–º—è—Ç–∏

---

### –ö—Ä–∞—Ç–∫–æ–µ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–æ–∫–æ–ª–æ 2000‚Äì3000 —Å–ª–æ–≤)

*(–∑–¥–µ—Å—å –±—É–¥–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä, –ø–æ—á–µ–º—É –û–° –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –ø–∞–º—è—Ç—å, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü, —á—Ç–æ —Ç–∞–∫–æ–µ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü (Page Tables), –∑–∞—á–µ–º –∏ –∫–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∞–¥—Ä–µ—Å–Ω—ã–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –≤–∫–ª—é—á–∞—è –ø—Ä–∏–º–µ—Ä—ã –∏–∑ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–≤ Intel/AMD)*

---

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

* [Intel 64 and IA-32 Architectures Software Developer‚Äôs Manual, Volume 3: System Programming Guide](https://software.intel.com/content/www/us/en/develop/articles/intel-sdm.html)
* [OSDev Wiki: Paging](https://wiki.osdev.org/Paging)
* [AMD64 Architecture Programmer‚Äôs Manual](https://developer.amd.com/resources/developer-guides-manuals/)
* –ö–Ω–∏–≥–∞: "Operating Systems: Three Easy Pieces" (–≥–ª–∞–≤—ã –ø–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏)

---

### –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –Ω–∞ C23

```c
// basic_paging.c
#include <stdint.h>
#include "paging.h"
#include "log.h"

// –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –∞–ª–ª–æ–∫–∞—Ç–æ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü
extern void* alloc_page();
extern void free_page(void* page);

// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü 4 —É—Ä–æ–≤–Ω—è (x86_64)
typedef uint64_t page_entry_t;

#define PAGE_PRESENT 0x1
#define PAGE_RW      0x2
#define PAGE_USER    0x4

static page_entry_t* pml4; // –∫–æ—Ä–µ–Ω—å —Ç–∞–±–ª–∏—Ü

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü —Å—Ç—Ä–∞–Ω–∏—Ü
void paging_init() {
    pml4 = (page_entry_t*)alloc_page();
    for (int i = 0; i < 512; i++) {
        pml4[i] = 0;
    }
    klog_info("Paging initialized, PML4 at %p", pml4);
}

// –î–æ–±–∞–≤–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ —Ç–∞–±–ª–∏—Ü—ã
void map_page(void* virt_addr, void* phys_addr, uint64_t flags) {
    uint64_t va = (uint64_t)virt_addr;
    uint64_t pa = (uint64_t)phys_addr;

    size_t pml4_index = (va >> 39) & 0x1FF;
    size_t pdpt_index = (va >> 30) & 0x1FF;
    size_t pd_index   = (va >> 21) & 0x1FF;
    size_t pt_index   = (va >> 12) & 0x1FF;

    page_entry_t* pdpt;
    page_entry_t* pd;
    page_entry_t* pt;

    if (!(pml4[pml4_index] & PAGE_PRESENT)) {
        pdpt = (page_entry_t*)alloc_page();
        for (int i = 0; i < 512; i++) pdpt[i] = 0;
        pml4[pml4_index] = ((uint64_t)pdpt) | PAGE_PRESENT | PAGE_RW | PAGE_USER;
    } else {
        pdpt = (page_entry_t*)(pml4[pml4_index] & ~0xFFF);
    }

    if (!(pdpt[pdpt_index] & PAGE_PRESENT)) {
        pd = (page_entry_t*)alloc_page();
        for (int i = 0; i < 512; i++) pd[i] = 0;
        pdpt[pdpt_index] = ((uint64_t)pd) | PAGE_PRESENT | PAGE_RW | PAGE_USER;
    } else {
        pd = (page_entry_t*)(pdpt[pdpt_index] & ~0xFFF);
    }

    if (!(pd[pd_index] & PAGE_PRESENT)) {
        pt = (page_entry_t*)alloc_page();
        for (int i = 0; i < 512; i++) pt[i] = 0;
        pd[pd_index] = ((uint64_t)pt) | PAGE_PRESENT | PAGE_RW | PAGE_USER;
    } else {
        pt = (page_entry_t*)(pd[pd_index] & ~0xFFF);
    }

    pt[pt_index] = (pa & ~0xFFF) | flags;
    klog_info("Mapped VA %p to PA %p with flags 0x%lx", virt_addr, phys_addr, flags);
}

// –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–∞–º—è—Ç–∏
void switch_page_table(page_entry_t* new_pml4) {
    asm volatile ("mov %0, %%cr3" : : "r"(new_pml4) : "memory");
    klog_info("Switched to new page table %p", new_pml4);
}
```

---

### –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 9/10

> –í —ç—Ç–æ–º —É—Ä–æ–∫–µ —Ç–µ–±–µ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–≤ –∏ —É–º–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±–∏—Ç–æ–≤—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –∏ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç—å—é.

---

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è: 8 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è: 3 —á–∞—Å–∞
* –ü—Ä–∞–∫—Ç–∏–∫–∞ –∏ –æ—Ç–ª–∞–¥–∫–∞: 5 —á–∞—Å–æ–≤

---

### –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* –õ–µ–∫—Ü–∏—è –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–±–æ—Ä —Ç–∞–±–ª–∏—Ü —Å—Ç—Ä–∞–Ω–∏—Ü
* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å CR3 –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
* –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞ ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π –∏ –æ—Ç–ª–∞–¥–∫–∞
* –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –ø–æ–¥ –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–æ—Ü–µ—Å—Å

---

### –í –∫–æ–Ω—Ü–µ —É—Ä–æ–∫–∞

–¢—ã –±—É–¥–µ—à—å –∏–º–µ—Ç—å –±–∞–∑–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ, –∫–∞–∫ –û–° —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∞–º—è—Ç—å—é –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.
–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫ –º—ã —Å–¥–µ–ª–∞–µ–º —à–∞–≥ –≤–ø–µ—Ä—ë–¥ ‚Äî —Ä–µ–∞–ª–∏–∑—É–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∞–¥—Ä–µ—Å–Ω—ã–º–∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞–º–∏!

---

–°–∫–∞–∂–∏ **–¥–∞–¥–∞**, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ! üöÄ
