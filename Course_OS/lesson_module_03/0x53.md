–û—Ç–ª–∏—á–Ω–æ! –í–ø–µ—Ä—ë–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É! üéØ

---

## üîπ –£—Ä–æ–∫ 53. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç—å—é: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –∏–∑–æ–ª—è—Ü–∏—è üß±üß†

---

### üß† –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å (–æ–±—ä—ë–º: \~2500 —Å–ª–æ–≤)

–°–∏—Å—Ç–µ–º—ã —Å –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å—é —Ç—Ä–µ–±—É—é—Ç –∏–∑–æ–ª—è—Ü–∏–∏ –ø–∞–º—è—Ç–∏ –º–µ–∂–¥—É –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —É—Ç–µ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–ª—É—á–∞–π–Ω–æ–µ –∏–ª–∏ –∑–ª–æ–Ω–∞–º–µ—Ä–µ–Ω–Ω–æ–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏. –î–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å** ‚Äî –º–æ—â–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –∫–∞–∂–¥–æ–º—É –ø—Ä–æ—Ü–µ—Å—Å—É "–¥—É–º–∞—Ç—å", —á—Ç–æ —É –Ω–µ–≥–æ –µ—Å—Ç—å –≤—Å—è –ø–∞–º—è—Ç—å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ –≤ —Å–≤–æ—ë–º —Ä–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏–∏.

–ö–ª—é—á–µ–≤—ã–µ –∏–¥–µ–∏ —ç—Ç–æ–≥–æ —É—Ä–æ–∫–∞:

* üß≠ –ö–∞–∂–¥–æ–º—É –ø—Ä–æ—Ü–µ—Å—Å—É —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å—Ç—Ä–∞–Ω–∏—Ü.
* üß± –ò–∑–æ–ª—è—Ü–∏—è –¥–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º CR3 –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É.
* üõ°Ô∏è –Ø–¥—Ä–æ –∑–∞—â–∏—â–µ–Ω–æ –æ—Ç –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏.
* üîÑ –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–∞–º—è—Ç–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞.
* üí° –ö—ç—à TLB (Translation Lookaside Buffer) —É—Å–∫–æ—Ä—è–µ—Ç —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏ –∏ –¥–æ–ª–∂–µ–Ω —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

---

### üîç –ß—Ç–æ —Ç–∞–∫–æ–µ –∏–∑–æ–ª—è—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤?

–í –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ–π –û–° –º—ã –Ω–µ –º–æ–∂–µ–º –ø–æ–∑–≤–æ–ª–∏—Ç—å –æ–¥–Ω–æ–º—É –ø—Ä–æ—Ü–µ—Å—Å—É –≤–º–µ—à–∏–≤–∞—Ç—å—Å—è –≤ –ø–∞–º—è—Ç—å –¥—Ä—É–≥–æ–≥–æ. –ò—Å–ø–æ–ª—å–∑—É—è –º–µ—Ö–∞–Ω–∏–∑–º—ã MMU (Memory Management Unit), –û–° –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç **–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –∞–¥—Ä–µ—Å–∞** –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ –µ–≥–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, —Ñ–∏–∑–∏—á–µ—Å–∫–∏ —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω–æ–µ.

### üìå –ö–ª—é—á–µ–≤—ã–µ —Ñ–ª–∞–≥–∏ –∑–∞—â–∏—Ç—ã

* **P (Present)** ‚Äî —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –ø–∞–º—è—Ç–∏.
* **R/W** ‚Äî —á—Ç–µ–Ω–∏–µ –∏–ª–∏ —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å.
* **U/S** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å/—Å—É–ø–µ—Ä–≤–∏–∑–æ—Ä (–µ—Å–ª–∏ U = 1, –¥–æ—Å—Ç—É–ø –≤–æ–∑–º–æ–∂–µ–Ω –∏–∑ ring 3).

–û–° –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç —ç—Ç–∏ —Ñ–ª–∞–≥–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü, —á—Ç–æ–±—ã –∑–∞—â–∏—Ç–∏—Ç—å —è–¥—Ä–æ –æ—Ç –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∏ –ø–æ–∑–≤–æ–ª–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º –≤ "–ø–µ—Å–æ—á–Ω–∏—Ü—É".

---

### üß™ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä –Ω–∞ C (C23)

```c
#include <stdint.h>
#include <stddef.h>

#define PAGE_PRESENT 0x1
#define PAGE_RW      0x2
#define PAGE_USER    0x4

extern void switch_page_directory(uint32_t* directory);

// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü
typedef struct {
    uint32_t entries[1024] __attribute__((aligned(4096)));
} page_directory_t;

typedef struct {
    uint32_t entries[1024] __attribute__((aligned(4096)));
} page_table_t;

// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞
page_directory_t* create_process_directory() {
    page_directory_t* dir = (page_directory_t*) alloc_page();
    
    // –ü—Ä–∏–º–µ—Ä: –∫–æ–ø–∏—Ä—É–µ–º –∞–¥—Ä–µ—Å–∞ —è–¥—Ä–∞ (–≤–µ—Ä—Ö–Ω—è—è —á–µ—Ç–≤–µ—Ä—Ç—å)
    for (int i = 768; i < 1024; i++) {
        dir->entries[i] = kernel_directory->entries[i];
    }

    // –í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî —á–∏—Å—Ç–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞
    for (int i = 0; i < 768; i++) {
        dir->entries[i] = 0; // –ü–æ–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    }

    return dir;
}

// –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
void activate_process_memory(page_directory_t* dir) {
    asm volatile("mov %0, %%cr3" :: "r"(dir));
}
```

---

### üß© –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –∫–æ–¥—É

* `alloc_page()` ‚Äî —Ñ—É–Ω–∫—Ü–∏—è, –≤—ã–¥–µ–ª—è—é—â–∞—è –≤—ã—Ä–æ–≤–Ω–µ–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É.
* `kernel_directory` ‚Äî –≥–ª–æ–±–∞–ª—å–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º–∞—è —è–¥—Ä–æ–º.
* –í–µ—Ä—Ö–Ω–∏–µ 256 –∑–∞–ø–∏—Å–µ–π (768‚Äì1023) ‚Äî –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ —è–¥—Ä–æ, –Ω–µ –≤–∏–¥–∏–º—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
* –° –ø–æ–º–æ—â—å—é —ç—Ç–æ–π —Å—Ö–µ–º—ã –º–æ–∂–Ω–æ –¥–æ–±–∏—Ç—å—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ —Å–º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –∏–ª–∏ –ø–∏—Å–∞—Ç—å –≤ –ø–∞–º—è—Ç—å —è–¥—Ä–∞.

---

### üìö –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏

* OSDev Wiki: [Process Address Space](https://wiki.osdev.org/Process_Address_Space)
* Intel SDM Volume 3: Memory Protection, CR3 register
* –ö–Ω–∏–≥–∞: ‚ÄúOperating Systems: Three Easy Pieces‚Äù ‚Äî –≥–ª–∞–≤—ã –æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏

---

### ‚úÖ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ

**–ó–∞–¥–∞—á–∞:**
–°–æ–∑–¥–∞–π—Ç–µ —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç—å—é –¥–ª—è –¥–≤—É—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.

**–≠—Ç–∞–ø—ã:**

1. –°–æ–∑–¥–∞–π—Ç–µ –¥–≤–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü: –¥–ª—è —è–¥—Ä–∞ –∏ –ø—Ä–æ—Ü–µ—Å—Å–∞.
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–µ–∫—Ü–∏–∏ —è–¥—Ä–∞ –≤ –∞–¥—Ä–µ—Å–∞ –æ—Ç `0xC0000000`.
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –æ—Ç `0x00000000` –¥–æ `0xBFFFFFFF`.
4. –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–∞–º—è—Ç–∏.
5. –î–æ–±–∞–≤—å—Ç–µ –æ—á–∏—Å—Ç–∫—É TLB —Å –ø–æ–º–æ—â—å—é `invlpg` –∏–ª–∏ —Å–º–µ–Ω—ã CR3.

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

* –ö–∞–∂–¥—ã–π –ø—Ä–æ—Ü–µ—Å—Å –∏–º–µ–µ—Ç —Å–≤–æ—ë –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ.
* –ö–æ–¥ —è–¥—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Ä–µ–∂–∏–º–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
* –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–µ –ª–æ–º–∞–µ—Ç –ø–∞–º—è—Ç—å –¥—Ä—É–≥–æ–≥–æ.

---

üß† –°–ª–æ–∂–Ω–æ—Å—Ç—å: 8/10
‚è≥ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è: 7‚Äì9 —á–∞—Å–æ–≤
üéì –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è: –ª–µ–∫—Ü–∏—è + —Å—Ö–µ–º–∞ –ø–∞–º—è—Ç–∏ + –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤ QEMU + –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ.

---

–ì–æ—Ç–æ–≤—ã –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É—Ä–æ–∫—É? –°–∫–∞–∂–∏—Ç–µ –ø—Ä–æ—Å—Ç–æ: **–¥–∞–¥–∞–¥–∞** üíª‚ú®
