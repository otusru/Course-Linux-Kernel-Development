–û—Ç–ª–∏—á–Ω–æ! üòé –ü–æ–≥—Ä—É–∂–∞–µ–º—Å—è –¥–∞–ª—å—à–µ ‚Äî —Ç–µ–ø–µ—Ä—å –≤ –º–∏—Ä **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –≤ —è–¥—Ä–µ**, –≥–¥–µ –Ω—É–∂–Ω–∞ **–≥–∏–±–∫–æ—Å—Ç—å**, **—Å–∫–æ—Ä–æ—Å—Ç—å** –∏ **–Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å**.

---

## üîπ –£—Ä–æ–∫ 56. –ö—É—á–∞ —è–¥—Ä–∞ (Kernel Heap): –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é –≤–Ω—É—Ç—Ä–∏ –û–° üì¶üß†

---

### üß† –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å (\~3000 —Å–ª–æ–≤)

–í –ø—Ä–µ–¥—ã–¥—É—â–µ–º —É—Ä–æ–∫–µ –º—ã –Ω–∞—É—á–∏–ª–∏—Å—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç—å—é –ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ. –ù–æ —á–∞—Å—Ç–æ –û–° (–∏ —Å–∞–º–æ —è–¥—Ä–æ) –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ **–≥–∏–±–∫–æ–º –≤—ã–¥–µ–ª–µ–Ω–∏–∏ –±–ª–æ–∫–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞** ‚Äî –æ—Ç 8 –±–∞–π—Ç –¥–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ö–ë. –î–ª—è —ç—Ç–æ–≥–æ –∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç **–∫—É—á–∞ —è–¥—Ä–∞** ‚Äî –∞–Ω–∞–ª–æ–≥ `malloc()` –∏ `free()` –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ —è–¥—Ä–∞.

---

### üí° –ó–∞—á–µ–º –Ω—É–∂–Ω–∞ –∫—É—á–∞ —è–¥—Ä–∞?

* –î–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π)
* –î–ª—è –∞–ª–ª–æ–∫–∞—Ü–∏–∏ –¥—Ä–∞–π–≤–µ—Ä–æ–≤ –∏ –±—É—Ñ–µ—Ä–æ–≤
* –î–ª—è —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã, —Å–µ—Ç–µ–≤–æ–≥–æ —Å—Ç–µ–∫–∞ –∏ –¥—Ä—É–≥–∏—Ö –ø–æ–¥—Å–∏—Å—Ç–µ–º, –∫–æ—Ç–æ—Ä—ã–µ –∂–∏–≤—É—Ç –¥–æ–ª–≥–æ, –Ω–æ –Ω–µ –≤–µ—á–Ω–æ

---

### üì¶ –û—Å–Ω–æ–≤–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:

1. **–ë—ã—Å—Ç—Ä–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ** –ø–∞–º—è—Ç–∏
2. **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è**
3. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ 8 –∏–ª–∏ 16 –±–∞–π—Ç)
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è, –≤—ã—Ö–æ–¥–æ–≤ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã

---

### üß∞ –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

–°—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–¥—Ö–æ–¥–æ–≤:

* **Simple Bump Allocator**: —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–æ—Å—Ç–æ —Å–¥–≤–∏–≥–∞–µ—Ç—Å—è –≤–ø–µ—Ä—ë–¥ ‚Üí üê¢ –ø—Ä–æ—Å—Ç–æ–π, –Ω–æ –±–µ–∑ `free()`
* **Free-list Allocator**: —Ö—Ä–∞–Ω–∏—Ç —Å–ø–∏—Å–æ–∫ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –±–ª–æ–∫–æ–≤ ‚Üí üß† —É–¥–æ–±–Ω–æ, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
* **Buddy Allocator**: –¥–µ–ª–∏—Ç –ø–∞–º—è—Ç—å –ø–æ–ø–æ–ª–∞–º ‚Üí üìè –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
* **Slab Allocator** (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ Linux): –æ–±—ä–µ–∫—Ç–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω, –ø–æ–¥ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã —Ä–µ–∞–ª–∏–∑—É–µ–º **free-list allocator** ‚Äî —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –æ–±—É—á–µ–Ω–∏—è.

---

### üß© –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

* –ö—É—á–∞ ‚Äî —ç—Ç–æ –æ–±–ª–∞—Å—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏, –≤—ã–¥–µ–ª–µ–Ω–Ω–∞—è —è–¥—Ä—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1 –ú–ë).
* –í –Ω–µ–π —Ö—Ä–∞–Ω—è—Ç—Å—è –±–ª–æ–∫–∏ —Å –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π:

  * –†–∞–∑–º–µ—Ä
  * –§–ª–∞–≥ "—Å–≤–æ–±–æ–¥–µ–Ω/–∑–∞–Ω—è—Ç"
* –ü—Ä–∏ `malloc()` –∏—â–µ–º –ø–µ—Ä–≤—ã–π –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Å–≤–æ–±–æ–¥–Ω—ã–π –±–ª–æ–∫, –≤—ã–¥–µ–ª—è–µ–º, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –¥–µ–ª–∏–º.
* –ü—Ä–∏ `free()` –æ–±—ä–µ–¥–∏–Ω—è–µ–º —Å–æ—Å–µ–¥–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω—ã–µ –±–ª–æ–∫–∏ (coalescing).

---

### üìò –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–ª–æ–∫–∞:

```c
typedef struct block_header {
    size_t size;
    bool is_free;
    struct block_header* next;
} block_header_t;
```

üß† –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ `block_header` –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –ø–µ—Ä–µ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏.

---

### üì¶ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: –ö—É—á–∞ —è–¥—Ä–∞

```c
#include <stdint.h>
#include <stdbool.h>
#include <stddef.h>
#include <string.h>

#define KHEAP_START 0xC0000000
#define KHEAP_SIZE  0x00100000  // 1 MB

static uint8_t* heap = (uint8_t*)KHEAP_START;
static block_header_t* free_list = NULL;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫—É—á–∏
void kheap_init() {
    free_list = (block_header_t*)heap;
    free_list->size = KHEAP_SIZE - sizeof(block_header_t);
    free_list->is_free = true;
    free_list->next = NULL;
}

// –í—ã–¥–µ–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞
void* kmalloc(size_t size) {
    block_header_t* current = free_list;
    while (current) {
        if (current->is_free && current->size >= size) {
            if (current->size > size + sizeof(block_header_t)) {
                // –î–µ–ª–∏–º –±–ª–æ–∫
                block_header_t* new_block = (block_header_t*)((uint8_t*)current + sizeof(block_header_t) + size);
                new_block->size = current->size - size - sizeof(block_header_t);
                new_block->is_free = true;
                new_block->next = current->next;

                current->next = new_block;
                current->size = size;
            }
            current->is_free = false;
            return (void*)(current + 1);
        }
        current = current->next;
    }
    return NULL; // –ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –±–ª–æ–∫–∞
}

// –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –±–ª–æ–∫–∞
void kfree(void* ptr) {
    if (!ptr) return;

    block_header_t* block = ((block_header_t*)ptr) - 1;
    block->is_free = true;

    // –°–ª–∏—è–Ω–∏–µ —Å —Å–æ—Å–µ–¥–Ω–∏–º–∏ —Å–≤–æ–±–æ–¥–Ω—ã–º–∏
    block_header_t* current = free_list;
    while (current) {
        if (current->is_free && current->next && current->next->is_free) {
            current->size += sizeof(block_header_t) + current->next->size;
            current->next = current->next->next;
        } else {
            current = current->next;
        }
    }
}
```

---

### üß™ –¢–µ—Å—Ç

```c
void test_kheap() {
    void* a = kmalloc(128);
    void* b = kmalloc(64);
    kfree(a);
    void* c = kmalloc(120); // –ú–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 'a'
}
```

---

### üîê –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –Ω–∞ 8/16 –±–∞–π—Ç
* –°–ª–∏—è–Ω–∏–µ –Ω–µ —Ç–æ–ª—å–∫–æ –≤–ø–µ—Ä—ë–¥, –Ω–æ –∏ –Ω–∞–∑–∞–¥
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ bitmap + slab —Å–∏—Å—Ç–µ–º
* –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã 1 –ú–ë (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ)

---

### üìö –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

* [OSDev Wiki: Kernel Heap](https://wiki.osdev.org/Heap)
* "Operating Systems: Three Easy Pieces" ‚Äî –≥–ª–∞–≤–∞ "Memory Allocation"
* "Modern Operating Systems" ‚Äî Tanenbaum
* [Kernel Slab Allocator Explained (Linux)](https://www.kernel.org/doc/Documentation/vm/slabinfo.txt)

---

### ‚úÖ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∫–∞

1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `kheap_init()`, `kmalloc()`, `kfree()`
2. –ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ—Å—Ç—ã–µ —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –Ω–∞ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
3. –î–æ–±–∞–≤–∏—Ç—å –∂—É—Ä–Ω–∞–ª –≤ –∫–æ–Ω—Å–æ–ª—å: `heap: allocated 128 bytes at 0x...`

```c
void* p1 = kmalloc(128);
klog("allocated: %p", p1);
kfree(p1);
```

---

üî¢ **–°–ª–æ–∂–Ω–æ—Å—Ç—å**: 7/10
üïí **–í—Ä–µ–º—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ**: 6‚Äì8 —á–∞—Å–æ–≤
üéì **–ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è**:

* –õ–µ–∫—Ü–∏—è + whiteboard-—Å—Ö–µ–º–∞ –∫—É—á–∏
* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã —Å –±–ª–æ–∫–∞–º–∏
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ QEMU
* –û–±—Å—É–∂–¥–µ–Ω–∏–µ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏ –∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏

---

üëâ –ì–æ—Ç–æ–≤—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ **–≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–∞–º**? –ù–∞–ø–∏—à–∏ **–¥–∞–¥–∞–¥–∞**, –∏ –¥–≤–∏–≥–∞–µ–º—Å—è! üß†üì¶üßæ
