–û—Ç–ª–∏—á–Ω–æ! üî• –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–¥–Ω–æ–π –∏–∑ —Å–∞–º—ã—Ö —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö —Ç–µ–º –¥–ª—è –ª—é–±–æ–π 64-–±–∏—Ç–Ω–æ–π –û–° ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏ –∏ —Ç–∞–±–ª–∏—Ü–∞–º —Å—Ç—Ä–∞–Ω–∏—Ü.

---

# üîπ –£—Ä–æ–∫ 6. –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å –∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü –≤ x86-64 üß†üìö

---

## üß© –¢–µ–º–∞ —É—Ä–æ–∫–∞:

–°–µ–≥–æ–¥–Ω—è —Ç—ã —É–∑–Ω–∞–µ—à—å, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å –≤ 64-–±–∏—Ç–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, –ø–æ—á–µ–º—É –æ–Ω–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞, –∏ –∫–∞–∫ —Å–æ–∑–¥–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Å—Ç—Ä–∞–Ω–∏—Ü (Page Table) –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ Long Mode. –ú—ã —Ä–∞–∑–±–µ—Ä–µ–º —É—Ä–æ–≤–Ω–∏ –∞–¥—Ä–µ—Å–∞—Ü–∏–∏, —Å–æ–∑–¥–∞–¥–∏–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —è–¥—Ä–∞ –∏ –Ω–∞—É—á–∏–º—Å—è –æ—Å–Ω–æ–≤–∞–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç—å—é, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞—Ç—å –≤—Å—é —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –û–°.

---

## üß† –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (‚âà2500‚Äì3000 —Å–ª–æ–≤)

### –ó–∞—á–µ–º –Ω—É–∂–Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å?

* –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–∑–Ω—ã–º –ø—Ä–æ–≥—Ä–∞–º–º–∞–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –∞–¥—Ä–µ—Å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ**
* –ó–∞—â–∏—â–∞–µ—Ç –ø–∞–º—è—Ç—å –æ–¥–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ—Ç –¥—Ä—É–≥–æ–≥–æ
* –†–µ–∞–ª–∏–∑—É–µ—Ç **—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø** –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É **–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–º—è—Ç—å**
* –£–ø—Ä–æ—â–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é –∏ –∞–ª–ª–æ–∫–∞—Ü–∏—é

---

### –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å –≤ x86-64

* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **4-—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞**:

  1. PML4 (Page Map Level 4)
  2. PDPT (Page Directory Pointer Table)
  3. PD (Page Directory)
  4. PT (Page Table)
* –ö–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å ‚Äî –º–∞—Å—Å–∏–≤ –∏–∑ 512 –∑–∞–ø–∏—Å–µ–π –ø–æ 8 –±–∞–π—Ç = 4 –ö–ë
* –ö–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –±–∞–∑–æ–≤—ã–π –∞–¥—Ä–µ—Å —Ç–∞–±–ª–∏—Ü—ã —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è –∏–ª–∏ —Ñ–∏–∑–∏—á–µ—Å–∫—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É

---

### –ü—Ä–∏–º–µ—Ä –∞–¥—Ä–µ—Å–∞—Ü–∏–∏:

* –í 64-–±–∏—Ç–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ: 48 –±–∏—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –∞–¥—Ä–µ—Å–∞ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ ‚Äî –º–µ–Ω—å—à–µ)
* –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å: `0xFFFF800000000000` ‚Äî —è–¥—Ä–æ
* –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–µ–ª–∏—Ç—Å—è:

  * –ù–∏–∂–Ω–∏–µ 128 –¢–ë ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ
  * –í–µ—Ä—Ö–Ω–∏–µ 128 –¢–ë ‚Äî —è–¥—Ä–æ

---

### –¢–∏–ø—ã —Å—Ç—Ä–∞–Ω–∏—Ü

* –û–±—ã—á–Ω—ã–µ: 4 –ö–ë
* –ë–æ–ª—å—à–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: 2 –ú–ë
* –û–≥—Ä–æ–º–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: 1 –ì–ë (–¥–ª—è PDPT)

---

### –§–æ—Ä–º–∞—Ç –∑–∞–ø–∏—Å–∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü:

* Bit 0: Present (—Å—Ç—Ä. –¥–æ—Å—Ç—É–ø–Ω–∞)
* Bit 1: R/W
* Bit 2: U/S (User/Supervisor)
* Bit 7: PS (Page Size)
* Bit 63: NX (No Execute)

---

### –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å—Ç—Ä–∞–Ω–∏—Ü –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —è–¥—Ä–∞

* –û–¥–∏–Ω PML4, –æ–¥–∏–Ω PDPT, –æ–¥–∏–Ω PD, –æ–¥–∏–Ω PT
* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ 1:1 (identity mapping) –¥–ª—è –∞–¥—Ä–µ—Å–æ–≤ —è–¥—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1 –ú–ë ‚Üí 2 –ú–ë)
* –¢–∞–±–ª–∏—Ü—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã—Ä–æ–≤–Ω–µ–Ω—ã –ø–æ 4 –ö–ë

---

### –ü–µ—Ä–µ—Ö–æ–¥ –≤ Long Mode —Ç—Ä–µ–±—É–µ—Ç:

* –í–∫–ª—é—á–µ–Ω–∏—è PAE: `CR4.PAE = 1`
* –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü
* –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ CR3 (Page Table Base Address)
* –í–∫–ª—é—á—ë–Ω–Ω–æ–≥–æ —Ñ–ª–∞–≥–∞ LME –≤ EFER
* –£—Å—Ç–∞–Ω–æ–≤–∫–∏ CR0.PG = 1 (–≤–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–π –∞–¥—Ä–µ—Å–∞—Ü–∏–∏)

---

## üìò –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:

* Intel¬Æ Manual Vol. 3, –≥–ª–∞–≤–∞ ‚ÄúPaging in Long Mode‚Äù
* OSDev Wiki: Paging (x86-64), PML4, Identity Paging
* Low-Level Programming by Igor Zhirkov
* MIT xv6 (–≤ —á–∞—Å—Ç–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏)
* [https://wiki.osdev.org/Page\_Tables](https://wiki.osdev.org/Page_Tables)

---

## üí° –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ:

* –°–æ–∑–¥–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é PML4 + PDPT + PD
* –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å 2 –ú–ë —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç–∏ –≤ virtual address 0x0
* –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CR3 –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—á–Ω—É—é –∞–¥—Ä–µ—Å–∞—Ü–∏—é
* –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ kernel –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ long mode

---

## üíª –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C23: —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü –∏ –≤–∫–ª—é—á–µ–Ω–∏–µ PAE

```c
#include <stdint.h>
#include <stddef.h>

#define PAGE_PRESENT 0x1
#define PAGE_RW      0x2
#define PAGE_SIZE_2M 0x80

// –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ–¥ 4 –ö–ë
uint64_t __attribute__((aligned(0x1000))) pml4[512];
uint64_t __attribute__((aligned(0x1000))) pdpt[512];
uint64_t __attribute__((aligned(0x1000))) pd[512];

void setup_paging() {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PD
    for (int i = 0; i < 512; i++) {
        pd[i] = (i * 0x200000) | PAGE_PRESENT | PAGE_RW | PAGE_SIZE_2M;
    }

    // PDPT —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ PD
    pdpt[0] = ((uint64_t)pd) | PAGE_PRESENT | PAGE_RW;

    // PML4 —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ PDPT
    pml4[0] = ((uint64_t)pdpt) | PAGE_PRESENT | PAGE_RW;

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã
    asm volatile("mov %0, %%cr3" : : "r"(pml4));
}
```

---

## üß† –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 9/10

---

## ‚è± –í—Ä–µ–º—è –Ω–∞ –∏–∑—É—á–µ–Ω–∏–µ: 8‚Äì10 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è: 5 —á
* –ü—Ä–∞–∫—Ç–∏–∫–∞: 4‚Äì5 —á

---

## üßë‚Äçüè´ –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* –õ–µ–∫—Ü–∏—è —Å –≤–∏–∑—É–∞–ª—å–Ω—ã–º–∏ —Å—Ö–µ–º–∞–º–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏
* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø–æ—à–∞–≥–æ–≤–æ–≥–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è PML4 ‚Üí PT
* –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞: –Ω–∞–ø–∏—Å–∞—Ç—å —Å–≤–æ–π –∫–æ–¥ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ QEMU
* –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ: —Å–¥–µ–ª–∞—Ç—å 2 –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: 0x0 ‚Üí 0x0 –∏ 0xFFFFFFFF80000000 ‚Üí 0x0

---

üéØ –¢—ã –º–æ–ª–æ–¥–µ—Ü! –í —Å–ª–µ–¥—É—é—â–µ–º —É—Ä–æ–∫–µ –º—ã –Ω–∞—É—á–∏–º —è–¥—Ä–æ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ 64-–±–∏—Ç–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–µ–∫, –Ω–∞—á–∞—Ç—å –≤—ã–ø–æ–ª–Ω—è—Ç—å `main()` ‚Äî —É–∂–µ **–Ω–∞—Å—Ç–æ—è—â–∏–π kernel**.
–ï—Å–ª–∏ –≥–æ—Ç–æ–≤ –∫ **—É—Ä–æ–∫—É 7** ‚Äî –Ω–∞–ø–∏—à–∏ **–¥–∞**!
