–û—Ç–ª–∏—á–Ω–æ! üöÄ –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º! –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ ‚Äî —Å–≤—è–∑–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –∏ —Ñ–∏–∑–∏—á–µ—Å–∫—É—é –ø–∞–º—è—Ç—å: —Ç–µ–ø–µ—Ä—å —Ç–≤–æ—è –û–° –Ω–∞—á–Ω–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–∞—Å—Ç–æ—è—â–µ–π **—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–π –∞–¥—Ä–µ—Å–∞—Ü–∏–µ–π**!

---

# üîπ –£—Ä–æ–∫ 24. –°—Ç—Ä–∞–Ω–∏—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —É—Ä–æ–≤–Ω—è —è–¥—Ä–∞ (Page Tables) –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ üß†üì¶

---

## üß© –¢–µ–º–∞ —É—Ä–æ–∫–∞:

–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã –≤–Ω–µ–¥—Ä–∏–º —Ä–∞–±–æ—Ç—É —Å **—Ç–∞–±–ª–∏—Ü–∞–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü (Page Tables)**, –Ω–∞—É—á–∏–º—Å—è —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ —Ñ—Ä–µ–π–º—ã –≤ –∞–¥—Ä–µ—Å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ —è–¥—Ä–∞. –ò–º–µ–Ω–Ω–æ –±–ª–∞–≥–æ–¥–∞—Ä—è —ç—Ç–æ–º—É –º–µ—Ö–∞–Ω–∏–∑–º—É –û–° —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∑–∞—â–∏—Ç—É –ø–∞–º—è—Ç–∏, –∏–∑–æ–ª—è—Ü–∏—é –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏, —á–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ —Ñ–∏–∑–∏—á–µ—Å–∫–∏. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä MMU! üîÑ

---

## üß† –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (‚âà2500‚Äì3000 —Å–ª–æ–≤)

### –ß—Ç–æ —Ç–∞–∫–æ–µ —Å—Ç—Ä–∞–Ω–∏—á–Ω–∞—è –∞–¥—Ä–µ—Å–∞—Ü–∏—è?

–í x86-64:

* –ö–∞–∂–¥–æ–º—É –ø—Ä–æ—Ü–µ—Å—Å—É –¥–∞—ë—Ç—Å—è **–≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –∞–¥—Ä–µ—Å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ** (–¥–æ 256 –¢–ë)
* –ö–∞–∂–¥–æ–º—É –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º—É –∞–¥—Ä–µ—Å—É —Å—Ç–∞–≤–∏—Ç—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ **—Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å**
* –£–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Ü–µ–ø–æ—á–∫—É —Ç–∞–±–ª–∏—Ü: **PML4 ‚Üí PDPT ‚Üí PD ‚Üí PT**

---

### –£—Ä–æ–≤–Ω–∏ —Ç–∞–±–ª–∏—Ü —Å—Ç—Ä–∞–Ω–∏—Ü –≤ x86-64 (4-level paging):

1. **PML4** ‚Äî Page Map Level 4 (512 –∑–∞–ø–∏—Å–µ–π)
2. **PDPT** ‚Äî Page Directory Pointer Table
3. **PD** ‚Äî Page Directory
4. **PT** ‚Äî Page Table

–ö–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É –∏–ª–∏ –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É.

---

### –ö–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å —Å–æ–¥–µ—Ä–∂–∏—Ç:

* **Physical address** —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è –∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
* **–§–ª–∞–≥–∏**:

  * Present (P)
  * Read/Write (R/W)
  * User/Supervisor (U/S)
  * No Execute (NX) ‚Äî —á–µ—Ä–µ–∑ EFER MSR

---

### –ê–ª–≥–æ—Ä–∏—Ç–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã:

1. –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—ã: PT, PD, PDPT, PML4
2. –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–∞–ø–∏—Å–∏ —Ñ—Ä–µ–π–º–∞–º–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç–∏
3. –ó–∞–≥—Ä—É–∂–∞–µ–º –≤ CR3 —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ PML4
4. –í–∫–ª—é—á–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—á–Ω—É—é –∞–¥—Ä–µ—Å–∞—Ü–∏—é —á–µ—Ä–µ–∑ CR0 –∏ CR4

---

### –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã:

* **ASLR (Address Space Layout Randomization)**
* **KASLR (Kernel ASLR)**
* **1–ì–ë –∏ 2–ú–ë —Å—Ç—Ä–∞–Ω–∏—Ü—ã (Huge Pages)**
* **PCID (Process Context Identifiers)** –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Å–º–µ–Ω—ã –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞

---

### –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å —Ñ–∏–∑–∏—á–µ—Å–∫–∏–º –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–æ–º

* –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞ –Ω—É–∂–µ–Ω **—Å–≤–æ–±–æ–¥–Ω—ã–π —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π —Ñ—Ä–µ–π–º**
* –ú–µ–Ω–µ–¥–∂–µ—Ä —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ñ—Ä–µ–π–º—ã –¥–ª—è —Ç–∞–±–ª–∏—Ü –∏ —Å—Ç—Ä–∞–Ω–∏—Ü

---

## üìò –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:

* Intel¬Æ SDM Vol. 3A: Chapters 4 & 5
* AMD64 Programmer‚Äôs Manual Vol. 2: Paging and Address Translation
* ‚ÄúOperating Systems: Three Easy Pieces‚Äù ‚Äî Chapter on Virtual Memory
* –ò—Å—Ö–æ–¥–Ω–∏–∫–∏ Linux: `mm/init_64.c`, `arch/x86/mm/pgtable.c`

---

## üí° –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ:

üî® –ó–∞–¥–∞—á–∏:

1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–∞–∑–æ–≤—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Ç–∞–±–ª–∏—Ü —Å—Ç—Ä–∞–Ω–∏—Ü
2. –í—ã–¥–µ–ª–∏—Ç—å –∏ —Å–≤—è–∑–∞—Ç—å –≤—Å–µ —á–µ—Ç—ã—Ä–µ —É—Ä–æ–≤–Ω—è (PML4 ‚Üí PT)
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞ `0xFFFF800000000000` –≤ –ø–µ—Ä–≤—ã–π —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π —Ñ—Ä–µ–π–º
4. –í–∫–ª—é—á–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—á–Ω—É—é –∞–¥—Ä–µ—Å–∞—Ü–∏—é (–æ–±–Ω–æ–≤–∏—Ç—å CR3 –∏ CR0)

---

## üíª –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C23 (—É–ø—Ä–æ—â—ë–Ω–Ω–æ):

```c
#include <stdint.h>
#include <stdbool.h>

#define PAGE_PRESENT 0x1
#define PAGE_RW      0x2
#define PAGE_USER    0x4

// –£—Ä–æ–≤–µ–Ω—å —Ç–∞–±–ª–∏—Ü—ã: PML4, PDPT, PD, PT
typedef uint64_t page_table_entry_t;
typedef page_table_entry_t page_table_t[512];

page_table_t* alloc_page_table(); // –§—É–Ω–∫—Ü–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ñ—Ä–µ–π–º–∞ –ø–æ–¥ —Ç–∞–±–ª–∏—Ü—É

void map_page(page_table_t* pml4, uint64_t virt_addr, uint64_t phys_addr, uint64_t flags) {
    uint16_t pml4_idx = (virt_addr >> 39) & 0x1FF;
    uint16_t pdpt_idx = (virt_addr >> 30) & 0x1FF;
    uint16_t pd_idx   = (virt_addr >> 21) & 0x1FF;
    uint16_t pt_idx   = (virt_addr >> 12) & 0x1FF;

    page_table_t* pdpt = alloc_page_table();
    page_table_t* pd   = alloc_page_table();
    page_table_t* pt   = alloc_page_table();

    pml4[pml4_idx] = ((uint64_t)pdpt) | flags;
    pdpt[pdpt_idx] = ((uint64_t)pd) | flags;
    pd[pd_idx]     = ((uint64_t)pt) | flags;
    pt[pt_idx]     = phys_addr | flags;
}
```

‚ö†Ô∏è –≠—Ç–æ —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –ø—Ä–∏–º–µ—Ä. –í —Ä–µ–∞–ª—å–Ω–æ–π –û–° —Ç—ã –±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Ñ—Ä–µ–π–º-–∞–ª–ª–æ–∫–∞—Ç–æ—Ä –∏ —É—á–∏—Ç—ã–≤–∞–ª –∫—ç—à-—Ñ–ª–∞–≥–∏, –æ–≥—Ä–æ–º–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, NX-–±–∏—Ç –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ.

---

## üß† –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 9/10

---

## ‚è± –í—Ä–µ–º—è –Ω–∞ –∏–∑—É—á–µ–Ω–∏–µ: 10 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è: 6 —á
* –ü—Ä–∞–∫—Ç–∏–∫–∞: 4 —á

---

## üßë‚Äçüè´ –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* –õ–µ–∫—Ü–∏—è —Å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —É—Ä–æ–≤–Ω–µ–π –ø–∞–º—è—Ç–∏ (PML4 ‚Üí PT)
* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ QEMU —á–µ—Ä–µ–∑ `info mem`
* –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è: –Ω–∞–ø–∏—Å–∞—Ç—å `map_page()` –∏ –≤—ã–¥–µ–ª–∏—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å
* –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ: –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –ø–µ—Ä–≤—ã–µ 4 –ú–ë –ø–∞–º—è—Ç–∏ —è–¥—Ä–∞ —Å –ø—Ä–∞–≤–∞–º–∏ R/W

---

‚ú® –•–æ—á–µ—à—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å? –ù–∞–ø–∏—à–∏ **–¥–∞–¥–∞** ‚Äî –∏ –º—ã –ø–µ—Ä–µ–π–¥—ë–º –∫ **—É—Ä–æ–∫—É 25**, –≥–¥–µ –≤–Ω–µ–¥—Ä–∏–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –∑–∞—â–∏—â—ë–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ä–µ–∂–∏–º–∞! üßë‚Äçüíªüõ°Ô∏è
