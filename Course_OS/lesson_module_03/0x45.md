–û—Ç–ª–∏—á–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º! üöÄ

---

## üîπ –£—Ä–æ–∫ 45. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: —Å–æ–∑–¥–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–Ω—ã—Ö –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤ –∏ –±–∞–∑–æ–≤—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü üß±üîê

---

### üß† –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?

–í –ø—Ä–µ–¥—ã–¥—É—â–µ–º —É—Ä–æ–∫–µ –º—ã –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ –±–∞–∑–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏, —Ä–µ–∞–ª–∏–∑–æ–≤–∞–≤ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü –∏ –≤–∫–ª—é—á–∏–≤ –∏—Ö –≤ —Ä–∞–±–æ—Ç—É. –¢–µ–ø–µ—Ä—å –º—ã —Å–¥–µ–ª–∞–µ–º –≤–∞–∂–Ω—ã–π —à–∞–≥ –≤–ø–µ—Ä—ë–¥: —Å–æ–∑–¥–∞–¥–∏–º **–æ—Ç–¥–µ–ª—å–Ω—ã–µ –∞–¥—Ä–µ—Å–Ω—ã–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞** –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –Ω–∞—É—á–∏–º—Å—è –≤—ã–¥–µ–ª—è—Ç—å **–±–∞–∑–æ–≤—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã** –¥–ª—è –∏—Ö —Ä–∞–±–æ—Ç—ã.

---

### üß© –ß—Ç–æ –º—ã –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å?

1. **–°–æ–∑–¥–∞–¥–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞**: –∫–∞–∂–¥–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ (–∏–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å) –±—É–¥–µ—Ç –∏–º–µ—Ç—å —Å–≤–æ—ë —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∞–¥—Ä–µ—Å–æ–≤, –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ—Ç –¥—Ä—É–≥–∏—Ö.
2. **–†–µ–∞–ª–∏–∑—É–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü**: –Ω–∞—É—á–∏–º—Å—è –≤—ã–¥–µ–ª—è—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–∞–º—è—Ç–∏ –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—è –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –ø–∞–º—è—Ç–∏.
3. **–ù–∞—Å—Ç—Ä–æ–∏–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**: –±—É–¥–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –∞–¥—Ä–µ—Å–Ω—ã–º–∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞–º–∏ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.

---

### üìò –¢–µ–æ—Ä–∏—è: –∏–∑–æ–ª—è—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é

–í –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –∫–∞–∂–¥—ã–π –ø—Ä–æ—Ü–µ—Å—Å –∏–º–µ–ª —Å–≤–æ—ë —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –∞–¥—Ä–µ—Å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

* **–ò–∑–æ–ª—è—Ü–∏—é –ø—Ä–æ—Ü–µ—Å—Å–æ–≤**: –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –º–æ–∂–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –ø–∞–º—è—Ç–∏ –¥—Ä—É–≥–æ–≥–æ.
* **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º.
* **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏**: —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –º–µ–∂–¥—É –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏.

---

### üõ† –ü—Ä–∞–∫—Ç–∏–∫–∞: —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

1. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞**

```c
typedef struct {
    uint64_t* pml4; // –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ PML4 —Ç–∞–±–ª–∏—Ü—É
    // –î—Ä—É–≥–∏–µ –ø–æ–ª—è, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
} address_space_t;
```

2. **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞**

```c
address_space_t* create_address_space() {
    address_space_t* new_space = kmalloc(sizeof(address_space_t));
    new_space->pml4 = alloc_page(); // –í—ã–¥–µ–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è PML4
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PML4 –∏ –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä
    return new_space;
}
```

3. **–í—ã–¥–µ–ª–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã**

```c
void* alloc_base_page() {
    void* page = alloc_page();
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
    return page;
}
```

4. **–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**

```c
void switch_address_space(address_space_t* new_space) {
    asm volatile ("mov %0, %%cr3" : : "r"(new_space->pml4) : "memory");
}
```

---

### üß™ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```c
void kernel_main() {
    address_space_t* user_space = create_address_space();
    void* page = alloc_base_page();

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞–ø–ø–∏–Ω–≥–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞ –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π

    switch_address_space(user_space);

    // –¢–µ–ø–µ—Ä—å –ø—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Å–≤–æ—ë–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–º –∞–¥—Ä–µ—Å–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ
}
```

---

### üîç –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

* [Intel¬Æ 64 and IA-32 Architectures Software Developer‚Äôs Manual, Volume 3: System Programming Guide](https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html)
* [OSDev Wiki: Setting Up Paging](https://wiki.osdev.org/Setting_Up_Paging)
* [OSDev Wiki: Page Tables](https://wiki.osdev.org/Page_Tables)

---

### ‚úÖ –ó–∞–¥–∞–Ω–∏–µ

1. –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –µ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è.
2. –ù–∞–ø–∏—à–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–µ–∂–¥—É –¥–≤—É–º—è –∞–¥—Ä–µ—Å–Ω—ã–º–∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞–º–∏.

---

–ì–æ—Ç–æ–≤—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É? –í **–£—Ä–æ–∫–µ 46** –º—ã –¥–æ–±–∞–≤–∏–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç–∏ –∏ –Ω–∞—É—á–∏–º—Å—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏. –°–∫–∞–∂–∏—Ç–µ **–¥–∞–¥–∞**, –µ—Å–ª–∏ –≥–æ—Ç–æ–≤—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å!
