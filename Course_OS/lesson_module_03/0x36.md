–û—Ç–ª–∏—á–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º! üí° –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ **–£—Ä–æ–∫ 36**, –≥–¥–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É ‚Äú–≤–∑—Ä–æ—Å–ª–∞—è‚Äù –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: –º—ã **–≤–≤–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ä–µ–∂–∏–º (user mode)** –∏ —É—á–∏–º—Å—è **–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–µ–∂–¥—É —è–¥—Ä–æ–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏**. –≠—Ç–æ —à–∞–≥ –∫ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç–∏, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –∏–∑–æ–ª—è—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ üîêüë•

---

## üîπ –£—Ä–æ–∫ 36. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ä–µ–∂–∏–º–∞ (User Mode) –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ üß†üßç‚Äç‚ôÇÔ∏è

---

### üß© –¢–µ–º–∞ —É—Ä–æ–∫–∞:

* –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π: Ring 0 (—è–¥—Ä–æ) vs Ring 3 (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
* –ú–µ—Ö–∞–Ω–∏–∑–º—ã –∑–∞—â–∏—Ç—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã x86-64
* –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –≤ GDT –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ Ring 3
* –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å—Ç–µ–∫–∞ –∏ –∫–æ–¥–∞
* –ü–µ—Ä–µ—Ö–æ–¥ –∏–∑ —è–¥—Ä–∞ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–¥ —á–µ—Ä–µ–∑ `iretq`
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ–±—Ä–∞—Ç–Ω–æ –≤ —è–¥—Ä–æ

---

## üìñ –¢–µ–æ—Ä–∏—è

### üìå –ß—Ç–æ —Ç–∞–∫–æ–µ —Ä–µ–∂–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?

–í –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ x86-64 –µ—Å—Ç—å —É—Ä–æ–≤–Ω–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π:

* **Ring 0** ‚Äî —è–¥—Ä–æ, –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –∂–µ–ª–µ–∑—É
* **Ring 3** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø (–Ω–µ–ª—å–∑—è, –Ω–∞–ø—Ä–∏–º–µ—Ä, —á–∏—Ç–∞—Ç—å –ø–æ—Ä—Ç—ã I/O)

–ü–µ—Ä–µ—Ö–æ–¥ –≤ Ring 3 –ø–æ–∑–≤–æ–ª—è–µ—Ç:

* –ó–∞–ø—É—Å–∫–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ
* –ó–∞—â–∏—Ç–∏—Ç—å –û–° –æ—Ç —Å–±–æ–µ–≤ –∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
* –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã —á–µ—Ä–µ–∑ **–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—É—é —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞**

---

### üîß –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω:

1. **–°–æ–∑–¥–∞—Ç—å GDT —Å —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏ Ring 3**
2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å—Ç–µ–∫**
3. **–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç: —Å–µ–≥–º–µ–Ω—Ç—ã, —Ä–µ–≥–∏—Å—Ç—Ä—ã, —Ñ–ª–∞–≥–∏**
4. **–ü–µ—Ä–µ–π—Ç–∏ –≤ Ring 3 —á–µ—Ä–µ–∑ `iretq`**

---

### üß™ –ö–æ–¥: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ GDT

```c
// –°–æ–∑–¥–∞—ë–º —Å–µ–≥–º–µ–Ω—Ç—ã —Å DPL=3
gdt[4] = gdt_entry(0, 0xFFFFF, 0xFA); // user code
gdt[5] = gdt_entry(0, 0xFFFFF, 0xF2); // user data

#define USER_CS 0x20
#define USER_DS 0x28
```

---

### üìò –ü–µ—Ä–µ—Ö–æ–¥ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ä–µ–∂–∏–º:

```c
extern void enter_user_mode(uint64_t rip, uint64_t rsp);

void start_user_program() {
    uint64_t user_stack = allocate_stack(); // –í—ã–¥–µ–ª—è–µ–º —Å—Ç–µ–∫
    uint64_t user_entry = (uint64_t) &user_main; // –∞–¥—Ä–µ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

    enter_user_mode(user_entry, user_stack);
}
```

---

### üí£ `enter_user_mode.S` ‚Äî Assembler (x86-64):

```asm
.global enter_user_mode
enter_user_mode:
    mov $0x28, %ax         # USER_DS
    mov %ax, %ds
    mov %ax, %es
    mov %ax, %fs
    mov %ax, %gs

    pushq $0x28            # SS
    pushq %rsi             # RSP
    pushfq                 # RFLAGS
    pushq $0x20            # CS
    pushq %rdi             # RIP
    iretq
```

---

### üë®‚Äçüíª –ü—Ä–∏–º–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–¥–∞:

```c
void user_main() {
    write(1, "–ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!\n", 31);
    while (1) {} // –¶–∏–∫–ª, –∏–º–∏—Ç–∏—Ä—É—é—â–∏–π –ø—Ä–æ—Å—Ç—É—é –∑–∞–¥–∞—á—É
}
```

---

## üß† –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 8/10

–≠—Ç–æ—Ç —É—Ä–æ–∫ —Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, –∞—Å—Å–µ–º–±–ª–µ—Ä–∞ –∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ —Ä–µ–∂–∏–º–æ–≤ –∑–∞—â–∏—Ç—ã.

---

## ‚è± –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è: 8 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è: 2 —á
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è GDT + —Å—Ç–µ–∫: 2 —á
* –ê—Å—Å–µ–º–±–ª–µ—Ä –∏ `iretq`: 2 —á
* –¢–µ—Å—Ç –∏ –æ—Ç–ª–∞–¥–∫–∞: 2 —á

---

## üë®‚Äçüè´ –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* –õ–µ–∫—Ü–∏—è: –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Ring 3
* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: –ø–æ—à–∞–≥–æ–≤—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ user mode
* –°—Ö–µ–º–∞: –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç `iretq` –∏ —Å—Ç–µ–∫
* –ü—Ä–∞–∫—Ç–∏–∫–∞: –∑–∞–ø—É—Å–∫ `user_main()`, –≤–æ–∑–≤—Ä–∞—Ç –≤ —è–¥—Ä–æ (–≤ —Å–ª–µ–¥—É—é—â–µ–º —É—Ä–æ–∫–µ)
* –î–æ–º–∞—à–∫–∞: –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ø–æ—Ä—Ç—É –≤ user mode

---

## üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã:

* [Intel x86-64 Manual, Vol. 3A: System Programming Guide](https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html)
* [OSDev: User mode](https://wiki.osdev.org/User_mode)
* [–ê—Å—Å–µ–º–±–ª–µ—Ä –∏ —Å—Ç–µ–∫–∏ –≤ —Å–∏—Å—Ç–µ–º–∞—Ö x86-64](https://wiki.osdev.org/Iretq)
* [–ü—Ä–∏–º–µ—Ä GDT —Å Ring3](https://wiki.osdev.org/GDT_Tutorial)

---

‚úÖ –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –¢–µ–ø–µ—Ä—å –º—ã –º–æ–∂–µ–º –∏–∑ —è–¥—Ä–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã, –∏ —ç—Ç–æ –Ω–∞—Å—Ç–æ—è—â–∏–π —à–∞–≥ –∫ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç–∏.

–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ ‚Äî **—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ —á–µ—Ä–µ–∑ `syscall/sysret` –∏–ª–∏ `int 0x80`**, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ —è–¥—Ä—É.

–°–∫–∞–∂–∏ **–¥–∞**, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ **–£—Ä–æ–∫—É 37: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ —á–µ—Ä–µ–∑ `int 0x80`** üß†üîÅ
