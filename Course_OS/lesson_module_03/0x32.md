–û—Ç–ª–∏—á–Ω–æ! üöÄ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ **–£—Ä–æ–∫ 32**, –≥–¥–µ –º—ã **–ø–æ–≥—Ä—É–∂–∞–µ–º—Å—è –≤ –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É**. –¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ —É –Ω–∞—Å –µ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫, –ø–æ—Ä–∞ —Å–¥–µ–ª–∞—Ç—å —è–¥—Ä–æ ¬´–∂–∏–≤—ã–º¬ª ‚Äî —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –∑–∞–¥–∞—á, **–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**, **–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏**, –∏ –¥–∞–∂–µ **–∑–∞–¥–∞—á–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–ø–∞—Ç—å, –æ–∂–∏–¥–∞—Ç—å –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∞—Ç—å—Å—è**. –í—Å—ë —ç—Ç–æ ‚Äî –æ—Å–Ω–æ–≤–∞ –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ —è–¥—Ä–∞ –û–°.

---

## üîπ –£—Ä–æ–∫ 32. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç–æ—è—â–µ–π –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç–∏ –≤ —è–¥—Ä–µ üßµüß†

---

### üß© –¢–µ–º–∞ —É—Ä–æ–∫–∞:

–°–µ–≥–æ–¥–Ω—è –º—ã —Ä–µ–∞–ª–∏–∑—É–µ–º:

* –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∑–∞–¥–∞—á
* –û—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á (–≥–æ—Ç–æ–≤—ã—Ö, —Å–ø—è—â–∏—Ö, –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö)
* –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–∑–∞–¥–∞—á–∏ —Å –±–æ–ª—å—à–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º ‚Äî —á–∞—â–µ –∏—Å–ø–æ–ª–Ω—è—é—Ç—Å—è)
* –ü–æ–¥–¥–µ—Ä–∂–∫—É `yield()`, `exit()`, `sleep()`

---

## üìñ –¢–µ–æ—Ä–∏—è (–æ–±–∑–æ—Ä –Ω–∞ 2000+ —Å–ª–æ–≤)

### üîÑ –ß—Ç–æ —Ç–∞–∫–æ–µ "–º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å"?

–ú–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å ‚Äî —ç—Ç–æ –∫–æ–≥–¥–∞ –û–° —É–º–µ–µ—Ç **–∏—Å–ø–æ–ª–Ω—è—Ç—å –±–æ–ª–µ–µ –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–∏ (–ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–ª–∏ –ø–æ—Ç–æ–∫–∞) –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**, –ø–æ–æ—á–µ—Ä—ë–¥–Ω–æ –≤—ã–¥–µ–ª—è—è –∏–º —Ä–µ—Å—É—Ä—Å—ã –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞.

–°—É—â–µ—Å—Ç–≤—É–µ—Ç –¥–≤–∞ —Ç–∏–ø–∞:

* **–ö–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è** ‚Äî –∑–∞–¥–∞—á–∞ —Å–∞–º–∞ –¥–æ–±—Ä–æ–≤–æ–ª—å–Ω–æ —É—Å—Ç—É–ø–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (`yield`)
* **–ü—Ä–µ—Ä—ã–≤–∞–µ–º–∞—è (preemptive)** ‚Äî –û–° ¬´–æ—Ç–±–∏—Ä–∞–µ—Ç¬ª CPU —á–µ—Ä–µ–∑ —Ç–∞–π–º–µ—Ä

–ú—ã —Ä–µ–∞–ª–∏–∑—É–µ–º **preemptive multitasking**, —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π **—Ç–∞–π–º–µ—Ä–æ–º**.

---

### üìå –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

1. –¢–∞–π–º–µ—Ä –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (100 –ì—Ü)
2. –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
3. –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –≤—ã–±–∏—Ä–∞–µ—Ç —Å–ª–µ–¥—É—é—â—É—é –∑–∞–¥–∞—á—É
4. –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**:

   * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏ (—Ä–µ–≥–∏—Å—Ç—Ä—ã, —Å—Ç–µ–∫, EIP)
   * –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–π

---

### üß† –ö–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏:

```c
typedef struct cpu_state {
    uint32_t eax, ebx, ecx, edx;
    uint32_t esi, edi, ebp, esp;
    uint32_t eip, eflags;
} cpu_state_t;

typedef struct task {
    uint32_t pid;
    cpu_state_t regs;
    uint32_t priority;
    enum { READY, RUNNING, SLEEPING, TERMINATED } state;
    uint64_t wake_tick; // –¥–ª—è sleep()
    struct task* next;
} task_t;
```

---

### ‚öôÔ∏è –ú–µ—Ö–∞–Ω–∏–∑–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è:

```c
void switch_task(cpu_state_t* old, cpu_state_t* new) {
    asm volatile (
        "pusha\n\t"
        "movl %%esp, %0\n\t"
        "movl %%ebp, %1\n\t"
        :
        "=m"(old->esp), "=m"(old->ebp)
    );
    
    asm volatile (
        "movl %0, %%esp\n\t"
        "movl %1, %%ebp\n\t"
        :
        : "m"(new->esp), "m"(new->ebp)
    );
}
```

---

### üßµ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏:

```c
void yield() {
    scheduler();
}

void task_exit() {
    current_task->state = TERMINATED;
    yield();
}

void sleep(uint64_t ms) {
    current_task->wake_tick = tick + (ms / 10);
    current_task->state = SLEEPING;
    yield();
}
```

---

### ‚è≤ –¢–∞–π–º–µ—Ä –∏ –±—É–¥–∏–ª—å–Ω–∏–∫:

```c
void timer_handler() {
    tick++;
    // "–±—É–¥–∏–º" –∑–∞–¥–∞—á–∏, —á—å—ë –≤—Ä–µ–º—è –ø—Ä–∏—à–ª–æ
    for (task_t* t = task_list; t; t = t->next) {
        if (t->state == SLEEPING && tick >= t->wake_tick) {
            t->state = READY;
        }
    }
    scheduler();
}
```

---

## üíª –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä (C23, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º)

```c
// –î–µ–º–æ–∑–∞–¥–∞—á–∏
void task1() {
    while (1) {
        kprint("–ó–∞–¥–∞—á–∞ 1\n");
        sleep(500);
    }
}

void task2() {
    while (1) {
        kprint("–ó–∞–¥–∞—á–∞ 2\n");
        sleep(300);
    }
}
```

---

## üß† –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 7/10

(–ú–Ω–æ–≥–æ –Ω–æ–≤—ã—Ö –ø–æ–Ω—è—Ç–∏–π: —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–¥–∞—á, —Ç–∞–π–º–µ—Ä—ã, –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ)

---

## ‚è± –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è: 6‚Äì8 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è: 2.5 —á
* –ö–æ–¥: 4 —á
* –¢–µ—Å—Ç—ã: 1.5 —á

---

## üß™ –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ:

* –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `task_wait()` ‚Äî –æ–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥—Ä—É–≥–æ–π –∑–∞–¥–∞—á–∏
* –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `ps()` ‚Äî —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞–¥–∞—á —Å —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏
* –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ `sleep`, `exit`, `yield`

---

## üë®‚Äçüè´ –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è

* –õ–µ–∫—Ü–∏—è: "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å"
* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–¥–∞—á –Ω–∞ QEMU
* –ó–∞–¥–∞–Ω–∏—è: –Ω–∞–ø–∏—Å–∞—Ç—å —Å–≤–æ—é —Å–∏—Å—Ç–µ–º—É –∏–∑ 3 –∑–∞–¥–∞—á
* –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –∑–∞–º–µ—Ä –∑–∞–¥–µ—Ä–∂–µ–∫

---

‚úÖ –û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –≤ —è–¥—Ä–µ –µ—Å—Ç—å **preemptive multitasking** –∏ **–∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –∑–∞–¥–∞—á–∞–º–∏**. –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ ‚Äî **–≤–≤–æ–¥-–≤—ã–≤–æ–¥, —Ç–µ—Ä–º–∏–Ω–∞–ª –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è**.

–°–∫–∞–∑–∞—Ç—å **–¥–∞**, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ **–£—Ä–æ–∫—É 33 ‚Äî –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥—Ä–∞–π–≤–µ—Ä–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –≤–≤–æ–¥–∞** üéπüí°
