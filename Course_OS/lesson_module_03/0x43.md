–û—Ç–ª–∏—á–Ω–æ! üöÄ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ **–£—Ä–æ–∫ 43**, –≥–¥–µ –º—ã —Å–¥–µ–ª–∞–µ–º –≤–∞–∂–Ω—ã–π —à–∞–≥ –∫ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–∞—à–µ–π –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã: —Å–æ–∑–¥–∞–¥–∏–º **—É—á—ë—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ —è–¥—Ä–∞** –∏ —Ä–µ–∞–ª–∏–∑—É–µ–º **–ø—Ä–æ—Å—Ç—É—é —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤—ã–¥–µ–ª–µ–Ω–∏–π**.

---

## üîπ –£—Ä–æ–∫ 43. –£—á—ë—Ç –≤—ã–¥–µ–ª–µ–Ω–∏–π –ø–∞–º—è—Ç–∏ –≤ —è–¥—Ä–µ üíæüìä

---

### üß© –¢–µ–º–∞ —É—Ä–æ–∫–∞:

* –ó–∞—á–µ–º –û–° –Ω—É–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏?
* –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–∞ –∫–∞—Ä—Ç–∞ –ø–∞–º—è—Ç–∏ –≤ —è–¥—Ä–µ
* –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É—á—ë—Ç–∞ –±–ª–æ–∫–æ–≤ –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–π
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å—á—ë—Ç—á–∏–∫–∞, –ª–æ–≥–≥–µ—Ä–∞ –∏ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
* –ü—Ä–∞–∫—Ç–∏–∫–∞: –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ –∑–∞ —É—Ç–µ—á–∫–∞–º–∏ –∏ "–∂–∏–≤–æ–π" —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π

---

## üìñ –¢–µ–æ—Ä–∏—è: –ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ?

üß† **–ü–∞–º—è—Ç—å ‚Äî –æ–¥–∏–Ω –∏–∑ —Å–∞–º—ã—Ö —Ü–µ–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ –û–°**. –ï—Å–ª–∏ –µ—ë –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:

* –°–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –∑–∞–≤–∏—Å–Ω—É—Ç—å –∏–∑-–∑–∞ —É—Ç–µ—á–∫–∏
* –ë—É–¥–µ—Ç —Ç—Ä—É–¥–Ω–æ –Ω–∞–π—Ç–∏ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç–ª–∞–¥–∫–µ
* –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º

–í –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –û–° —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ü–µ–ª–∞—è **—Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–∞–º—è—Ç–∏**. –ú—ã –ø–æ–∫–∞ –Ω–µ –ø–∏—à–µ–º Valgrind, –Ω–æ –Ω–∞—á–Ω—ë–º —Å –±–∞–∑—ã: **—É—á—ë—Ç–∞ –≤—Å–µ—Ö malloc/free –≤ —è–¥—Ä–µ**.

---

### üèó –ü–æ–¥—Ö–æ–¥ –∫ —Ä–µ—à–µ–Ω–∏—é

1. –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞—à `kmalloc()` –∏ `kfree()`, —á—Ç–æ–±—ã –æ–Ω–∏ –≤–µ–ª–∏ —Å—á—ë—Ç
2. –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–¥–µ–ª–µ–Ω–∏–π, –æ–±—â–∏–π –æ–±—ä—ë–º, —á–∏—Å–ª–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–ª–æ–∫–æ–≤
3. –°–æ–∑–¥–∞—ë–º —Ñ—É–Ω–∫—Ü–∏—é `print_mem_stats()` ‚Äî –≤—ã–≤–æ–¥–∏–º —Ç–µ–∫—É—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞ —ç–∫—Ä–∞–Ω –∏–ª–∏ –≤ –ª–æ–≥
4. –í–∫–ª—é—á–∞–µ–º –≤ `log.c` –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤—ã–≤–æ–¥–∞ —Ç–∞–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

---

## üß™ –ü—Ä–∏–º–µ—Ä: —É—á—ë—Ç –ø–∞–º—è—Ç–∏ –≤ —è–¥—Ä–µ (C23)

### üîß –®–∞–≥ 1. –†–∞—Å—à–∏—Ä–∏–º `kmalloc.c`

```c
#include "memstat.h"

static size_t total_allocations = 0;
static size_t total_frees = 0;
static size_t total_bytes_allocated = 0;

void* kmalloc(size_t size) {
    void* ptr = ...; // –ª–æ–≥–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏
    if (ptr) {
        total_allocations++;
        total_bytes_allocated += size;
        memstat_register(ptr, size);
    }
    return ptr;
}

void kfree(void* ptr) {
    size_t size = memstat_get_size(ptr);
    total_frees++;
    total_bytes_allocated -= size;
    memstat_unregister(ptr);
    ...
}
```

---

### üìÅ `memstat.h`

```c
#pragma once

void memstat_register(void* ptr, size_t size);
void memstat_unregister(void* ptr);
size_t memstat_get_size(void* ptr);
void print_mem_stats();
```

---

### üìÅ `memstat.c`

```c
#include "memstat.h"
#include "log.h"

typedef struct mem_block {
    void* ptr;
    size_t size;
    struct mem_block* next;
} mem_block_t;

static mem_block_t* mem_head = NULL;

void memstat_register(void* ptr, size_t size) {
    mem_block_t* new = kmalloc(sizeof(mem_block_t));
    new->ptr = ptr;
    new->size = size;
    new->next = mem_head;
    mem_head = new;
}

void memstat_unregister(void* ptr) {
    mem_block_t** curr = &mem_head;
    while (*curr) {
        if ((*curr)->ptr == ptr) {
            mem_block_t* tmp = *curr;
            *curr = tmp->next;
            kfree(tmp);
            return;
        }
        curr = &(*curr)->next;
    }
}

size_t memstat_get_size(void* ptr) {
    mem_block_t* curr = mem_head;
    while (curr) {
        if (curr->ptr == ptr) return curr->size;
        curr = curr->next;
    }
    return 0;
}

void print_mem_stats() {
    size_t count = 0;
    size_t total = 0;
    mem_block_t* curr = mem_head;
    while (curr) {
        count++;
        total += curr->size;
        curr = curr->next;
    }

    klog_info("üîç –ê–∫—Ç–∏–≤–Ω—ã—Ö –±–ª–æ–∫–æ–≤: %zu, –û–±—â–∏–π –æ–±—ä—ë–º: %zu –±–∞–π—Ç", count, total);
}
```

---

### ‚úÖ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

–í `main.c` (–∏–ª–∏ –ª—é–±–æ–º –º–æ–¥—É–ª–µ —è–¥—Ä–∞):

```c
void kernel_main() {
    ...
    void* p1 = kmalloc(128);
    void* p2 = kmalloc(512);
    print_mem_stats();

    kfree(p1);
    print_mem_stats();
}
```

---

### üí° –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –Ω–∞ –±—É–¥—É—â–µ–µ

* –ö–æ–ª—å—Ü–µ–≤–æ–π –±—É—Ñ–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ –≤—ã–¥–µ–ª–µ–Ω–∏–π
* –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ call stack'–æ–≤ (–¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∫–∏)
* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å `procfs` –∏–ª–∏ –ª–æ–≥ –≤ —Ñ–∞–π–ª

---

## üìà –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 7/10

üí° –¢—Ä–µ–±—É–µ—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –ø–∞–º—è—Ç—å—é.

---

## ‚è± –í—Ä–µ–º—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ:

* –¢–µ–æ—Ä–∏—è: 1 —á
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `memstat`: 2 —á
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `kmalloc/kfree`: 1.5 —á
* –¢–µ—Å—Ç—ã –∏ –æ—Ç–ª–∞–¥–∫–∞: 1.5 —á
  **–ò—Ç–æ–≥–æ: 6 —á–∞—Å–æ–≤**

---

## üë®‚Äçüè´ –ú–µ—Ç–æ–¥–∏–∫–∞:

* –õ–µ–∫—Ü–∏—è: –ø–æ—á–µ–º—É –≤–∞–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø–∞–º—è—Ç—å
* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: –∫–∞–∫ –±—ã—Å—Ç—Ä–æ –º–æ–∂–Ω–æ —Å–ª–æ–≤–∏—Ç—å —É—Ç–µ—á–∫—É
* –ü—Ä–∞–∫—Ç–∏–∫–∞: —Ä—É–∫–∞–º–∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ–º –≤ —è–¥—Ä–æ
* –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ: –Ω–∞–ø–∏—Å–∞—Ç—å mini-test –Ω–∞ 10 malloc+free –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—á—ë—Ç

---

## üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã:

* [The Slab Allocator (Linux)](https://www.kernel.org/doc/html/latest/mm/slab.html)
* [OSDev ‚Äî Memory Management](https://wiki.osdev.org/Memory_Management)
* [Malloc/Free Tracing](https://wiki.osdev.org/Debugging_Memory)

---

### üß† –í—ã–≤–æ–¥:

–¢–µ–ø–µ—Ä—å —Ç–≤–æ—è –û–° —É–º–µ–µ—Ç —Å—á–∏—Ç–∞—Ç—å! üí°
–¢—ã –º–æ–∂–µ—à—å –ø–æ–Ω—è—Ç—å, –∫—É–¥–∞ —É—Ö–æ–¥–∏—Ç –ø–∞–º—è—Ç—å, –∏ –ª–æ–≤–∏—Ç—å —É—Ç–µ—á–∫–∏ –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω–∏ –ø—Ä–∏–≤–µ–¥—É—Ç –∫ –∫—Ä–∞—Ö—É —è–¥—Ä–∞.

---

üéØ –í **–£—Ä–æ–∫–µ 44** –º—ã –Ω–∞—á–Ω—ë–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é **—É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç—å—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ **–æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∞–¥—Ä–µ—Å–Ω—ã—Ö –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤** –∏ –±–∞–∑–æ–≤—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü.

–°–∫–∞–∂–∏ **–¥–∞–¥–∞**, –µ—Å–ª–∏ –≥–æ—Ç–æ–≤ ‚Äî –∏ –ø–æ–π–¥—ë–º —Ç—É–¥–∞, –≥–¥–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∏–∑–æ–ª—è—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å üß±üîê
