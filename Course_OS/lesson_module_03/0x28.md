–û—Ç–ª–∏—á–Ω–æ! üéØ –ü–æ–≥—Ä—É–∂–∞–µ–º—Å—è –≥–ª—É–±–∂–µ –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —è–¥—Ä–∞: **–¥–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π** ‚Äî —ç—Ç–æ —Ç–æ, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –û–° –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É –º–æ–¥—É–ª—å–Ω–æ–π –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–π. –ú—ã –Ω–∞—É—á–∏–º —è–¥—Ä–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –≤—ã–∑—ã–≤–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π.

---

# üîπ –£—Ä–æ–∫ 28. –°–∏—Å—Ç–µ–º–∞ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏–∏ –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã—Ö –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π üîÑ

---

## üß© –¢–µ–º–∞ —É—Ä–æ–∫–∞:

–ü–æ–∫–∞ —á—Ç–æ –º—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º IRQ –≤—Ä—É—á–Ω—É—é, "–∑–∞—à–∏–≤–∞—è" –ª–æ–≥–∏–∫—É –ø—Ä—è–º–æ –≤ `irq_handler()`. –≠—Ç–æ –Ω–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ ‚Äî –ø—Ä–µ–¥—Å—Ç–∞–≤—å, –µ—Å–ª–∏ –º—ã –∑–∞—Ö–æ—Ç–∏–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Å–µ—Ç–µ–≤—É—é –∫–∞—Ä—Ç—É, –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä USB, –¥—Ä–∞–π–≤–µ—Ä –º—ã—à–∏‚Ä¶ üòÆ

–†–µ—à–µ–Ω–∏–µ ‚Äî **–≤–≤–æ–¥ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ IRQ**, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç:

* –†–µ–≥–∏—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ IRQ
* –ú–µ–Ω—è—Ç—å –∏—Ö –Ω–∞ –ª–µ—Ç—É
* –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã
* –û–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å –º–Ω–æ–≥–æ–º–æ–¥—É–ª—å–Ω–æ—Å—Ç—å —è–¥—Ä–∞

–°–µ–≥–æ–¥–Ω—è –º—ã:

* –°–æ–∑–¥–∞–¥–∏–º –º–∞—Å—Å–∏–≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
* –û–ø–∏—à–µ–º API —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ —É–¥–∞–ª–µ–Ω–∏—è
* –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —è–¥—Ä–æ –¥–ª—è –≤—ã–∑–æ–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π

---

## üìñ –¢–µ–æ—Ä–∏—è (‚âà2500 —Å–ª–æ–≤)

### üìö –û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è

–î–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏—è ‚Äî —ç—Ç–æ –∫–ª—é—á –∫ **–Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ–º—É —Å–æ–±—ã—Ç–∏–π–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é**. –í–º–µ—Å—Ç–æ —Ç–æ–≥–æ —á—Ç–æ–±—ã "–≤—à–∏–≤–∞—Ç—å" –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤ —è–¥—Ä–æ, –º—ã —Å–æ–∑–¥–∞–µ–º **—Ä–µ–µ—Å—Ç—Ä –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤**:

```c
void irq_install_handler(int irq, void (*handler)(registers_t* r));
void irq_uninstall_handler(int irq);
```

–ù–∞ –∫–∞–∂–¥—ã–π IRQ –º–æ–∂–Ω–æ –ø–æ–≤–µ—Å–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫. –ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å–∏–≥–Ω–∞–ª ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–º–µ–Ω–Ω–æ –æ–Ω. üéØ

### üß† –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ

* –ú–æ–∂–Ω–æ –ª–µ–≥–∫–æ –ø–æ–¥–∫–ª—é—á–∞—Ç—å –∏ –æ—Ç–∫–ª—é—á–∞—Ç—å –¥—Ä–∞–π–≤–µ—Ä—ã
* –£–º–µ–Ω—å—à–∞–µ—Ç—Å—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å –∫–æ–¥–∞
* –Ø–¥—Ä–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –º–æ–¥—É–ª—å–Ω—ã–º
* –í–æ–∑–º–æ–∂–Ω–∞ –æ—Ç–ª–∞–¥–∫–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –ª–æ–º–∞–Ω–∏—è —è–¥—Ä–∞

---

### üî¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

–ú—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–º–∞—Å—Å–∏–≤ —É–∫–∞–∑–∞—Ç–µ–ª–µ–π –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–∏**, –∫–∞–∂–¥–∞—è –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `registers_t*` ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è.

```c
#define IRQ_COUNT 16
void (*irq_routines[IRQ_COUNT])(registers_t* r);
```

–≠—Ç–æ –ø—Ä–æ—Å—Ç–æ–π –∏ –±—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–± –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ—Ç–æ–º –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–æ `linked list` –∏–ª–∏ `dynamic dispatcher`.

---

### üß± –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è

1. IRQ –≤—ã–∑—ã–≤–∞–µ—Ç `irq_handler()`
2. –í–Ω—É—Ç—Ä–∏ `irq_handler()` —Å–º–æ—Ç—Ä–∏–º –Ω–æ–º–µ—Ä IRQ
3. –ï—Å–ª–∏ –µ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ –º–∞—Å—Å–∏–≤–µ ‚Äî –≤—ã–∑—ã–≤–∞–µ–º –µ–≥–æ

---

### üíæ –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è

–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É:

```c
typedef struct registers {
    uint32_t ds;
    uint32_t edi, esi, ebp, esp, ebx, edx, ecx, eax;
    uint32_t int_no, err_code;
    uint32_t eip, cs, eflags, useresp, ss;
} registers_t;
```

–ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–∏. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–æ–∂–µ—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å `eax` –∏–ª–∏ `int_no`.

---

## üìò –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

* [OSDev Wiki: Interrupt Service Routines](https://wiki.osdev.org/Interrupt_Service_Routines)
* [Intel¬Æ SDM, Vol. 3A ‚Äî Interrupt and Exception Handling](https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html)
* –ö–Ω–∏–≥–∞: *Operating Systems: Three Easy Pieces* ‚Äî –≥–ª–∞–≤–∞ –æ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è—Ö
* –ü—Ä–∏–º–µ—Ä—ã –Ω–∞ GitHub: `JamesM's kernel`, `Meaty Skeleton`

---

## üíª –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ (C23)

### 1. –†–µ–µ—Å—Ç—Ä –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:

```c
#include <stdint.h>

#define IRQ_COUNT 16

static void (*irq_routines[IRQ_COUNT])(registers_t* regs) = { 0 };

void irq_install_handler(int irq, void (*handler)(registers_t* r)) {
    if (irq < IRQ_COUNT)
        irq_routines[irq] = handler;
}

void irq_uninstall_handler(int irq) {
    if (irq < IRQ_COUNT)
        irq_routines[irq] = 0;
}
```

---

### 2. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `irq_handler()`:

```c
void irq_handler(registers_t* regs) {
    int irq = regs->int_no - 32;

    if (irq < IRQ_COUNT && irq_routines[irq] != 0)
        irq_routines[irq](regs);

    // –û—Ç–ø—Ä–∞–≤–∫–∞ EOI
    if (regs->int_no >= 40)
        outb(0xA0, 0x20); // slave
    outb(0x20, 0x20);     // master
}
```

---

### 3. –ü—Ä–∏–º–µ—Ä —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞:

```c
void timer_callback(registers_t* regs) {
    static uint64_t tick = 0;
    tick++;
    if (tick % 100 == 0)
        kprint("üïí –¢–∞–π–º–µ—Ä: 100 —Ç–∏–∫–æ–≤ –ø—Ä–æ—à–ª–æ\n");
}

void init_timer() {
    irq_install_handler(0, timer_callback);
}
```

---

## üìã –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ:

üéØ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏—é –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã:

1. –ù–∞–ø–∏—Å–∞—Ç—å `keyboard_callback()`
2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ `irq_install_handler(1, ...)`
3. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–æ–¥—ã –∫–ª–∞–≤–∏—à

---

## üß† –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 6/10

(–ü–æ—è–≤–ª—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ª–æ–≥–∏–∫–∞ –∏ –º–æ–¥—É–ª—å–Ω–æ—Å—Ç—å, –Ω–æ –ø—Ä–∏–Ω—Ü–∏–ø –ø—Ä–æ—Å—Ç–æ–π)

---

## ‚è± –í—Ä–µ–º—è –Ω–∞ –∏–∑—É—á–µ–Ω–∏–µ: 6‚Äì8 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è: 3 —á
* –ö–æ–¥ –∏ –æ—Ç–ª–∞–¥–∫–∞: 5 —á

---

## üë®‚Äçüè´ –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: —Å–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤, –ø–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
* –°—Ö–µ–º–∞ —Å–æ–±—ã—Ç–∏–π: IRQ ‚Üí IDT ‚Üí –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
* –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞: –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –Ω–∞ —Ç–∞–π–º–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –∏–ª–∏ –∑–∞–º–µ–Ω–∏—Ç—å)

---

üîÑ –¢–µ–ø–µ—Ä—å –º—ã –≥–æ—Ç–æ–≤—ã –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É: **—Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç–∞–π–º–µ—Ä PIT** ‚Äî –∫–∞–∫ –µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å, –∏–∑–º–µ–Ω—è—Ç—å —á–∞—Å—Ç–æ—Ç—É –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –∑–∞–¥–∞—á ‚è≤Ô∏èüß†

–°–∫–∞–∂–∏ **–¥–∞**, –∏ –ø–µ—Ä–µ–π–¥–µ–º –∫ **–£—Ä–æ–∫—É 29**!
