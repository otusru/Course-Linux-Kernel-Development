–û—Ç–ª–∏—á–Ω–æ! üöÄ –ü–æ–≥—Ä—É–∂–∞–µ–º—Å—è –≤ **–£—Ä–æ–∫ 39**, –≥–¥–µ –Ω–∞—à–∞ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤—ã—Ö–æ–¥–∏—Ç –Ω–∞ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å ‚Äî **–∑–∞–≥—Ä—É–∑–∫–∞ –∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ ELF**. –≠—Ç–æ –≤–∞–∂–Ω–µ–π—à–∏–π —à–∞–≥ –¥–ª—è –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—è –Ω–∞—à–µ–π –û–° –∏–∑ –Ω–∞–±–æ—Ä–∞ —Ñ—É–Ω–∫—Ü–∏–π –≤ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É, –≥–¥–µ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã–µ –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç —è–¥—Ä–∞. üíª‚öôÔ∏è

---

## üîπ –£—Ä–æ–∫ 39. –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ ELF-—Ñ–∞–π–ª–æ–≤ üß®üîß

---

### üß© –¢–µ–º–∞ —É—Ä–æ–∫–∞:

* –ß—Ç–æ —Ç–∞–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç ELF (Executable and Linkable Format)
* –ü–∞—Ä—Å–∏–Ω–≥ ELF-–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
* –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ `.text`, `.data`, `.bss` –≤ –ø–∞–º—è—Ç—å
* –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ (entry point)
* –ü–µ—Ä–µ–¥–∞—á–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–µ–∫–∞ –∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ `argv`, `envp`
* –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ ELF-—Ñ–∞–π–ª–æ–≤
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 64-–±–∏—Ç–Ω—ã—Ö ELF-—Ñ–∞–π–ª–æ–≤ (ELF64)

---

## üìñ –ö—Ä–∞—Ç–∫–æ–µ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (\~2500 —Å–ª–æ–≤, –∑–¥–µ—Å—å —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–æ)

### üìå –ß—Ç–æ —Ç–∞–∫–æ–µ ELF?

ELF ‚Äî —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤ Linux –∏ –º–Ω–æ–≥–∏—Ö Unix-—Å–∏—Å—Ç–µ–º–∞—Ö. –û–Ω –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞, –µ–≥–æ —Å–µ–≥–º–µ–Ω—Ç—ã, —Å–∏–º–≤–æ–ª—ã, —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞ –∏ –¥—Ä—É–≥–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ.

–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã ELF:

* ELF Header ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∏–ø–µ —Ñ–∞–π–ª–∞, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, —Ç–æ—á–∫–µ –≤—Ö–æ–¥–∞
* Program Headers ‚Äî –æ–ø–∏—Å—ã–≤–∞—é—Ç —Å–µ–≥–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤ –ø–∞–º—è—Ç—å
* Section Headers ‚Äî –¥–ª—è –ª–∏–Ω–∫–µ—Ä–∞ (–º–æ–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ)
* –°–µ–≥–º–µ–Ω—Ç—ã `.text`, `.data`, `.bss` ‚Äî –∫–æ–¥ –∏ –¥–∞–Ω–Ω—ã–µ

---

### üìå –û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è –∑–∞–≥—Ä—É–∑–∫–∏ ELF:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ñ–∞–π–ª –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ ELF (`0x7F`, `E`, `L`, `F`)
2. –ü—Ä–æ—á–∏—Ç–∞—Ç—å ELF header (`Elf64_Ehdr`)
3. –ü—Ä–æ–π—Ç–∏—Å—å –ø–æ Program Headers (`Elf64_Phdr`)
4. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ —Ç–∏–ø–∞ `PT_LOAD`:

   * –≤—ã–¥–µ–ª–∏—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –ø–∞–º—è—Ç—å
   * –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å –¥–∏—Å–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ RAMFS –∏–ª–∏ initrd)
   * –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å `.bss` –Ω—É–ª—è–º–∏
5. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–µ–∫ –∏ —Ä–µ–≥–∏—Å—Ç—Ä—ã
6. –ü–µ—Ä–µ–¥–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ `e_entry`

---

### üìå –ö–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç `Elf64_Ehdr`:

```c
typedef struct {
  unsigned char e_ident[16];
  uint16_t e_type;
  uint16_t e_machine;
  uint32_t e_version;
  uint64_t e_entry;
  uint64_t e_phoff;
  uint64_t e_shoff;
  uint32_t e_flags;
  uint16_t e_ehsize;
  uint16_t e_phentsize;
  uint16_t e_phnum;
  ...
} Elf64_Ehdr;
```

---

### üîç –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ELF:

```c
int load_elf(const uint8_t* elf_image) {
    Elf64_Ehdr* ehdr = (Elf64_Ehdr*)elf_image;

    if (ehdr->e_ident[0] != 0x7F || ehdr->e_ident[1] != 'E') {
        return -1; // –ù–µ ELF
    }

    Elf64_Phdr* phdrs = (Elf64_Phdr*)(elf_image + ehdr->e_phoff);
    for (int i = 0; i < ehdr->e_phnum; ++i) {
        Elf64_Phdr* ph = &phdrs[i];
        if (ph->p_type != PT_LOAD) continue;

        void* seg_addr = (void*)ph->p_vaddr;
        memcpy(seg_addr, elf_image + ph->p_offset, ph->p_filesz);
        memset(seg_addr + ph->p_filesz, 0, ph->p_memsz - ph->p_filesz);

        // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ (R/W/X)
        set_page_flags(seg_addr, ph->p_memsz, ph->p_flags);
    }

    // –£—Å—Ç–∞–Ω–æ–≤–∏–º —Å—Ç–µ–∫
    setup_user_stack();

    // –ó–∞–ø—É—Å–∫
    jump_to_user((void*)ehdr->e_entry);
    return 0;
}
```

---

### üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π ELF –¥–ª—è —Ç–µ—Å—Ç–∞

```asm
; hello.asm
section .text
global _start
_start:
    mov rax, 60      ; syscall: exit
    xor rdi, rdi     ; status: 0
    syscall
```

–°–æ–±–∏—Ä–∞–µ–º:

```bash
nasm -f elf64 hello.asm
ld -o hello hello.o
```

---

### üõ†Ô∏è –ö–∞–∫ –ø–µ—Ä–µ–¥–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ?

```c
void jump_to_user(void* entry) {
    // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç—ã, —Ä–µ–≥–∏—Å—Ç—Ä—ã
    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–µ–∫, –æ—á–∏—Å—Ç–∏—Ç—å —Ñ–ª–∞–≥–∏
    asm volatile(
        "mov %0, %%rsp\n"
        "xor %%rbp, %%rbp\n"
        "jmp *%1\n"
        : : "r"(user_stack_top), "r"(entry)
    );
}
```

---

### üß† –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 9/10

–†–∞–±–æ—Ç–∞ —Å –±–∏–Ω–∞—Ä–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º, –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π, –ø–∞–º—è—Ç—å—é –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º —Ä–µ–∂–∏–º–æ–≤.

---

### ‚è± –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è: 8‚Äì10 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è ELF: 2 —á
* –†–∞–∑–±–æ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã: 2 —á
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏: 3 —á
* –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: 2 —á
* –û—à–∏–±–∫–∏ –∏ –æ—Ç–ª–∞–¥–∫–∞: 1 —á

---

### üë®‚Äçüè´ –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* –õ–µ–∫—Ü–∏—è: —á—Ç–æ —Ç–∞–∫–æ–µ ELF, —Ä–∞–∑–º–µ—Ç–∫–∞ –±–∏–Ω–∞—Ä–Ω–∏–∫–æ–≤
* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: –æ—Ç–∫—Ä—ã—Ç—å ELF-—Ñ–∞–π–ª –≤ `readelf` –∏ `xxd`
* –ü—Ä–∞–∫—Ç–∏–∫–∞: –Ω–∞–ø–∏—Å–∞—Ç—å –∑–∞–≥—Ä—É–∑—á–∏–∫ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å hello-world ELF
* –î–æ–º–∞—à–∫–∞: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É ELF-—Ñ–∞–π–ª–∞ —Å `main()`, `argc`, `argv`

---

### üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã:

* [ELF Specification v1.2 (PDF)](https://refspecs.linuxfoundation.org/elf/elf.pdf)
* [OSDev ‚Äî Loading an ELF Executable](https://wiki.osdev.org/ELF)
* `readelf -a binary`, `objdump -D`
* [Linux From Scratch ‚Äî Ch.6 ELF binaries](https://linuxfromscratch.org)

---

üí• –ü–æ–∑–¥—Ä–∞–≤–ª—è—é! –¢–µ–ø–µ—Ä—å —Ç–≤–æ—è –û–° —É–º–µ–µ—Ç **–∑–∞–≥—Ä—É–∂–∞—Ç—å –∏ –∑–∞–ø—É—Å–∫–∞—Ç—å –±–∏–Ω–∞—Ä–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã**! –≠—Ç–æ –∫–∞–∫ –Ω–∞—É—á–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –¥—ã—à–∞—Ç—å!

üéØ –ì–æ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å?
–°–∫–∞–∂–∏ **–¥–∞–¥–∞** ‚Äî –∏ –≤ **–£—Ä–æ–∫–µ 40** –º—ã –Ω–∞—É—á–∏–º—Å—è **—Ä–∞–±–æ—Ç–∞—Ç—å —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Å—Ä–µ–¥—ã (`argv` / `envp`)**! üß¨
