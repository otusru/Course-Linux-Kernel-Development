–û—Ç–ª–∏—á–Ω–æ! üöÄ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ **–£—Ä–æ–∫ 38**, –≥–¥–µ –º—ã —Ä–∞—Å—à–∏—Ä–∏–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã, –¥–æ–±–∞–≤–∏–≤ **—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º —Ä–µ–∂–∏–º–µ**. –ú—ã –Ω–∞—É—á–∏–º—Å—è —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏**, **–∑–∞—â–∏—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü**, –∞ —Ç–∞–∫–∂–µ –ø–æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è —Å –∫–æ–Ω—Ü–µ–ø—Ü–∏—è–º–∏ `mmap`, `brk`, `heap`, –∏ —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ/—è–¥—Ä–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞. –≠—Ç–æ –∫–ª—é—á–µ–≤–æ–π —à–∞–≥ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º. üß†üí°

---

## üîπ –£—Ä–æ–∫ 38. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º —Ä–µ–∂–∏–º–µ üß±üß†

---

### üß© –¢–µ–º–∞ —É—Ä–æ–∫–∞:

* –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–∞ –ø–∞–º—è—Ç—å –≤ x86\_64: –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –∞–¥—Ä–µ—Å–∞—Ü–∏—è, —Ä–∞–∑–º–µ—Ç–∫–∞, page tables
* –ö–æ–Ω—Ü–µ–ø—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –∏ –∑–∞—â–∏—Ç–∞
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `brk` –∏ `mmap`
* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ heap –¥–ª—è malloc/free
* –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –º–µ–∂–¥—É –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏
* –°—Ç—Ä–∞–Ω–∏—á–Ω–∞—è –∑–∞—â–∏—Ç–∞ (read/write/exec/none)

---

## üìñ –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (\~2500‚Äì3000 —Å–ª–æ–≤, –∑–¥–µ—Å—å —Å–æ–∫—Ä–∞—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)

### üìå –ó–∞—á–µ–º —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–∞–º—è—Ç—å—é –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º —Ä–µ–∂–∏–º–µ?

–õ—é–±–∞—è —Å–ª–æ–∂–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –¥–æ–ª–∂–Ω–∞ **–≤—ã–¥–µ–ª—è—Ç—å, –æ—Å–≤–æ–±–æ–∂–¥–∞—Ç—å –∏ –∑–∞—â–∏—â–∞—Ç—å –ø–∞–º—è—Ç—å**. –ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ: –±–µ–∑ `malloc()` –≤—ã –Ω–µ —Å–º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –º–∞—Å—Å–∏–≤, —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –≤ –ø–∞–º—è—Ç—å. –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞:

1. –í—ã–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é **–≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –ø–∞–º—è—Ç—å** (–Ω–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫—É—é —Ñ–∏–∑–∏—á–µ—Å–∫—É—é).
2. –ó–∞—â–∏—Ç–∏—Ç—å –æ–±–ª–∞—Å—Ç—å, —á—Ç–æ–±—ã –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ "–≤–ª–µ–∑" –≤ –ø–∞–º—è—Ç—å —è–¥—Ä–∞.
3. –ü–æ–∑–≤–æ–ª–∏—Ç—å —É–ø—Ä–∞–≤–ª—è—Ç—å —ç—Ç–æ–π –ø–∞–º—è—Ç—å—é —á–µ—Ä–µ–∑ `brk`, `mmap`, –∏ –¥—Ä—É–≥–∏–µ –≤—ã–∑–æ–≤—ã.

---

### üìå –û–±–ª–∞—Å—Ç–∏ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞

–ü—Ä–æ–≥—Ä–∞–º–º–∞ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º —Ä–µ–∂–∏–º–µ –∏–º–µ–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∫–ª—é—á–µ–≤—ã–µ –∑–æ–Ω—ã:

```
0x00000000 ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî> NULL
       |
       | [–¢–µ–∫—Å—Ç –ø—Ä–æ–≥—Ä–∞–º–º—ã: code, .text]
       | [–î–∞–Ω–Ω—ã–µ: .data, .bss]
       | [Heap: –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø–∞–º—è—Ç—å ‚Äî malloc, new]
       |     ‚Üëbrk
       |     ‚Üìmmap (–æ–±—ã—á–Ω–æ –≤—ã—Å–æ–∫–æ)
       | [–°—Ç–µ–∫: —Ä–∞—Å—Ç–µ—Ç –≤–Ω–∏–∑]
0xFFFFFFFF ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî> MAX_USER_ADDR
```

---

### üìå `brk` –∏ `sbrk`

`brk` ‚Äî —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –∏–∑–º–µ–Ω—è–µ—Ç –≤–µ—Ä—Ö–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É heap. –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–¥–µ–ª—è—Ç—å –ø–∞–º—è—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ.

```c
void* sys_brk(void* new_break) {
    if ((uint64_t)new_break < heap_start || (uint64_t)new_break > heap_max) {
        return (void*)-1;
    }
    heap_end = new_break;
    return new_break;
}
```

---

### üìå `mmap`

–ë–æ–ª–µ–µ –≥–∏–±–∫–∏–π —Å–ø–æ—Å–æ–± –≤—ã–¥–µ–ª–∏—Ç—å –ø–∞–º—è—Ç—å. –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤, –±–∏–±–ª–∏–æ—Ç–µ–∫, —Å—Ç–µ–∫–æ–≤ –∏ —Ç.–¥.

```c
void* sys_mmap(uint64_t addr, uint64_t length, int prot, int flags, int fd, int offset);
```

---

### üìå –°–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã

–î–æ–±–∞–≤–∏–º –Ω–æ–≤—ã–µ –≤—ã–∑–æ–≤—ã –≤ —Ç–∞–±–ª–∏—Ü—É:

| ‚Ññ | –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ               |
| - | -------- | ---------------------- |
| 2 | brk      | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥—Ä–∞–Ω–∏—Ü—ã heap |
| 3 | mmap     | –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏     |
| 4 | munmap   | –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è   |

---

### üîß –°—Ç–∞—Ä—Ç–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `brk` (—è–¥—Ä–æ)

```c
#define USER_HEAP_START 0x40000000
#define USER_HEAP_MAX   0x80000000

void* current_brk = (void*)USER_HEAP_START;

int sys_brk(uint64_t new_brk, uint64_t _, uint64_t __) {
    if (new_brk < USER_HEAP_START || new_brk > USER_HEAP_MAX)
        return -1;
    current_brk = (void*)new_brk;
    return (int)new_brk;
}
```

---

### üìò –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `malloc`

```c
void* malloc(size_t size) {
    static char* heap_end = 0;
    if (!heap_end) {
        heap_end = (char*)syscall(SYS_BRK, 0, 0, 0);
    }

    char* prev = heap_end;
    char* new_end = prev + size;
    if ((uintptr_t)syscall(SYS_BRK, new_end, 0, 0) != (uintptr_t)new_end) {
        return NULL;
    }
    heap_end = new_end;
    return prev;
}
```

---

### üí¨ –ü–æ—á–µ–º—É –Ω–µ–ª—å–∑—è –ø–∏—Å–∞—Ç—å –∑–∞ –ø—Ä–µ–¥–µ–ª—ã?

–ö–∞–∂–¥–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–∞–º—è—Ç–∏ –∏–º–µ–µ—Ç —Ñ–ª–∞–≥–∏:

* **R** (readable)
* **W** (writable)
* **X** (executable)
* **U** (user-mode access)

–ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –ø—ã—Ç–∞–µ—Ç—Å—è –ø–∏—Å–∞—Ç—å –≤ –ø–∞–º—è—Ç—å —è–¥—Ä–∞ ‚Äî –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è (Page Fault).

---

### üìò mmap —Å –ø—Ä–æ—Ç–µ–∫—Ü–∏–µ–π:

```c
void* sys_mmap(uint64_t addr, uint64_t length, int prot, int flags, int fd, int offset) {
    // –°—Ç—Ä–∞–Ω–∏—á–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–æ–≤
    void* ptr = page_alloc_user(length);
    set_page_flags(ptr, length, prot); // –Ω–∞–ø—Ä–∏–º–µ—Ä, R/W
    return ptr;
}
```

---

## üß† –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 8/10

–ó–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏, —Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∏ –∑–∞—â–∏—Ç—É –ø–∞–º—è—Ç–∏.

---

## ‚è± –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è: 9 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è: 3 —á
* brk –∏ heap: 2 —á
* mmap –∏ page flags: 2 —á
* –ü—Ä–∞–∫—Ç–∏–∫–∞ –∏ —Ç–µ—Å—Ç—ã: 2 —á

---

## üë®‚Äçüè´ –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* –õ–µ–∫—Ü–∏—è: —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–∞–º—è—Ç–∏ –∏ —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: –∫–∞—Ä—Ç–∞ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
* –°—Ö–µ–º–∞: –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å –∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
* –ü—Ä–∞–∫—Ç–∏–∫–∞: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç–µ–π—à–∏–π `malloc`, `free`, `calloc`
* –î–æ–º–∞—à–∫–∞: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –∑–∞—â–∏—Ç—É

---

## üìö –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:

* [Intel SDM Vol 3: Paging](https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html)
* [OSDev Wiki: Memory Management](https://wiki.osdev.org/Paging)
* [man 2 mmap, brk](https://man7.org/linux/man-pages/)
* [Modern Operating Systems ‚Äî Tanenbaum](https://www.pearson.com)

---

‚úÖ –¢–µ–ø–µ—Ä—å —É —Ç–≤–æ–µ–π –û–° –µ—Å—Ç—å **—Ä–µ–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**. –ê –∑–Ω–∞—á–∏—Ç, —Ç—ã –≥–æ—Ç–æ–≤ –∫ **–±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º, –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º ELF-—Ñ–∞–π–ª–∞–º, –∑–∞—â–∏—â—ë–Ω–Ω—ã–º —Å—Ç–µ–∫–∞–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –ø—Ä–æ—Ü–µ—Å—Å–∞–º —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç—å—é**!

üí¨ –°–∫–∞–∂–∏ **–¥–∞–¥–∞**, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –∫ **–£—Ä–æ–∫—É 39: ELF-–∑–∞–≥—Ä—É–∑—á–∏–∫ ‚Äî –∑–∞–ø—É—Å–∫ –±–∏–Ω–∞—Ä–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º –∏–∑ —è–¥—Ä–∞!** üß®üíª
