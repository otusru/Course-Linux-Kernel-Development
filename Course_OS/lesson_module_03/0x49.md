–û—Ç–ª–∏—á–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º! üöÄ

---

## üîπ –£—Ä–æ–∫ 49. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é: –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å –∏ —Å—Ç—Ä–∞–Ω–∏—á–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è üß†üìò

---

### üß† –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å

–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã –ø–æ–≥—Ä—É–∂–∞–µ–º—Å—è –≤ –æ—Å–Ω–æ–≤—ã **–≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏** –∏ **—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏**. –≠—Ç–∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–∞–º—è—Ç—å—é, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –∏–∑–æ–ª—è—Ü–∏—é –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤.

#### –ß—Ç–æ —Ç–∞–∫–æ–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å?

**–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å** ‚Äî —ç—Ç–æ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º–∞—è –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–∞–º —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–º –∞–¥—Ä–µ—Å–Ω—ã–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ–º, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –∫–∞–∫ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏. –≠—Ç–æ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é –º–µ—Ö–∞–Ω–∏–∑–º–∞, –Ω–∞–∑—ã–≤–∞–µ–º–æ–≥–æ **—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–µ–π –ø–∞–º—è—Ç–∏**.

#### –°—Ç—Ä–∞–Ω–∏—á–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏

–í **—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏** –ø–∞–º—è—Ç—å –¥–µ–ª–∏—Ç—Å—è –Ω–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∏ (—Å—Ç—Ä–∞–Ω–∏—Ü—ã), –æ–±—ã—á–Ω–æ —Ä–∞–∑–º–µ—Ä–æ–º 4 –ö–ë. –ö–∞–∂–¥–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ —Å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏. –≠—Ç–æ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é **—Ç–∞–±–ª–∏—Ü —Å—Ç—Ä–∞–Ω–∏—Ü**.

#### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

* **–°—Ç—Ä–∞–Ω–∏—Ü–∞ (Page)**: –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±–ª–æ–∫ –ø–∞–º—è—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 4 –ö–ë).
* **–¢–∞–±–ª–∏—Ü–∞ —Å—Ç—Ä–∞–Ω–∏—Ü (Page Table)**: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä–∞—è —Ö—Ä–∞–Ω–∏—Ç —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü —Å —Ñ–∏–∑–∏—á–µ—Å–∫–∏–º–∏.
* **–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü (Page Directory)**: –°—Ç—Ä—É–∫—Ç—É—Ä–∞, –∫–æ—Ç–æ—Ä–∞—è —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü.
* **–†–µ–≥–∏—Å—Ç—Ä—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (CR3, CR0)**: –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞, —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ –≤–∫–ª—é—á–µ–Ω–∏–µ–º —Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏ —É–∫–∞–∑–∞–Ω–∏–µ–º –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å—Ç—Ä–∞–Ω–∏—Ü.

---

### üõ† –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

–î–ª—è –Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–¥–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü –∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü:

```c
#define PAGE_SIZE 4096
#define NUM_PAGES 1024

typedef struct {
    uint32_t entries[NUM_PAGES];
} page_table_t;

typedef struct {
    page_table_t* tables[NUM_PAGES];
} page_directory_t;
```

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–¥–∏–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü:

```c
void init_page_directory(page_directory_t* dir) {
    for (int i = 0; i < NUM_PAGES; i++) {
        dir->tables[i] = NULL;
    }
}
```

–î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä—ã –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞:

```asm
void enable_paging(page_directory_t* dir) {
    asm volatile (
        "mov %0, %%cr3\n"          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º CR3
        "mov %%cr0, %%eax\n"
        "or $0x80000000, %%eax\n"  // –í–∫–ª—é—á–∞–µ–º –±–∏—Ç 31 –≤ CR0
        "mov %%eax, %%cr0\n"
        :
        : "r"(dir)
        : "eax"
    );
}
```

---

### üîç –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

* [OSDev Wiki: Setting Up Paging](https://wiki.osdev.org/Setting_Up_Paging)
* [OSDev Wiki: Page Tables](https://wiki.osdev.org/Page_Tables)
* [Intel¬Æ 64 and IA-32 Architectures Software Developer‚Äôs Manual, Volume 3: System Programming Guide](https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html)

---

### ‚úÖ –ó–∞–¥–∞–Ω–∏–µ

1. –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü –∏ —Ç–∞–±–ª–∏—Ü —Å—Ç—Ä–∞–Ω–∏—Ü.
2. –ù–∞–ø–∏—à–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü.
3. –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏.

---

–ì–æ—Ç–æ–≤—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å? –°–∫–∞–∂–∏—Ç–µ **–¥–∞–¥–∞–¥–∞**, –∏ –º—ã –ø–µ—Ä–µ–π–¥–µ–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É!
