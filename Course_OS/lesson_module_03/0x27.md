–û—Ç–ª–∏—á–Ω–æ! üöÄ –ü–æ–≥—Ä—É–∂–∞–µ–º—Å—è –≥–ª—É–±–∂–µ ‚Äî —Ç–µ–ø–µ—Ä—å –Ω–∞—à–µ–º—É —è–¥—Ä—É –Ω—É–∂–Ω–æ —É–º–µ—Ç—å **—Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è**, —Ç–∞–∫–∏–µ –∫–∞–∫ –Ω–∞–∂–∞—Ç–∏–µ –∫–ª–∞–≤–∏—à –∏–ª–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä **–ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π –æ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (IRQ)**!

---

# üîπ –£—Ä–æ–∫ 27. –ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (IRQ): —Ç–∞–π–º–µ—Ä, –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞, –∏ –Ω–µ —Ç–æ–ª—å–∫–æ ‚è≤Ô∏è‚å®Ô∏è

---

## üß© –¢–µ–º–∞ —É—Ä–æ–∫–∞:

–ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (IRQ, –∏–ª–∏ hardware interrupts) ‚Äî —ç—Ç–æ –æ–¥–∏–Ω –∏–∑ –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤, —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—ã–π **–≤–Ω–µ—à–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —É–≤–µ–¥–æ–º–ª—è—é—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä** –æ —Å–æ–±—ã—Ç–∏—è—Ö. –ù–∞–ø—Ä–∏–º–µ—Ä:

* –¢–∞–π–º–µ—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–∂–¥—É—é –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—É üïí
* –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–æ—Å—ã–ª–∞–µ—Ç —Å–∏–≥–Ω–∞–ª –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–ª–∞–≤–∏—à–∏ ‚å®Ô∏è
* –°–µ—Ç–µ–≤–∞—è –∫–∞—Ä—Ç–∞ —Å–æ–æ–±—â–∞–µ—Ç –æ –Ω–æ–≤–æ–º –ø–∞–∫–µ—Ç–µ üåê

–°–µ–≥–æ–¥–Ω—è –º—ã:

* –ù–∞—Å—Ç—Ä–æ–∏–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π (PIC / APIC)
* –ù–∞–ø–∏—à–µ–º –¥–∏—Å–ø–µ—Ç—á–µ—Ä—ã –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π –¥–ª—è —Ç–∞–π–º–µ—Ä–∞ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
* –û–±—Ä–∞–±–æ—Ç–∞–µ–º –ø–µ—Ä–≤—ã–µ —Å–æ–±—ã—Ç–∏—è
* –ù–∞—É—á–∏–º —è–¥—Ä–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

---

## üìñ –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (‚âà2500 —Å–ª–æ–≤)

### ‚öôÔ∏è –ß—Ç–æ —Ç–∞–∫–æ–µ IRQ?

IRQ (Interrupt Request) ‚Äî —ç—Ç–æ —Å–ø–æ—Å–æ–±, —Å –ø–æ–º–æ—â—å—é –∫–æ—Ç–æ—Ä–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≥–æ–≤–æ—Ä–∏—Ç: **¬´–≠–π, –º–Ω–µ –Ω—É–∂–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞!¬ª**. –í –æ—Ç–≤–µ—Ç, –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä:

1. –ü—Ä–µ—Ä—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é –∑–∞–¥–∞—á—É
2. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ
3. –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º—É –∫–æ–¥—É ‚Äî **–æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (ISR)**
4. –í—ã–ø–æ–ª–Ω—è–µ—Ç –µ–≥–æ
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ

---

### üí° –°—Ç–∞—Ä—ã–π –¥–æ–±—Ä—ã–π PIC (8259A)

–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏, –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –æ–±—Å–ª—É–∂–∏–≤–∞–ª–∏—Å—å —á–µ—Ä–µ–∑ **Programmable Interrupt Controller (PIC)**. –ù–∞ x86:

* –ü–µ—Ä–≤—ã–π PIC –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç IRQ 0‚Äì7 (–ø–æ—Ä—Ç 0x20)
* –í—Ç–æ—Ä–æ–π PIC –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç IRQ 8‚Äì15 (–ø–æ—Ä—Ç 0xA0)

–ß—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –≤ —Å–≤–æ–µ–π –û–°, –Ω—É–∂–Ω–æ:

1. **–†–µ–º–∞–ø–∏—Ç—å** IRQ —Å 0x08‚Äì0x0F –Ω–∞ —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ 0x20‚Äì0x2F (–∏–Ω–∞—á–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏)
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É IDT
3. –ù–∞–ø–∏—Å–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

---

### ‚öôÔ∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

1. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ‚Üí IRQ
2. PIC –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–∏–≥–Ω–∞–ª –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—É
3. CPU –≤—ã–∑—ã–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ IDT
4. –û–° –≤—ã–ø–æ–ª–Ω—è–µ—Ç –Ω—É–∂–Ω—É—é –ª–æ–≥–∏–∫—É
5. –û–° –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç **EOI (end-of-interrupt)** –≤ PIC

---

### üîÑ APIC (Advanced PIC)

–í –±–æ–ª–µ–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö –≤–º–µ—Å—Ç–æ PIC –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **APIC** –∏–ª–∏ **x2APIC**. –ú—ã –∫–æ—Å–Ω—ë–º—Å—è –µ–≥–æ –ø–æ–∑–∂–µ (—É—Ä–æ–∫–∏ 60+), –Ω–æ –ø–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–π PIC.

---

### üß± IRQ –ù–æ–º–µ—Ä–∞

| –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ | IRQ | –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ —Ä–µ–º–∞–ø–∞ |
| ---------- | --- | ----------------------- |
| –¢–∞–π–º–µ—Ä     | 0   | 32 (0x20)               |
| –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ | 1   | 33 (0x21)               |
| COM-–ø–æ—Ä—Ç   | 4   | 36 (0x24)               |
| RTC        | 8   | 40 (0x28)               |

---

## üìò –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

* [OSDev Wiki: PIC](https://wiki.osdev.org/PIC)
* [Intel¬Æ SDM Vol. 3A, Chapter 10](https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html)
* [The Little Book About OS Development](https://littleosbook.github.io/)
* [–ü–æ—Å—Ç—ã –ø–æ –û–° –Ω–∞ habr.com (–ø–æ–∏—Å–∫: "irq osdev")](https://habr.com/ru/search/?q=irq%20osdev)

---

## üî¨ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ:

–†–µ–∞–ª–∏–∑—É–µ–º:

1. –†–µ–º–∞–ø –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ PIC
2. IDT-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è IRQ0 –∏ IRQ1
3. –ü—Ä–æ—Å—Ç—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–∞–∂–∞—Ç–∏–π –∫–ª–∞–≤–∏—à
4. –ü–æ–¥—Å—á—ë—Ç —Ç–∏–∫–æ–≤ –ø–æ —Ç–∞–π–º–µ—Ä—É

---

## üíª –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ (C23 + –Ω–µ–º–Ω–æ–≥–æ ASM)

### 1. –†–µ–º–∞–ø–∏–Ω–≥ PIC:

```c
#define PIC1_COMMAND 0x20
#define PIC1_DATA    0x21
#define PIC2_COMMAND 0xA0
#define PIC2_DATA    0xA1

void pic_remap() {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Å–∫–∏
    uint8_t a1 = inb(PIC1_DATA);
    uint8_t a2 = inb(PIC2_DATA);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    outb(PIC1_COMMAND, 0x11);
    outb(PIC2_COMMAND, 0x11);

    // –ù–æ–≤—ã–µ –æ—Ñ—Ñ—Å–µ—Ç—ã
    outb(PIC1_DATA, 0x20); // IRQ 0..7 -> INT 0x20..0x27
    outb(PIC2_DATA, 0x28); // IRQ 8..15 -> INT 0x28..0x2F

    // –°–≤—è–∑–∫–∞ PIC–æ–≤
    outb(PIC1_DATA, 0x04);
    outb(PIC2_DATA, 0x02);

    // –†–µ–∂–∏–º
    outb(PIC1_DATA, 0x01);
    outb(PIC2_DATA, 0x01);

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Å–æ–∫
    outb(PIC1_DATA, a1);
    outb(PIC2_DATA, a2);
}
```

---

### 2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ IRQ (asm ‚Üí c)

```nasm
; irq0.asm
global irq0
irq0:
    push 0
    push 32
    jmp irq_common_stub
```

```c
void irq_handler(registers_t* regs) {
    switch (regs->int_no) {
        case 32:
            timer_tick();
            break;
        case 33:
            keyboard_handler();
            break;
        default:
            break;
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º EOI
    if (regs->int_no >= 40)
        outb(0xA0, 0x20);
    outb(0x20, 0x20);
}
```

---

### 3. –¢–∞–π–º–µ—Ä –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞:

```c
uint64_t ticks = 0;

void timer_tick() {
    ticks++;
    if (ticks % 100 == 0)
        kprint("üí• –¢–∞–π–º–µ—Ä: 100 —Ç–∏–∫–æ–≤!\n");
}

void keyboard_handler() {
    uint8_t scancode = inb(0x60);
    kprint("‚å®Ô∏è –°–∫–∞–Ω-–∫–æ–¥: ");
    kputhex(scancode);
    kprint("\n");
}
```

---

## üß† –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 7/10

(–ù—É–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏, –Ω–æ –ª–æ–≥–∏–∫–∞ –ø—Ä–æ—Å—Ç–∞)

---

## ‚è± –í—Ä–µ–º—è –Ω–∞ –∏–∑—É—á–µ–Ω–∏–µ: 7‚Äì9 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è: 3 —á
* –ü—Ä–∞–∫—Ç–∏–∫–∞: 6 —á

---

## üë®‚Äçüè´ –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ü–µ–ø–æ—á–∫–∏: —Å–æ–±—ã—Ç–∏–µ ‚Üí IRQ ‚Üí –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
* –†–∞–±–æ—Ç–∞ —Å –ø–æ—Ä—Ç–∞–º–∏ –≤–≤–æ–¥–∞-–≤—ã–≤–æ–¥–∞
* –û—Ç–ª–∞–¥–∫–∞ –≤ QEMU –∏ –≤—ã–≤–æ–¥ scancode
* –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à–∏ Enter (0x1C) ‚Äî –ø—Ä–∏ —ç—Ç–æ–º –≤—ã–≤–æ–¥–∏—Ç—å "–í—ã –Ω–∞–∂–∞–ª–∏ Enter!"

---

–ì–æ—Ç–æ–≤ –ø–µ—Ä–µ–π—Ç–∏ –∫ **–£—Ä–æ–∫—É 28**, –≥–¥–µ –º—ã —Å–æ–∑–¥–∞–¥–∏–º **—Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π** ‚Äî –Ω–µ–∑–∞–≤–∏—Å–∏–º—É—é –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—É—é —Å–∏—Å—Ç–µ–º—É, –ø–æ–∑–≤–æ–ª—è—é—â—É—é –û–° —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –ª–µ—Ç—É.

–°–∫–∞–∂–∏ **–¥–∞**, –µ—Å–ª–∏ –∏–¥—ë–º –¥–∞–ª—å—à–µ! üö¶
