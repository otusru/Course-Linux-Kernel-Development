–û—Ç–ª–∏—á–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º! üöÄ

---

# üîπ –£—Ä–æ–∫ 29. –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä—É–µ–º—ã–π –ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—ã–π –¢–∞–π–º–µ—Ä (PIT) ‚è≤Ô∏è

---

## üß© –¢–µ–º–∞ —É—Ä–æ–∫–∞:

–°–µ–≥–æ–¥–Ω—è –º—ã –∑–∞–π–º–µ–º—Å—è **–Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞** ‚Äî –æ–¥–Ω–æ–≥–æ –∏–∑ –≤–∞–∂–Ω–µ–π—à–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –ª—é–±–æ–π –û–°. –≠—Ç–æ –Ω–∞—à –º–µ—Ç—Ä–æ–Ω–æ–º, –∑–∞–¥–∞—é—â–∏–π —Ä–∏—Ç–º –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ. –ë–ª–∞–≥–æ–¥–∞—Ä—è —Ç–∞–π–º–µ—Ä—É –≤–æ–∑–º–æ–∂–Ω—ã:

* –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á üßµ
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `sleep()` ‚è∏Ô∏è
* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ üìà
* –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã ‚è≥

–ú—ã –∏–∑—É—á–∏–º, –∫–∞–∫ **–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞—Ç—å PIT**, –Ω–∞—Å—Ç—Ä–æ–∏–º —á–∞—Å—Ç–æ—Ç—É –∏ –ø–æ–¥–∫–ª—é—á–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π.

---

## üìñ –¢–µ–æ—Ä–∏—è (‚âà2000‚Äì3000 —Å–ª–æ–≤)

### üìå –ß—Ç–æ —Ç–∞–∫–æ–µ PIT?

PIT (Programmable Interval Timer) ‚Äî —ç—Ç–æ –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–π —Ç–∞–π–º–µ—Ä, –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤ —á–∏–ø—Å–µ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö —Å x86 —Å–∏—Å—Ç–µ–º. –û–Ω –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ **—á–∏–ø–µ Intel 8253/8254**, –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —á–∞—Å—Ç–æ—Ç–µ **1 193 182 –ì—Ü**.

---

### üß† –ü–æ—á–µ–º—É –æ–Ω –≤–∞–∂–µ–Ω

PIT –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ **–∞–ø–ø–∞—Ä–∞—Ç–Ω—ã—Ö –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π IRQ0**. –û–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–∏–≥–Ω–∞–ª—ã –Ω–∞ —à–∏–Ω—É –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ —Å –∑–∞–¥–∞–Ω–Ω–æ–π –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å—é ‚Äî –∏ –û–° –º–æ–∂–µ—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä:

* –ó–∞–ø—É—Å–∫–∞—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á (–º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å)
* –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤—Ä–µ–º—è
* –°—á–∏—Ç–∞—Ç—å FPS –≤ –∏–≥—Ä–∞—Ö üòé

---

### ‚è≤Ô∏è –§–æ—Ä–º—É–ª–∞ –¥–µ–ª–∏—Ç–µ–ª—è

–ß—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å PIT, –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –¥–µ–ª–∏—Ç–µ–ª—å, —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º—ã–π —Ç–∞–∫:

```
–¥–µ–ª–∏—Ç–µ–ª—å = 1193182 / –Ω—É–∂–Ω–∞—è_—á–∞—Å—Ç–æ—Ç–∞
```

–ù–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å 100 –ì—Ü:

```
–¥–µ–ª–∏—Ç–µ–ª—å = 1193182 / 100 = 11931
```

---

### üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ PIT

**–ü–æ—Ä—Ç—ã:**

* `0x40` ‚Äî –∫–∞–Ω–∞–ª 0 (—Ç–∞–π–º–µ—Ä)
* `0x43` ‚Äî —É–ø—Ä–∞–≤–ª—è—é—â–∏–π —Ä–µ–≥–∏—Å—Ç—Ä

**–£–ø—Ä–∞–≤–ª—è—é—â–µ–µ —Å–ª–æ–≤–æ** (byte, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ –ø–æ—Ä—Ç 0x43):

* –ë–∏—Ç—ã 6-7: –∫–∞–Ω–∞–ª (00 = –∫–∞–Ω–∞–ª 0)
* –ë–∏—Ç—ã 4-5: —Ä–µ–∂–∏–º –¥–æ—Å—Ç—É–ø–∞ (11 = low byte/high byte)
* –ë–∏—Ç—ã 1-3: —Ä–µ–∂–∏–º (010 = —Ä–µ–∂–∏–º 2, –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è)
* –ë–∏—Ç 0: —Ç–∏–ø (0 = –¥–≤–æ–∏—á–Ω—ã–π —Å—á—ë—Ç)

–ò—Ç–æ–≥: `0x36` = `0011 0110` ‚Äî –∏–º–µ–Ω–Ω–æ —ç—Ç–æ –º—ã –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º.

---

### üóÉ –ü—Ä–∏–º–µ—Ä –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

```c
outb(0x43, 0x36);          // —É–ø—Ä–∞–≤–ª—è—é—â–µ–µ —Å–ª–æ–≤–æ
outb(0x40, divisor & 0xFF);        // –º–ª–∞–¥—à–∏–π –±–∞–π—Ç
outb(0x40, (divisor >> 8) & 0xFF); // —Å—Ç–∞—Ä—à–∏–π –±–∞–π—Ç
```

---

## üìò –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

* üìÑ [OSDev Wiki ‚Äî PIT](https://wiki.osdev.org/Programmable_Interval_Timer)
* üìò *Operating Systems: Three Easy Pieces*, –≥–ª–∞–≤—ã –ø—Ä–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
* üìö Intel 8253/8254 Datasheet (–∞–Ω–∞–ª–æ–≥ —Ç–∞–π–º–µ—Ä–∞ –≤ –ü–ö)
* [Intel SDM](https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html) (—Ä–∞–∑–¥–µ–ª –æ —Ç–∞–π–º–µ—Ä–∞—Ö)

---

## üíª –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ (C23)

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PIT:

```c
#include <stdint.h>
#include "io.h"

void init_timer(uint32_t frequency) {
    uint32_t divisor = 1193182 / frequency;

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–ø—Ä–∞–≤–ª—è—é—â–µ–≥–æ —Å–ª–æ–≤–∞
    outb(0x43, 0x36);

    // –î–µ–ª–∏—Ç–µ–ª—å: —Å–Ω–∞—á–∞–ª–∞ –º–ª–∞–¥—à–∏–π –±–∞–π—Ç, –∑–∞—Ç–µ–º —Å—Ç–∞—Ä—à–∏–π
    outb(0x40, (uint8_t)(divisor & 0xFF));
    outb(0x40, (uint8_t)((divisor >> 8) & 0xFF));
}
```

---

### 2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–∞–π–º–µ—Ä–∞:

```c
#include "isr.h"
#include "tty.h"

static uint64_t tick = 0;

void timer_callback(registers_t* regs) {
    tick++;
    if (tick % 100 == 0)
        kprint("–¢–∞–π–º–µ—Ä: –ø—Ä–æ—à–ª–æ 100 —Ç–∏–∫–æ–≤\n");
}

void init_timer_irq() {
    irq_install_handler(0, timer_callback);
}
```

---

### 3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:

```c
void kernel_main() {
    // ...
    init_timer_irq();
    init_timer(100); // 100 –ì—Ü
    // ...
}
```

---

## üß™ –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ:

* üîπ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å PIT –Ω–∞ 50 –ì—Ü
* üîπ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `timer_wait(ms)` ‚Äî —Ñ—É–Ω–∫—Ü–∏—è, –±–ª–æ–∫–∏—Ä—É—é—â–∞—è —Ü–∏–∫–ª –¥–æ –Ω—É–∂–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥
* üîπ –í—ã–≤–µ—Å—Ç–∏ –Ω–∞ —ç–∫—Ä–∞–Ω —Ç–∏–∫–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É

---

## üß† –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 6/10

(–ë–æ–ª—å—à–µ —Ä–∞–±–æ—Ç—ã —Å –∂–µ–ª–µ–∑–æ–º, –Ω–æ –≤—Å—ë –µ—â—ë —É–ø—Ä–∞–≤–ª—è–µ–º–æ üí™)

---

## ‚è± –í—Ä–µ–º—è –Ω–∞ –∏–∑—É—á–µ–Ω–∏–µ: 6‚Äì8 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è: 3‚Äì4 —á
* –ü—Ä–∞–∫—Ç–∏–∫–∞ –∏ –æ—Ç–ª–∞–¥–∫–∞: 4 —á

---

## üë®‚Äçüè´ –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* üë®‚Äçüè´ –õ–µ–∫—Ü–∏—è: –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –∏ –µ–≥–æ —Ä–∞–±–æ—Ç—ã
* üßÆ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —ç–º—É–ª—è—Ç–æ—Ä–µ QEMU
* üîÅ –°—Ö–µ–º–∞: "–∫–∞–∫ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –æ—Ç —Ç–∞–π–º–µ—Ä–∞ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫"
* üßë‚Äçüíª –ü—Ä–∞–∫—Ç–∏–∫–∞: —Å–º–µ–Ω–∞ —á–∞—Å—Ç–æ—Ç—ã, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∏–∫–æ–≤

---

–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ ‚Äî **—Å–∏—Å—Ç–µ–º–∞ —Å–Ω–∞ –∏ –æ–∂–∏–¥–∞–Ω–∏—è (`sleep()`, `timer_wait()`)**, –∞ –∑–∞—Ç–µ–º —É–∂–µ ‚Äî **–º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**! üßµüß†

–°–∫–∞–∑–∞—Ç—å **–¥–∞**, –∏ –ø–µ—Ä–µ–π–¥—ë–º –∫ **–£—Ä–æ–∫—É 30**!
