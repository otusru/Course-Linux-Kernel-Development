–û—Ç–ª–∏—á–Ω–æ! üéØ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ **–£—Ä–æ–∫ 37**, –≥–¥–µ –º—ã —Å–¥–µ–ª–∞–µ–º –æ–¥–∏–Ω –∏–∑ –∫–ª—é—á–µ–≤—ã—Ö —à–∞–≥–æ–≤ –≤ —Ä–∞–∑–≤–∏—Ç–∏–∏ –Ω–∞—à–µ–π –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã ‚Äî —Ä–µ–∞–ª–∏–∑—É–µ–º **—Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã (syscalls)** —á–µ—Ä–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ `int 0x80`. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∞–º –≤ **–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º —Ä–µ–∂–∏–º–µ (Ring 3)** –±–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ —è–¥—Ä–∞ ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, `write`, `read`, `exit`, `fork`, –∏ —Ç.–¥. üßµüîí

---

## üîπ –£—Ä–æ–∫ 37. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ —á–µ—Ä–µ–∑ `int 0x80` üß†üîÅ

---

### üß© –¢–µ–º–∞ —É—Ä–æ–∫–∞:

* –ß—Ç–æ —Ç–∞–∫–æ–µ —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤
* –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –∫–∞–∫ –º–µ—Ö–∞–Ω–∏–∑–º –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ —è–¥—Ä–æ
* –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ `int 0x80`
* –ü—Ä–æ—Ç–æ–∫–æ–ª –ø–µ—Ä–µ–¥–∞—á–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —è–¥—Ä–æ–º —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`write`, `exit`, `getpid`, –∏ –¥—Ä.)
* –¢–∞–±–ª–∏—Ü–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤

---

## üìñ –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ \~2500 —Å–ª–æ–≤)

### üìå –ß—Ç–æ —Ç–∞–∫–æ–µ —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤?

**–°–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤ (syscall)** ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º, —Å –ø–æ–º–æ—â—å—é –∫–æ—Ç–æ—Ä–æ–≥–æ **–ø—Ä–æ–≥—Ä–∞–º–º–∞ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º —Ä–µ–∂–∏–º–µ (Ring 3)** –º–æ–∂–µ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ **–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –≤ —è–¥—Ä–µ (Ring 0)**.

–ü—Ä–∏–º–µ—Ä—ã —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤:

* `write` ‚Äî –≤—ã–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —ç–∫—Ä–∞–Ω
* `read` ‚Äî —á—Ç–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
* `exit` ‚Äî –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞
* `fork`, `exec` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

–í –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –∫–æ–¥–µ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏. –ù–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ —ç—Ç–æ **—Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π –ø–µ—Ä–µ—Ö–æ–¥** –∏–∑ —Ä–µ–∂–∏–º–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —è–¥—Ä–æ.

---

### üìå –ü–æ—á–µ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `int 0x80`?

`int 0x80` ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Å–ø–æ—Å–æ–± —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –≤ Linux –∏ –û–°, —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö —Å x86. –û–Ω:

* –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
* –ü–æ–∑–≤–æ–ª—è–µ—Ç —è–¥—Ä—É –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å, –æ—Ç–∫—É–¥–∞ –ø–æ—Å—Ç—É–ø–∏–ª –≤—ã–∑–æ–≤
* –£–¥–æ–±–µ–Ω –¥–ª—è —É—á–µ–±–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, –ø—Ä–æ—â–µ, —á–µ–º `syscall/sysret`

---

### üìå –ü—Ä–æ—Ç–æ–∫–æ–ª –≤—ã–∑–æ–≤–∞

–ü–µ—Ä–µ–¥–∞—á–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:

* `eax` ‚Äî –Ω–æ–º–µ—Ä —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
* `ebx`, `ecx`, `edx`, `esi`, `edi`, `ebp` ‚Äî –∞—Ä–≥—É–º–µ–Ω—Ç—ã
* –†–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ `eax`

---

### üìò –ü—Ä–∏–º–µ—Ä: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–∑—ã–≤–∞–µ—Ç `write`

```c
int write(int fd, const char* buf, int len) {
    int result;
    asm volatile (
        "int $0x80"
        : "=a"(result)
        : "a"(1), "b"(fd), "c"(buf), "d"(len)
    );
    return result;
}
```

–í —ç—Ç–æ–º –∫–æ–¥–µ:

* `eax = 1` ‚Üí syscall `write`
* `ebx = fd`, `ecx = buf`, `edx = len`

---

### üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ –≤ —è–¥—Ä–µ

#### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è:

```c
extern void syscall_handler();

void syscall_init() {
    idt_set_gate(0x80, (uint64_t)syscall_handler, 0x08, 0x8E); // Ring 3
}
```

#### 2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∞—Å—Å–µ–º–±–ª–µ—Ä–µ:

```asm
.global syscall_handler
syscall_handler:
    pushaq
    call syscall_dispatch
    popaq
    iretq
```

---

#### 3. –î–∏—Å–ø–µ—Ç—á–µ—Ä —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤:

```c
typedef int (*syscall_func_t)(uint64_t, uint64_t, uint64_t);

int sys_write(uint64_t fd, uint64_t buf, uint64_t len);
int sys_exit(uint64_t code, uint64_t unused, uint64_t unused2);

syscall_func_t syscall_table[] = {
    sys_write, // 0
    sys_exit   // 1
};

int syscall_dispatch(uint64_t syscall_num, uint64_t arg1, uint64_t arg2, uint64_t arg3) {
    if (syscall_num >= sizeof(syscall_table)/sizeof(syscall_func_t)) {
        return -1;
    }
    return syscall_table[syscall_num](arg1, arg2, arg3);
}
```

---

### üìò –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤

```c
int sys_write(uint64_t fd, uint64_t buf, uint64_t len) {
    const char* str = (const char*)buf;
    for (uint64_t i = 0; i < len; i++) {
        putchar(str[i]); // —Ñ—É–Ω–∫—Ü–∏—è —è–¥—Ä–∞
    }
    return len;
}

int sys_exit(uint64_t code, uint64_t unused, uint64_t unused2) {
    // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞, –∑–∞–≥–ª—É—à–∫–∞
    while (1) {
        halt(); // –∏–ª–∏ return_to_scheduler()
    }
}
```

---

### üß™ –ü—Ä–∏–º–µ—Ä: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–¥

```c
void user_main() {
    const char* msg = "–ü—Ä–∏–≤–µ—Ç –∏–∑ user mode!\n";
    write(1, msg, strlen(msg));
    exit(0);
}
```

---

## üß† –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 7/10

–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞, —Å—Ç–µ–∫–æ–≤, –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π –∏ –∑–∞—â–∏—Ç—ã –ø–∞–º—è—Ç–∏.

---

## ‚è± –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è: 7 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è: 2 —á
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è: 2 —á
* –¢–∞–±–ª–∏—Ü–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤: 1 —á
* –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: 2 —á

---

## üë®‚Äçüè´ –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* –õ–µ–∫—Ü–∏—è: –º–æ–¥–µ–ª—å Ring3‚ÜíRing0
* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—Ç
* –°—Ö–µ–º–∞: —Å—Ç–µ–∫ –∏ —Ä–µ–≥–∏—Å—Ç—Ä—ã –ø—Ä–∏ `int 0x80`
* –ü—Ä–∞–∫—Ç–∏–∫–∞: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `getpid`, `time`, `sleep`
* –î–æ–º–∞—à–∫–∞: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `puts` –∏ `exit`

---

## üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã:

* [Linux syscall conventions x86](https://wiki.osdev.org/Interrupts_Tutorial#Syscalls)
* [Intel SDM: Software Interrupts (INT)](https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html)
* [OSDev: System Calls](https://wiki.osdev.org/Creating_a_Simple_Syscall_Interface)
* [x86 Calling Conventions (cdecl)](https://en.wikipedia.org/wiki/X86_calling_conventions)

---

‚úÖ –¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –µ—Å—Ç—å **–Ω–∞—Å—Ç–æ—è—â–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤—ã–∑–æ–≤–æ–≤**, –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã –º–æ–≥—É—Ç **–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å —è–¥—Ä–æ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ**. –≠—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–≤–µ—Ä–∏ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç–∏, –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –¥—Ä–∞–π–≤–µ—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞.

üîú –ì–æ—Ç–æ–≤ –ø–µ—Ä–µ–π—Ç–∏ –∫ **–£—Ä–æ–∫—É 38: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º —Ä–µ–∂–∏–º–µ ‚Äî –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü, –∑–∞—â–∏—Ç–∞, mmap –∏ brk**?

–°–∫–∞–∂–∏ **–¥–∞–¥–∞**, –∏ –º—ã –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º üíæüì¶
