–°—É–ø–µ—Ä, –¥–≤–∏–≥–∞–µ–º—Å—è –≤–ø–µ—Ä—ë–¥! üí™
–°–µ–≥–æ–¥–Ω—è –º—ã —É–≥–ª—É–±–∏–º—Å—è –≤ —Ä–∞–±–æ—Ç—É —è–¥—Ä–∞ —Å –ø–∞–º—è—Ç—å—é: —Ç–µ–ø–µ—Ä—å –±—É–¥–µ–º **—Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏** ‚Äî –∫–∞–∫ –¥–ª—è —è–¥—Ä–∞, —Ç–∞–∫ –∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤.

---

## üîπ –£—Ä–æ–∫ 55. –ê–ª–ª–æ–∫–∞—Ç–æ—Ä –ø–∞–º—è—Ç–∏ –≤ —è–¥—Ä–µ: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ –∏ –∫—É—á–µ–π üß∞üß†

---

### üß† –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å (–æ–±—ä—ë–º: \~2500 —Å–ª–æ–≤)

–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ `malloc()` –∏ `free()` –∏–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ C ‚Äî –∏—Ö –ø–æ–ø—Ä–æ—Å—Ç—É –Ω–µ—Ç –≤ —è–¥—Ä–µ. –ó–Ω–∞—á–∏—Ç, –≤—Å—ë —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é, –≤–∫–ª—é—á–∞—è –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ, –º—ã –¥–æ–ª–∂–Ω—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å **—Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ**.

–ê–ª–ª–æ–∫–∞—Ç–æ—Ä—ã –¥–µ–ª—è—Ç—Å—è –Ω–∞ –¥–≤–∞ —Ç–∏–ø–∞:

1. **–§–∏–∑–∏—á–µ—Å–∫–∏–π –∞–ª–ª–æ–∫–∞—Ç–æ—Ä** ‚Äî —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç–∏ (—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å).
2. **–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞–ª–ª–æ–∫–∞—Ç–æ—Ä (–∫—É—á–∞)** ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–≤–µ—Ä—Ö –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—è —É–¥–æ–±–Ω—ã–µ –±–ª–æ–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 24 –±–∞–π—Ç–∞, 256 –±–∞–π—Ç –∏ —Ç.–¥.).

> –í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏–º—Å—è –Ω–∞ **—Ñ–∏–∑–∏—á–µ—Å–∫–æ–º –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–µ**, –∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º ‚Äî –Ω–∞ **–≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –∫—É—á–µ** —è–¥—Ä–∞.

---

### üîß –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∞–ª–ª–æ–∫–∞—Ç–æ—Ä?

–û–° –æ–±—ã—á–Ω–æ –≤—ã–¥–µ–ª—è–µ—Ç –ø–∞–º—è—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ (–æ–±—ã—á–Ω–æ 4 –ö–ë). –í–Ω—É—Ç—Ä–∏ —è–¥—Ä–∞ –º—ã –¥–æ–ª–∂–Ω—ã –∑–Ω–∞—Ç—å:

* –∫–∞–∫–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–≤–æ–±–æ–¥–Ω—ã
* –∫–∞–∫–∏–µ —É–∂–µ –≤—ã–¥–µ–ª–µ–Ω—ã
* –∫–∞–∫ –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –∏ –∑–∞–Ω–æ–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É

–î–ª—è —ç—Ç–æ–≥–æ —Å–æ–∑–¥–∞—ë—Ç—Å—è **–±–∏—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ (bitmap)** –∏–ª–∏ **–º–∞—Å—Å–∏–≤ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤**, –≥–¥–µ –∫–∞–∂–¥–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –∑–∞–Ω—è—Ç–∞ –∏–ª–∏ —Å–≤–æ–±–æ–¥–Ω–∞.

---

### üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ bitmap –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–∞

* 1 –±–∏—Ç = 1 —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (4 –ö–ë)
* –ï—Å–ª–∏ –±–∏—Ç = 0 ‚Üí —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–≤–æ–±–æ–¥–Ω–∞
* –ï—Å–ª–∏ –±–∏—Ç = 1 ‚Üí —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–Ω—è—Ç–∞

---

### üìò –ü—Ä–∏–º–µ—Ä: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–∞

```c
#define PAGE_SIZE 4096
#define MAX_PAGES 32768 // 128MB / 4KB

uint8_t page_bitmap[MAX_PAGES / 8]; // 4KB –Ω–∞ –≤—Å—é –∫–∞—Ä—Ç—É

// –ü—Ä–æ–≤–µ—Ä–∫–∞: —Å–≤–æ–±–æ–¥–Ω–∞ –ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞
bool is_page_free(size_t page_num) {
    return !(page_bitmap[page_num / 8] & (1 << (page_num % 8)));
}

// –û—Ç–º–µ—Ç–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞–∫ –∑–∞–Ω—è—Ç—É—é
void set_page_used(size_t page_num) {
    page_bitmap[page_num / 8] |= (1 << (page_num % 8));
}

// –û—Ç–º–µ—Ç–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞–∫ —Å–≤–æ–±–æ–¥–Ω—É—é
void set_page_free(size_t page_num) {
    page_bitmap[page_num / 8] &= ~(1 << (page_num % 8));
}
```

---

### üß™ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü

```c
void* alloc_page() {
    for (size_t i = 0; i < MAX_PAGES; i++) {
        if (is_page_free(i)) {
            set_page_used(i);
            return (void*)(i * PAGE_SIZE);
        }
    }
    return NULL; // –ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
}

void free_page(void* addr) {
    size_t page_num = ((uintptr_t)addr) / PAGE_SIZE;
    set_page_free(page_num);
}
```

> ‚ö†Ô∏è –≠—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî –±–∞–∑–æ–≤–∞—è. –û–Ω–∞ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç DMA, –¥–æ—Å—Ç—É–ø –∫ –≤—ã—Å–æ–∫–∏–º –∞–¥—Ä–µ—Å–∞–º, –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∞ –¥–æ NUMA-aware –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–∞.

---

### üìö –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

* [OSDev Wiki: Physical Memory Management](https://wiki.osdev.org/Physical_Memory_Management)
* Intel SDM Vol. 3 ‚Äî Physical Address Extension (PAE)
* –ö–Ω–∏–≥–∞ ‚ÄúOperating System Concepts‚Äù ‚Äî –≥–ª–∞–≤–∞ –æ memory management
* Tanenbaum, ‚ÄúModern Operating Systems‚Äù

---

### ‚úÖ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ

**–¶–µ–ª—å:** —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∞–ª–ª–æ–∫–∞—Ç–æ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü –≤ —è–¥—Ä–µ

üîß –≠—Ç–∞–ø—ã:

1. –í—ã–¥–µ–ª–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –ø–∞–º—è—Ç–∏ –ø–æ–¥ bitmap.
2. –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏ `alloc_page()` –∏ `free_page()`.
3. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç—ã:

   * –ó–∞–ø—Ä–æ—Å–∏—Ç–µ 5 —Å—Ç—Ä–∞–Ω–∏—Ü, –≤—ã–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å–∞.
   * –û—Å–≤–æ–±–æ–¥–∏—Ç–µ –æ–¥–Ω—É, –∑–∞—Ç–µ–º –≤—ã–¥–µ–ª–∏—Ç–µ –∑–∞–Ω–æ–≤–æ ‚Äî –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å—Å—è —Ç–æ—Ç –∂–µ –∞–¥—Ä–µ—Å.

üß™ –ü—Ä–∏–º–µ—Ä:

```c
void* p1 = alloc_page();
void* p2 = alloc_page();
free_page(p1);
void* p3 = alloc_page();
assert(p3 == p1); // –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å —Ç—É –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É
```

üìå –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —è–¥—Ä–∞ –≤—ã –æ—á–∏—â–∞–µ—Ç–µ bitmap –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Ç–æ–ª—å–∫–æ –¥–æ–ø—É—Å—Ç–∏–º—ã–µ –∞–¥—Ä–µ—Å–∞.

---

üéì **–ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è**:

* –õ–µ–∫—Ü–∏—è: –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –ø—Ä–∏–º–µ—Ä—ã bitmap
* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤ QEMU, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –∞–¥—Ä–µ—Å–∞
* –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
* –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª

---

üî¢ **–°–ª–æ–∂–Ω–æ—Å—Ç—å**: 6/10
‚è≥ **–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è**: 6‚Äì7 —á–∞—Å–æ–≤

---

–ì–æ—Ç–æ–≤—ã –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É ‚Äî –∫—É—á–µ —è–¥—Ä–∞? –ù–∞–ø–∏—à–∏ **–¥–∞–¥–∞–¥–∞**, –∏ –¥–≤–∏–≥–∞–µ–º—Å—è –¥–∞–ª—å—à–µ! üß±üì¶üíª
