–û—Ç–ª–∏—á–Ω–æ! üöÄ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ **–£—Ä–æ–∫ 40** ‚Äî —Å–µ–≥–æ–¥–Ω—è —Ç–≤–æ—è –û–° —Å–¥–µ–ª–∞–µ—Ç –µ—â—ë –æ–¥–∏–Ω —à–∞–≥ –∫ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏: –º—ã –¥–æ–±–∞–≤–∏–º **–ø–æ–¥–¥–µ—Ä–∂–∫—É `argc`, `argv[]` –∏ `envp[]`** –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç, –≤–µ–¥—å –ø–æ—á—Ç–∏ –∫–∞–∂–¥–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ C –æ–∂–∏–¥–∞–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –∏, –≤–æ–∑–º–æ–∂–Ω–æ, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è. üåêüß†

---

## üîπ –£—Ä–æ–∫ 40. –ê—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã (`argc`, `argv`, `envp`) –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö üß¨üó£Ô∏è

---

### üß© –¢–µ–º–∞ —É—Ä–æ–∫–∞:

* –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω—ã `argc`, `argv[]`, `envp[]` –≤ Linux –∏ POSIX
* –°—Ç–µ–∫–æ–≤–∞—è –º–æ–¥–µ–ª—å –ø–µ—Ä–µ–¥–∞—á–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
* –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–µ–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
* –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —è–¥—Ä–∞
* –ü—Ä–∏–º–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã, —á–∏—Ç–∞—é—â–µ–π –∞—Ä–≥—É–º–µ–Ω—Ç—ã
* –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏

---

## üìñ –ö—Ä–∞—Ç–∫–æ–µ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (\~2000‚Äì3000 —Å–ª–æ–≤, –∑–¥–µ—Å—å —Å–∂–∞—Ç–∞—è –≤–µ—Ä—Å–∏—è)

### üìå –ß—Ç–æ —Ç–∞–∫–æ–µ `argc`, `argv`, `envp`?

–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ª—é–±–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –Ω–∞–ø–∏—Å–∞–Ω–Ω–æ–≥–æ –Ω–∞ C, —Ñ—É–Ω–∫—Ü–∏—è `main()` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç:

```c
int main(int argc, char* argv[], char* envp[])
```

* `argc` ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
* `argv[]` ‚Äî –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ (—É–∫–∞–∑–∞—Ç–µ–ª–µ–π), —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö —Å–∞–º–∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
* `envp[]` ‚Äî –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–û–±—ã—á–Ω–æ –≤—Å—ë —ç—Ç–æ —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è **–≤ —Å—Ç–µ–∫–µ** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.

---

### üìå –ö–∞–∫ –û–° –ø–µ—Ä–µ–¥–∞—ë—Ç —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ?

–ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ:

* –û–° –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–µ–∫:

  * —Ä–∞–∑–º–µ—â–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏ `argv[0]`, `argv[1]`, ‚Ä¶
  * —Ä–∞–∑–º–µ—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ —É–∫–∞–∑–∞—Ç–µ–ª–µ–π `argv[]`, –∑–∞—Ç–µ–º `envp[]`, –∞ –∑–∞—Ç–µ–º `NULL`
* –Ω–∞ –≤–µ—Ä—à–∏–Ω–µ —Å—Ç–µ–∫–∞ —Ä–∞–∑–º–µ—â–∞—é—Ç—Å—è:

  * `argc`
  * —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ `argv[]`
  * —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ `envp[]`

–í–æ—Ç –ø—Ä–∏–º–µ—Ä –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç–µ–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞:

```
|------------------|
|     envp[N]      |
|       NULL       |
|     argv[N]      |
|       NULL       |
|      argc        | ‚Üê %rsp
|------------------|
```

---

### üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å—Ç–µ–∫–∞

–ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —á—Ç–æ —Ç–≤–æ—è –û–° –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—É `hello arg1 arg2`, —Ç–æ–≥–¥–∞:

```c
const char* argv[] = { "hello", "arg1", "arg2", NULL };
const char* envp[] = { "PATH=/bin", "LANG=C.UTF-8", NULL };
```

---

### üß† –ö–ª—é—á: —Ç—ã –¥–æ–ª–∂–µ–Ω –≤—Ä—É—á–Ω—É—é —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ –∏ —É–∫–∞–∑–∞—Ç–µ–ª–∏ –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞, –æ–±—ã—á–Ω–æ —Å–≤–µ—Ä—Ö—É, –æ—Ç `USER_STACK_TOP`.

---

### üí° –ü—Ä–∏–º–µ—Ä C-—Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å—Ç–µ–∫–∞

```c
#define USER_STACK_TOP 0x00007ffffff00000UL

uintptr_t prepare_user_stack(const char** argv, const char** envp) {
    uintptr_t stack = USER_STACK_TOP;
    char** argv_ptrs = ...; // –∞–¥—Ä–µ—Å–∞ –±—É–¥—É—â–∏—Ö —Å—Ç—Ä–æ–∫
    char** envp_ptrs = ...;

    // –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
    for (int i = argc - 1; i >= 0; i--) {
        size_t len = strlen(argv[i]) + 1;
        stack -= len;
        memcpy((void*)stack, argv[i], len);
        argv_ptrs[i] = (char*)stack;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º NULL
    stack -= sizeof(char*);
    *(char**)stack = NULL;

    // –ö–æ–ø–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ argv[]
    for (int i = argc - 1; i >= 0; i--) {
        stack -= sizeof(char*);
        *(char**)stack = argv_ptrs[i];
    }

    // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ envp[]
    stack -= sizeof(char*);
    *(char**)stack = NULL;
    for (int i = envc - 1; i >= 0; i--) {
        stack -= strlen(envp[i]) + 1;
        memcpy((void*)stack, envp[i], strlen(envp[i]) + 1);
        envp_ptrs[i] = (char*)stack;
    }

    // –£–∫–∞–∑–∞—Ç–µ–ª–∏ envp
    for (int i = envc - 1; i >= 0; i--) {
        stack -= sizeof(char*);
        *(char**)stack = envp_ptrs[i];
    }

    // –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ argv
    stack -= sizeof(char**);
    *(char***)stack = argv_ptrs;

    // –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ envp
    stack -= sizeof(char**);
    *(char***)stack = envp_ptrs;

    // argc
    stack -= sizeof(int);
    *(int*)stack = argc;

    return stack;
}
```

---

### üß™ –ü—Ä–∏–º–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã:

```c
#include <stdio.h>

int main(int argc, char* argv[], char* envp[]) {
    printf("–ê—Ä–≥—É–º–µ–Ω—Ç–æ–≤: %d\n", argc);
    for (int i = 0; i < argc; i++) {
        printf("argv[%d] = %s\n", i, argv[i]);
    }

    printf("\n–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã:\n");
    for (int i = 0; envp[i] != NULL; i++) {
        printf("envp[%d] = %s\n", i, envp[i]);
    }

    return 0;
}
```

---

### üìà –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 8/10

–ù—É–∂–Ω–æ –∑–Ω–∞—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å—Ç–µ–∫–∞, –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø–∞–º—è—Ç–∏, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ ABI.

---

### ‚è± –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è: 7 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è –∏ –º–æ–¥–µ–ª—å —Å—Ç–µ–∫–∞: 2 —á
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞: 3 —á
* –û—Ç–ª–∞–¥–∫–∞ —Å QEMU –∏ GDB: 2 —á

---

### üë®‚Äçüè´ –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* –õ–µ–∫—Ü–∏—è: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å—Ç–µ–∫–∞
* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: –∑–∞–ø—É—Å–∫ hello —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏
* –ü—Ä–∞–∫—Ç–∏–∫–∞: –Ω–∞–ø–∏—Å–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—ã
* –î–æ–º–∞—à–∫–∞: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —É—Ç–∏–ª–∏—Ç—É `env` –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–µ

---

### üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã:

* [System V ABI for x86-64](https://refspecs.linuxfoundation.org/elf/x86_64-SysV-psABI.pdf)
* [OSDev ‚Äî User Stack Setup](https://wiki.osdev.org/User-mode)
* [Linux execve() man](https://man7.org/linux/man-pages/man2/execve.2.html)

---

üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è—é! –¢–µ–ø–µ—Ä—å —Ç–≤–æ—è –û–° **–Ω–µ –ø—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º—ã, –Ω–æ —É–º–µ–µ—Ç –∏–º —á—Ç–æ-—Ç–æ "—Å–∫–∞–∑–∞—Ç—å" —á–µ—Ä–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ**! –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –û–° –ø—Ä–∏–≥–æ–¥–Ω–æ–π –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Ç–∏–ª–∏—Ç.

---

üîú –í —Å–ª–µ–¥—É—é—â–µ–º **–£—Ä–æ–∫–µ 41** –º—ã –Ω–∞—É—á–∏–º —è–¥—Ä–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å **–≤—ã—Ö–æ–¥–Ω–æ–π —Å—Ç–∞—Ç—É—Å** –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—Ä–∞—Ç–Ω–æ —è–¥—Ä—É ‚Äî –≤–µ–¥—å –ø—Ä–æ–≥—Ä–∞–º–º–∞ –¥–æ–ª–∂–Ω–∞ –∑–∞–≤–µ—Ä—à–∞—Ç—å—Å—è —Å –∫–æ–¥–æ–º, –∫–æ—Ç–æ—Ä—ã–π –≤–∞–∂–µ–Ω –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞.

–°–∫–∞–∂–∏ **–¥–∞** ‚Äî –∏ –ø—Ä–æ–¥–æ–ª–∂–∏–º! üß†üí™
