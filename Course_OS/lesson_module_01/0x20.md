–°—É–ø–µ—Ä! üöÄ –ü–æ–≥—Ä—É–∂–∞–µ–º—Å—è –≤ **–£—Ä–æ–∫ 20** ‚Äî –æ–¥–∏–Ω –∏–∑ –∫–ª—é—á–µ–≤—ã—Ö —ç—Ç–∞–ø–æ–≤ –ª—é–±–æ–π –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã ‚Äî **—Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã (syscalls)**. –≠—Ç–æ –º–æ—Å—Ç –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –∏ —è–¥—Ä–æ–≤—ã–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ–º. –ë–µ–∑ –Ω–∏—Ö –ø—Ä–æ–≥—Ä–∞–º–º—ã –Ω–µ —Å–º–æ–≥—É—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å —è–¥—Ä–æ–º: –Ω–∏ –≤—ã–≤–æ–¥ –Ω–∞ —ç–∫—Ä–∞–Ω, –Ω–∏ —Ä–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏, –Ω–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤. üéØ

---

# üîπ –£—Ä–æ–∫ 20. –°–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã: –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —è–¥—Ä–∞ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è üìûüß†

---

## üß© –¢–µ–º–∞ —É—Ä–æ–∫–∞:

–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã:

* –ü–æ–π–º—ë–º, –∑–∞—á–µ–º –Ω—É–∂–Ω—ã —Å–∏—Å—Ç–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã –∏ –∫–∞–∫ –æ–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ x86-64
* –†–µ–∞–ª–∏–∑—É–µ–º –±–∞–∑–æ–≤—ã–π –º–µ—Ö–∞–Ω–∏–∑–º syscall'–æ–≤ —á–µ—Ä–µ–∑ `SYSCALL/SYSRET`
* –°–æ–∑–¥–∞–¥–∏–º —Ç–∞–±–ª–∏—Ü—É –≤—ã–∑–æ–≤–æ–≤ –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
* –†–µ–∞–ª–∏–∑—É–µ–º –ø—Ä–æ—Å—Ç–µ–π—à–∏–µ –≤—ã–∑–æ–≤—ã: `write`, `exit`
* –ù–∞—É—á–∏–º—Å—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –∫–æ–ª—å—Ü–∞–º–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π (ring 3 ‚Üí ring 0 ‚Üí ring 3)

---

## üß† –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (‚âà3000 —Å–ª–æ–≤)

### üìû –ß—Ç–æ —Ç–∞–∫–æ–µ —Å–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤?

–°–∏—Å—Ç–µ–º–Ω—ã–π –≤—ã–∑–æ–≤ ‚Äî —ç—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π **–ø—Ä–æ–≥—Ä–∞–º–º–µ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ** –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ —Ñ—É–Ω–∫—Ü–∏—è–º —è–¥—Ä–∞.

–ü—Ä–∏–º–µ—Ä—ã:

* `write(fd, buf, size)` ‚Äî –≤—ã–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö
* `read(fd, buf, size)` ‚Äî —á—Ç–µ–Ω–∏–µ
* `exit(status)` ‚Äî –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞
* `fork()`, `exec()`, `wait()`, `open()`...

---

### üõ° –ó–∞—á–µ–º –Ω—É–∂–µ–Ω syscall?

* üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: —è–¥—Ä–æ –∑–∞—â–∏—â–µ–Ω–æ, –Ω–µ–ª—å–∑—è –ø—Ä–æ—Å—Ç–æ –≤—ã–∑–≤–∞—Ç—å `outb()` –∏–∑ ring 3
* üéØ –ö–æ–Ω—Ç—Ä–æ–ª—å: —è–¥—Ä–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
* üì¶ –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è: –≤—Å–µ –≤—ã–∑–æ–≤—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ –æ–¥–Ω—É —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞

---

### üß™ –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω syscall –≤ x86-64?

* –ö–æ–º–∞–Ω–¥—ã: `syscall` –∏ `sysret` ‚Äî –±—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏
* –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–µ–≥–∏—Å—Ç—Ä—ã:

  * `RAX` ‚Äî –Ω–æ–º–µ—Ä –≤—ã–∑–æ–≤–∞
  * `RDI`, `RSI`, `RDX`, `R10`, `R8`, `R9` ‚Äî –∞—Ä–≥—É–º–µ–Ω—Ç—ã
  * –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ `RAX`

---

### üîÑ –ü–æ—Ç–æ–∫ –≤—ã–∑–æ–≤–∞:

```text
user_main()
  |
  |-- syscall(WRITE, ...)
       |
       |-- trap to kernel via `syscall`
             |
             |-- –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ —è–¥—Ä–µ
                   |
                   |-- –≤—ã–∑–æ–≤ kernel_write()
                   |
             |-- –≤–æ–∑–≤—Ä–∞—Ç —á–µ—Ä–µ–∑ `sysret`
       |
  |-- –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
```

---

### üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MSR (Model Specific Register)

–î–ª—è —Ä–∞–±–æ—Ç—ã `syscall/sysret` –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:

* `IA32_LSTAR` ‚Äî –∞–¥—Ä–µ—Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ syscall
* `IA32_STAR` ‚Äî —Å–µ–ª–µ–∫—Ç–æ—Ä—ã —Å–µ–≥–º–µ–Ω—Ç–æ–≤
* `IA32_FMASK` ‚Äî —Ñ–ª–∞–≥–∏, –º–∞—Å–∫–∏—Ä—É–µ–º—ã–µ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ

---

## üìò –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:

* OSDev: [Syscalls](https://wiki.osdev.org/Syscalls)
* Intel SDM Vol. 3: `SYSCALL` / `SYSRET` (—Ä–∞–∑–¥–µ–ª 6.1.2)
* Linux Source: `arch/x86/entry/entry_64.S`, `syscall_table.S`

---

## üí° –¶–µ–ª—å –ø—Ä–∞–∫—Ç–∏–∫–∏:

* –ù–∞—Å—Ç—Ä–æ–∏—Ç—å MSR –¥–ª—è `syscall`
* –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤—ã–∑–æ–≤–æ–≤
* –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `sys_write()` –∏ `sys_exit()`
* –í—ã–∑—ã–≤–∞—Ç—å –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–¥–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –≤ –Ω–µ–≥–æ

---

## üíª –ü—Ä–∏–º–µ—Ä—ã –Ω–∞ —è–∑—ã–∫–µ C (C23)

### `syscall.h`

```c
#pragma once

enum syscall_numbers {
    SYS_WRITE = 0,
    SYS_EXIT  = 1,
};

void syscall_init();
```

---

### `syscall.c`

```c
#include "syscall.h"
#include "cpu/msr.h"
#include "tty.h"

typedef uint64_t (*syscall_t)(uint64_t, uint64_t, uint64_t, uint64_t, uint64_t, uint64_t);

static uint64_t sys_write(uint64_t fd, uint64_t buf, uint64_t size, ...) {
    const char* str = (const char*)buf;
    for (uint64_t i = 0; i < size; i++) {
        tty_putc(str[i]);
    }
    return size;
}

static uint64_t sys_exit(uint64_t code, ...) {
    while (1) __asm__("hlt");
}

static syscall_t syscall_table[] = {
    [SYS_WRITE] = sys_write,
    [SYS_EXIT] = sys_exit
};

__attribute__((interrupt))
void syscall_handler() {
    uint64_t syscall_no;
    __asm__("mov %%rax, %0" : "=r"(syscall_no));

    uint64_t arg1, arg2, arg3;
    __asm__("mov %%rdi, %0" : "=r"(arg1));
    __asm__("mov %%rsi, %0" : "=r"(arg2));
    __asm__("mov %%rdx, %0" : "=r"(arg3));

    if (syscall_no < sizeof(syscall_table)/sizeof(syscall_t)) {
        syscall_t func = syscall_table[syscall_no];
        uint64_t result = func(arg1, arg2, arg3, 0, 0, 0);
        __asm__("mov %0, %%rax" :: "r"(result));
    }
}

void syscall_init() {
    write_msr(0xC0000080, 1); // Enable syscall/sysret
    write_msr(0xC0000081, (uint64_t)syscall_handler); // LSTAR
    write_msr(0xC0000082, 0); // STAR - —Å–µ–≥–º–µ–Ω—Ç—ã
    write_msr(0xC0000084, 0); // MASK
}
```

---

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞

```c
static inline uint64_t syscall(uint64_t n, uint64_t arg1, uint64_t arg2, uint64_t arg3) {
    uint64_t ret;
    __asm__ volatile (
        "mov %1, %%rax\n"
        "mov %2, %%rdi\n"
        "mov %3, %%rsi\n"
        "mov %4, %%rdx\n"
        "syscall\n"
        "mov %%rax, %0\n"
        : "=r"(ret)
        : "r"(n), "r"(arg1), "r"(arg2), "r"(arg3)
        : "rax", "rdi", "rsi", "rdx"
    );
    return ret;
}

void user_main() {
    const char* msg = "–ü—Ä–∏–≤–µ—Ç –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –º–∏—Ä–∞!\n";
    syscall(SYS_WRITE, (uint64_t)msg, strlen(msg), 0);
    syscall(SYS_EXIT, 0, 0, 0);
}
```

---

## üß† –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 8.5/10

---

## ‚è± –í—Ä–µ–º—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: 10 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è: 3 —á
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è syscalls: 4 —á
* –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞: 2 —á
* –î–æ–º–∞—à–∫–∞: 1 —á

---

## üßë‚Äçüè´ –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* üìö –õ–µ–∫—Ü–∏—è: ring 3 ‚Üí ring 0, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—ã–∑–æ–≤–æ–≤
* üí° –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: –≤—ã–∑–æ–≤ `write` –∏–∑ `user_main`, –ø–µ—Ä–µ—Ö–æ–¥—ã `syscall` / `sysret`
* üíª –ü—Ä–∞–∫—Ç–∏–∫–∞: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤—ã–∑–æ–≤–æ–≤ –∏ –≤—ã–∑–æ–≤ —á–µ—Ä–µ–∑ –∞—Å—Å–µ–º–±–ª–µ—Ä
* üìù –î–æ–º–∞—à–∫–∞:

  * –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `getpid()`, `sleep(seconds)`
  * –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Ö–æ–¥—ã —Å –≤—ã–≤–æ–¥–æ–º –≤ –∫–æ–Ω—Å–æ–ª—å
  * –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥ –≤—ã–∑–æ–≤–æ–≤ –≤ –∫–æ–ª—å—Ü–µ 0

---

üí¨ –í—Å—ë –ø–æ–ª—É—á–∏–ª–æ—Å—å? –¢–æ–≥–¥–∞ –≥–æ—Ç–æ–≤—å—Å—è –∫ **–£—Ä–æ–∫—É 21**, –≥–¥–µ –º—ã –Ω–∞—á–Ω—ë–º —Ä–∞–±–æ—Ç—É —Å **—Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π**: —Å–æ–∑–¥–∞–¥–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É VFS, —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ `/dev`, –∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π FS üìÅüõ†Ô∏è
–ù–∞–ø–∏—à–∏ **–¥–∞**, –∏ –¥–≤–∏–≥–∞–µ–º—Å—è –¥–∞–ª—å—à–µ!
