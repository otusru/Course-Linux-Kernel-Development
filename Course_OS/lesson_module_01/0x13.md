–û—Ç–ª–∏—á–Ω–æ! üöÄ –ü–æ–≥—Ä—É–∂–∞–µ–º—Å—è –≤ **–£—Ä–æ–∫ 13** ‚Äî –æ–¥–∏–Ω –∏–∑ –∫—Ä–∞–µ—É–≥–æ–ª—å–Ω—ã—Ö –∫–∞–º–Ω–µ–π –ª—é–±–æ–π –û–°.

---

# üîπ –£—Ä–æ–∫ 13. –¢–∞–±–ª–∏—Ü–∞ —Å—Ç—Ä–∞–Ω–∏—Ü –∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–Ω—ã–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ–º

---

## üìö –¢–µ–º–∞ —É—Ä–æ–∫–∞:

–°–µ–≥–æ–¥–Ω—è –º—ã —Å —Ç–æ–±–æ–π –∏–∑—É—á–∏–º, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å –Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ **x86-64**, —á—Ç–æ —Ç–∞–∫–æ–µ **—Ç–∞–±–ª–∏—Ü–∞ —Å—Ç—Ä–∞–Ω–∏—Ü** (Page Tables), –∑–∞—á–µ–º –Ω—É–∂–Ω–∞ **–≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏**, –∏ –∫–∞–∫ –û–° —É–ø—Ä–∞–≤–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø–æ–º –∫ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç–∏. –ú—ã –Ω–∞—É—á–∏–º—Å—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Å—Ç—Ä–∞–Ω–∏—Ü, –Ω–∞—Å—Ç—Ä–æ–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —è–¥—Ä–∞ –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏ –Ω–∞–ø–∏—à–µ–º –ø–µ—Ä–≤—ã–µ –±–∞–∑–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏.

---

## üß† –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (‚âà2500‚Äì3000 —Å–ª–æ–≤)

### üß† –ü–æ—á–µ–º—É –Ω—É–∂–Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å?

–ë–µ–∑ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ–±—Ä–∞—â–∞–ª–∏—Å—å –±—ã –Ω–∞–ø—Ä—è–º—É—é –∫ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–º –∞–¥—Ä–µ—Å–∞–º. –≠—Ç–æ –æ–ø–∞—Å–Ω–æ: –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–≥–ª–æ –±—ã –ø–æ–≤—Ä–µ–¥–∏—Ç—å –∫–æ–¥ —è–¥—Ä–∞ –∏–ª–∏ —á—É–∂—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É. –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å ‚Äî —ç—Ç–æ –∏–∑–æ–ª—è—Ü–∏—è, –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª—å—à–µ –ø–∞–º—è—Ç–∏, —á–µ–º —Ä–µ–∞–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.

---

### üìê –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü —Å—Ç—Ä–∞–Ω–∏—Ü –≤ x86-64

–í 64-–±–∏—Ç–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **4-—É—Ä–æ–≤–Ω–µ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å—Ç—Ä–∞–Ω–∏—Ü**:

1. **PML4** (Page Map Level 4) ‚Äî –∫–æ—Ä–µ–Ω—å.
2. **PDPT** (Page Directory Pointer Table).
3. **PD** (Page Directory).
4. **PT** (Page Table).

–ö–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ **512 –∑–∞–ø–∏—Å–µ–π –ø–æ 8 –±–∞–π—Ç**, –∫–∞–∂–¥–∞—è —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å –∏–ª–∏ –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É.

–í–µ—Å—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å 48 –±–∏—Ç –¥–µ–ª–∏—Ç—Å—è –Ω–∞ –ø–æ–ª—è:

| –ë–∏—Ç—ã  | –£—Ä–æ–≤–µ–Ω—å | –†–∞–∑–º–µ—Ä |
| ----- | ------- | ------ |
| 47‚Äì39 | PML4    | 9 –±–∏—Ç  |
| 38‚Äì30 | PDPT    | 9 –±–∏—Ç  |
| 29‚Äì21 | PD      | 9 –±–∏—Ç  |
| 20‚Äì12 | PT      | 9 –±–∏—Ç  |
| 11‚Äì0  | Offset  | 12 –±–∏—Ç |

---

### ‚ö†Ô∏è –°—Ç—Ä–∞–Ω–∏—Ü–∞, —Å—Ç—Ä–∞–Ω–∏—á–∫–∞, —Å—Ç—Ä–∞–Ω–∏—â–µ...

* –û–±—ã—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: **4 –ö–ë**
* –ë–æ–ª—å—à–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: **2 –ú–ë**
* –û–≥—Ä–æ–º–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: **1 –ì–ë**

---

### üîí –ë–∏—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏

–ö–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å —Ç–∞–±–ª–∏—Ü—ã —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–ª–∞–≥–∏:

* `P`: Present
* `RW`: Read/Write
* `US`: User/Supervisor
* `NX`: No Execute (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
* `PWT`, `PCD`: –ö—ç—à
* `PAT`, `G`: –≥–ª–æ–±–∞–ª—å–Ω–æ—Å—Ç—å
* `XD`: Execute Disable (–∑–∞—â–∏—Ç–∞ –æ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)

---

### üåê –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞

* –Ø–¥—Ä–æ: —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –≤—ã—Å–æ–∫—É—é —á–∞—Å—Ç—å –ø–∞–º—è—Ç–∏.
* –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è: –ø–æ–ª—É—á–∞—é—Ç —Å–≤–æ—ë –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ.
* MMU –∏ TLB: —É—Å–∫–æ—Ä—è—é—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤.

---

## üìò –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:

* Intel SDM, Vol. 3: Chapter 4 (Paging)
* OSDev Wiki:

  * [Paging](https://wiki.osdev.org/Paging)
  * [Higher Half Kernel](https://wiki.osdev.org/Higher_Half_Kernel)
* ¬´Operating Systems: Three Easy Pieces¬ª, –≥–ª–∞–≤—ã –ø–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏

---

## üí° –¶–µ–ª—å –ø—Ä–∞–∫—Ç–∏–∫–∏:

* –°–æ–∑–¥–∞—Ç—å –±–∞–∑–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É —Å—Ç—Ä–∞–Ω–∏—Ü —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —è–¥—Ä–∞
* –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –ø–µ—Ä–≤—ã–µ 4 –ú–ë –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏ –≤ —Ñ–∏–∑–∏—á–µ—Å–∫—É—é
* –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º paging
* –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ kernel —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ "–≤—ã—Å–æ–∫–æ–º" –∞–¥—Ä–µ—Å–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0xFFFFFFFF80000000)

---

## üíª –ü—Ä–∏–º–µ—Ä –Ω–∞ —è–∑—ã–∫–µ C (C23)

---

### `paging.c`

```c
#include <stdint.h>
#include <stddef.h>
#include "mem.h"

#define PAGE_PRESENT 0x1
#define PAGE_RW      0x2
#define PAGE_USER    0x4

uint64_t* pml4;

void paging_init() {
    // –í—ã–¥–µ–ª–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è PML4
    pml4 = (uint64_t*)pmm_alloc_page();
    memset(pml4, 0, 4096);

    // –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É 0x0 ‚Üí 0x0 (–∏–¥–µ–Ω—Ç–∏—á–Ω–∞—è)
    map_page(pml4, 0x00000000, 0x00000000, PAGE_PRESENT | PAGE_RW);

    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —è–¥—Ä–æ (0x100000 ‚Üí 0xFFFFFFFF80000000)
    map_page(pml4, 0xFFFFFFFF80000000, 0x00100000, PAGE_PRESENT | PAGE_RW);

    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º
    load_pml4((uint64_t)pml4);
}
```

---

### `map_page.c`

```c
void map_page(uint64_t* pml4, uint64_t virt, uint64_t phys, uint64_t flags) {
    int pml4_index = (virt >> 39) & 0x1FF;
    int pdpt_index = (virt >> 30) & 0x1FF;
    int pd_index   = (virt >> 21) & 0x1FF;
    int pt_index   = (virt >> 12) & 0x1FF;

    uint64_t* pdpt = ensure_table(&pml4[pml4_index]);
    uint64_t* pd   = ensure_table(&pdpt[pdpt_index]);
    uint64_t* pt   = ensure_table(&pd[pd_index]);

    pt[pt_index] = (phys & ~0xFFF) | flags;
}
```

---

## üß† –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 9/10

---

## ‚è± –í—Ä–µ–º—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: 8‚Äì10 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è: 4 —á
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: 4‚Äì6 —á

---

## üßë‚Äçüè´ –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* üéì –õ–µ–∫—Ü–∏—è: —É—Ä–æ–≤–Ω–∏ —Å—Ç—Ä–∞–Ω–∏—Ü, —Ä–∞–∑–±–æ—Ä –∞–¥—Ä–µ—Å–∞
* üßÆ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: –æ—Ç–ª–∞–¥–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–π
* üõ† –ü—Ä–∞–∫—Ç–∏–∫–∞: –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –ø–∞–º—è—Ç—å —è–¥—Ä–∞
* üìù –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ:

  * –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
  * –ù–∞–ø–∏—Å–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `unmap_page()`

---

–•–æ—á–µ—à—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫ **–£—Ä–æ–∫—É 14**? –ù–∞–ø–∏—à–∏ **¬´–¥–∞¬ª** –∏ –ø–æ–µ—Ö–∞–ª–∏ –¥–∞–ª—å—à–µ üß†üíª.
