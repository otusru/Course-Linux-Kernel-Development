–û—Ç–ª–∏—á–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º! üöÄ

---

# üîπ –£—Ä–æ–∫ 9. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ GDT, IDT –∏ TSS –≤ Long Mode: –æ—Å–Ω–æ–≤–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Ç–æ–∫–∞–º–∏ –∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è–º–∏

---

## –ö—Ä–∞—Ç–∫–æ–µ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (‚âà2500 —Å–ª–æ–≤)

–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –º—ã —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–≤–µ–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –≤ 64-–±–∏—Ç–Ω—ã–π Long Mode, —Å–ª–µ–¥—É—é—â–∏–º —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–º —à–∞–≥–æ–º —è–≤–ª—è–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä: **GDT (Global Descriptor Table)**, **IDT (Interrupt Descriptor Table)** –∏ **TSS (Task State Segment)**. –≠—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏, –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π –∏ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å.

---

### üî∑ –ß—Ç–æ —Ç–∞–∫–æ–µ GDT?

`GDT` ‚Äî —ç—Ç–æ –≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤ —Å–µ–≥–º–µ–Ω—Ç–æ–≤. –í Protected Mode –∏ Long Mode –æ–Ω–∞ –Ω—É–∂–Ω–∞ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–º—è—Ç–∏, —Å–µ–≥–º–µ–Ω—Ç–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏, –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤.

#### –í Long Mode:

* –°–µ–≥–º–µ–Ω—Ç—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –ø–æ—á—Ç–∏ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º–∏.
* –°–µ–≥–º–µ–Ω—Ç—ã –∫–æ–¥–∞ –∏ –¥–∞–Ω–Ω—ã—Ö –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω—É–∂–Ω—ã (–¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å, –Ω–æ –±–∞–∑–æ–≤—ã–µ –∞–¥—Ä–µ—Å–∞ –∏ –ª–∏–º–∏—Ç—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è).
* –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä TSS –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω: –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–π –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ —è–¥—Ä–æ –ø–æ—Å–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ä–µ–∂–∏–º–∞ (—á–µ—Ä–µ–∑ –º–µ—Ö–∞–Ω–∏–∑–º syscall/interrupt).

---

### üî∂ –ß—Ç–æ —Ç–∞–∫–æ–µ TSS?

`TSS` ‚Äî —ç—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∞—è:

* –£–∫–∞–∑–∞—Ç–µ–ª–∏ –Ω–∞ —Å—Ç–µ–∫ —è–¥—Ä–∞ (–¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∏–∑ user –≤ kernel).
* –†–µ–∑–µ—Ä–≤–Ω—ã–µ —Å—Ç–µ–∫–æ–≤—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã (IST) –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Double Fault).
* –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –≤ GDT –∫–∞–∫ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä.

TSS –æ—Å–æ–±–µ–Ω–Ω–æ –≤–∞–∂–µ–Ω –≤ Long Mode, –ø–æ—Å–∫–æ–ª—å–∫—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ —Å—Ç–µ–∫ —è–¥—Ä–∞ –ø—Ä–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–∞—Ö –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è—Ö.

---

### üî∑ –ß—Ç–æ —Ç–∞–∫–æ–µ IDT?

`IDT` ‚Äî —ç—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π:

* –ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç IDT —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—é (ISR ‚Äî Interrupt Service Routine).
* –í Long Mode –∫–∞–∂–¥—ã–π –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä –∏–º–µ–µ—Ç 16 –±–∞–π—Ç.
* IDT —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–æ 256 –∑–∞–ø–∏—Å–µ–π (0‚Äì255): –ø–µ—Ä–≤—ã–µ 32 ‚Äî —ç—Ç–æ CPU –∏—Å–∫–ª—é—á–µ–Ω–∏—è, –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ IRQ.

---

### –°–≤—è–∑—å –º–µ–∂–¥—É GDT, IDT –∏ TSS

| –°—Ç—Ä—É–∫—Ç—É—Ä–∞ | –†–æ–ª—å                                                                  |
| --------- | --------------------------------------------------------------------- |
| GDT       | –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è Long Mode                |
| TSS       | –ó–∞–¥–∞–µ—Ç —Å—Ç–µ–∫ —è–¥—Ä–∞ –∏ IST, —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π |
| IDT       | –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–µ–∞–∫—Ü–∏—é –û–° –Ω–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏ –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è           |

---

### –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ (2025):

* –ö–∞–∂–¥–æ–µ —è–¥—Ä–æ –≤ SMP-—Å–∏—Å—Ç–µ–º–∞—Ö –∏–º–µ–µ—Ç —Å–≤–æ—é TSS.
* –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è IST –¥–ª—è Double Fault, NMI, Machine Check.
* IDT —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ .rodata –∏–ª–∏ .text —Å–µ–∫—Ü–∏–∏ –∏ –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã.

---

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:

* Intel SDM Vol. 3A, Chapters 5, 6, 7 (GDT, TSS, IDT, Interrupts)
* OSDev Wiki:

  * [GDT](https://wiki.osdev.org/GDT)
  * [IDT](https://wiki.osdev.org/IDT)
  * [TSS](https://wiki.osdev.org/TSS)
* –ö–Ω–∏–≥–∞: "Operating Systems: Three Easy Pieces" ‚Äî –≥–ª–∞–≤–∞ –ø—Ä–æ –æ–±—Ä–∞–±–æ—Ç–∫—É –∏—Å–∫–ª—é—á–µ–Ω–∏–π

---

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å: –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ GDT, TSS –∏ IDT

---

### üß† –ó–∞–¥–∞—á–∞:

* –ù–∞—Å—Ç—Ä–æ–∏—Ç—å GDT —Å –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∞–º–∏ –∫–æ–¥–∞, –¥–∞–Ω–Ω—ã—Ö –∏ TSS.
* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å TSS –∏ –∑–∞–¥–∞—Ç—å —Å—Ç–µ–∫ —è–¥—Ä–∞.
* –ü–æ—Å—Ç—Ä–æ–∏—Ç—å IDT –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Å—Ç–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è.

---

### üì¶ –ü—Ä–∏–º–µ—Ä –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ (–Ω–∞ C –∏ –∞—Å—Å–µ–º–±–ª–µ—Ä–µ)

#### `gdt.c` ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è GDT –∏ TSS

```c
#include <stdint.h>
#include <stddef.h>

struct GDTEntry {
    uint16_t limit_low;
    uint16_t base_low;
    uint8_t  base_middle;
    uint8_t  access;
    uint8_t  granularity;
    uint8_t  base_high;
} __attribute__((packed));

struct GDTPointer {
    uint16_t limit;
    uint64_t base;
} __attribute__((packed));

struct TSS {
    uint32_t reserved0;
    uint64_t rsp0;         // —Å—Ç–µ–∫ —è–¥—Ä–∞
    uint64_t rsp1, rsp2;
    uint64_t reserved1;
    uint64_t ist1, ist2, ist3, ist4, ist5, ist6, ist7;
    uint64_t reserved2;
    uint16_t reserved3;
    uint16_t iopb_offset;
} __attribute__((packed));

struct GDTEntry gdt[5];
struct GDTPointer gdt_ptr;
struct TSS tss __attribute__((aligned(16)));

void set_gdt_entry(int i, uint64_t base, uint32_t limit, uint8_t access, uint8_t gran) {
    gdt[i].limit_low = limit & 0xFFFF;
    gdt[i].base_low = base & 0xFFFF;
    gdt[i].base_middle = (base >> 16) & 0xFF;
    gdt[i].access = access;
    gdt[i].granularity = ((limit >> 16) & 0x0F) | (gran & 0xF0);
    gdt[i].base_high = (base >> 24) & 0xFF;
}

void init_gdt_tss() {
    // –ö–æ–¥ –∏ –¥–∞–Ω–Ω—ã–µ
    set_gdt_entry(1, 0, 0, 0x9A, 0x20); // 64-–±–∏—Ç –∫–æ–¥
    set_gdt_entry(2, 0, 0, 0x92, 0x20); // 64-–±–∏—Ç –¥–∞–Ω–Ω—ã–µ

    // TSS (—Ä–∞–∑–º–µ—â–∞–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä)
    uintptr_t base = (uintptr_t)&tss;
    uint64_t limit = sizeof(tss) - 1;

    uint64_t tss_desc = ((limit & 0xFFFF)) |
                        ((base & 0xFFFFFF) << 16) |
                        ((uint64_t)0x89 << 40) |
                        (((limit >> 16) & 0xF) << 48) |
                        (((base >> 24) & 0xFF) << 56);
    
    *((uint64_t*)&gdt[3]) = tss_desc;
    *((uint64_t*)&gdt[4]) = base >> 32;

    gdt_ptr.limit = sizeof(gdt) - 1;
    gdt_ptr.base = (uint64_t)&gdt;

    // –ó–∞–≥—Ä—É–∑–∫–∞ GDT –∏ TSS
    extern void gdt_flush(uint64_t);
    gdt_flush((uint64_t)&gdt_ptr);
}
```

---

#### `idt.c` ‚Äî –£—Å—Ç–∞–Ω–æ–≤–∫–∞ IDT

```c
#include <stdint.h>

struct IDTEntry {
    uint16_t offset_low;
    uint16_t selector;
    uint8_t  ist;
    uint8_t  type_attr;
    uint16_t offset_mid;
    uint32_t offset_high;
    uint32_t zero;
} __attribute__((packed));

struct IDTPointer {
    uint16_t limit;
    uint64_t base;
} __attribute__((packed));

#define IDT_SIZE 256
struct IDTEntry idt[IDT_SIZE];
struct IDTPointer idt_ptr;

void set_idt_entry(int i, void (*isr)(), uint8_t ist, uint8_t flags) {
    uint64_t addr = (uint64_t)isr;
    idt[i].offset_low = addr & 0xFFFF;
    idt[i].selector = 0x08;
    idt[i].ist = ist;
    idt[i].type_attr = flags;
    idt[i].offset_mid = (addr >> 16) & 0xFFFF;
    idt[i].offset_high = (addr >> 32) & 0xFFFFFFFF;
    idt[i].zero = 0;
}

extern void isr_stub();

void init_idt() {
    set_idt_entry(0x80, isr_stub, 0, 0x8E); // –ü—Ä–∏–º–µ—Ä: int 0x80 syscall
    idt_ptr.limit = sizeof(idt) - 1;
    idt_ptr.base = (uint64_t)&idt;
    extern void idt_flush(uint64_t);
    idt_flush((uint64_t)&idt_ptr);
}
```

---

#### `isr.S` ‚Äî Stub –¥–ª—è –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è

```asm
global isr_stub
isr_stub:
    cli
    push rax
    mov rax, 0xCAFEBABE
    ; –í—ã–≤–æ–¥ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –≤–∏–¥–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π —Ç–æ—á–∫–∏
    pop rax
    sti
    iretq
```

---

## –û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 8/10

–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ —Ä–∞–±–æ—Ç–∞ —Å –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∞–º–∏ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.

---

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è: 9 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è: 4 —á
* –ü—Ä–∞–∫—Ç–∏–∫–∞: 5 —á

---

## –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* –õ–µ–∫—Ü–∏—è —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–º–∏ —Å—Ö–µ–º–∞–º–∏ GDT/IDT/TSS.

* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ —ç–º—É–ª—è—Ç–æ—Ä (QEMU + G
