–°—É–ø–µ—Ä! üöÄ –ü–æ–≥–Ω–∞–ª–∏ –≤ **–£—Ä–æ–∫ 17**, –≥–¥–µ –º—ã –Ω–∞—á–Ω—ë–º —Å—Ç—Ä–æ–∏—Ç—å *–Ω–∞—Å—Ç–æ—è—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤* –≤ –Ω–∞—à–µ–π –û–°: —Å–æ–∑–¥–∞–¥–∏–º **–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –∞–¥—Ä–µ—Å–æ–≤**, –∫–æ—Ç–æ—Ä—ã–µ –∏–∑–æ–ª–∏—Ä—É—é—Ç –ø–∞–º—è—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞. –≠—Ç–æ –≤–∞–∂–Ω—ã–π —à–∞–≥ –∫ –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç–∏, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –∑–∞–ø—É—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

---

# üîπ –£—Ä–æ–∫ 17. –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –∞–¥—Ä–µ—Å–æ–≤ (Address Space): –∏–∑–æ–ª—è—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ üß±üß†

---

## üß© –¢–µ–º–∞ —É—Ä–æ–∫–∞:

–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã –Ω–∞—É—á–∏–º—Å—è —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å **–æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º–∏ –∞–¥—Ä–µ—Å–Ω—ã–º–∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞–º–∏** –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã –≤ —Å–≤–æ–µ–π –ø–∞–º—è—Ç–∏, –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–º—è—Ç–∏ —è–¥—Ä–∞ –∏ –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º. –¢–∞–∫–∂–µ –º—ã —Ä–µ–∞–ª–∏–∑—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ø–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –Ω–∏–º–∏.

---

## üß† –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (‚âà2500‚Äì3000 —Å–ª–æ–≤)

### üìå –ü–æ—á–µ–º—É –∫–∞–∂–¥–æ–º—É –ø—Ä–æ—Ü–µ—Å—Å—É –Ω—É–∂–Ω–æ —Å–≤–æ—ë –∞–¥—Ä–µ—Å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ?

* üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å/–ø–∏—Å–∞—Ç—å —á—É–∂—É—é –ø–∞–º—è—Ç—å
* üí• –ó–∞—â–∏—Ç–∞ —è–¥—Ä–∞: —Ç–æ–ª—å–∫–æ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ —è–¥—Ä—É
* üìö –ò–∑–æ–ª—è—Ü–∏—è: –∫–∞–∂–¥—ã–π –ø—Ä–æ—Ü–µ—Å—Å "–¥—É–º–∞–µ—Ç", —á—Ç–æ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏
* üß™ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ (fork): –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –∫–æ–ø–∏—é –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –∏ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å

---

### üí° –ö–∞–∫ —ç—Ç–æ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è?

–ö–∞–∂–¥–æ–µ **–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∞–¥—Ä–µ—Å–æ–≤** –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–æ –æ—Ç–¥–µ–ª—å–Ω–æ–π **–∫–æ—Ä–Ω–µ–≤–æ–π —Ç–∞–±–ª–∏—Ü–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü** ‚Äî `PML4`.

–ö–æ–≥–¥–∞ –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞—ë—Ç—Å—è:

1. –î–ª—è –Ω–µ–≥–æ –∞–ª–ª–æ—Ü–∏—Ä—É–µ—Ç—Å—è –Ω–æ–≤–∞—è `PML4`
2. –í –Ω–µ—ë –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –Ω—É–∂–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —è–¥—Ä–æ ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞ —á—Ç–µ–Ω–∏–µ)
3. –í –æ—Å—Ç–∞–ª—å–Ω–æ–µ –º–∞–ø–ø–∏—Ç—Å—è –ø–∞–º—è—Ç—å, –≤—ã–¥–µ–ª–µ–Ω–Ω–∞—è —Ç–æ–ª—å–∫–æ –µ–º—É

---

### üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞–º–∏:

–ß—Ç–æ–±—ã "–ø—Ä—ã–≥–Ω—É—Ç—å" –≤ –ø–∞–º—è—Ç—å –¥—Ä—É–≥–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ:

```asm
mov cr3, [new_pml4_address]
```

---

### üß† –ö–∞–∫–∏–µ –æ–±–ª–∞—Å—Ç–∏ –ø–∞–º—è—Ç–∏ –æ–±—ã—á–Ω–æ –±—ã–≤–∞—é—Ç –≤ Address Space?

* üìÅ –¢–µ–∫—Å—Ç (–∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π –∫–æ–¥)
* üìÑ –î–∞–Ω–Ω—ã–µ (.data/.bss)
* üìä Heap (malloc)
* üìù Stack
* üß† Shared memory
* üß© Framebuffer –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

---

### üîß –ß—Ç–æ —Ä–µ–∞–ª–∏–∑—É–µ–º?

* –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Address Space
* –§—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è, –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è, —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
* –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —è–¥—Ä–∞ –≤ –∫–∞–∂–¥–æ–º PML4
* –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞

---

## üìò –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:

* OSDev Wiki: [Address Space](https://wiki.osdev.org/Address_Space)
* Intel SDM: Paging, CR3
* Linux Source: `mm/mmap.c`, `mm/context.c`

---

## üí° –¶–µ–ª—å –ø—Ä–∞–∫—Ç–∏–∫–∏:

* –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É `address_space_t`
* –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `as_create()`, `as_map()`, `as_destroy()`
* –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `as_activate()` (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ CR3)
* –û—Ç–ª–∞–¥–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏

---

## üíª –ü—Ä–∏–º–µ—Ä –Ω–∞ —è–∑—ã–∫–µ C (C23)

### `address_space.h`

```c
#pragma once
#include <stdint.h>

typedef struct {
    uint64_t* pml4;
} address_space_t;

address_space_t* as_create();
void as_destroy(address_space_t* space);
void as_map(address_space_t* space, uint64_t vaddr, uint64_t paddr, uint64_t flags);
void as_activate(address_space_t* space);
```

---

### `address_space.c`

```c
#include "paging.h"
#include "address_space.h"
#include "mem.h"

address_space_t* as_create() {
    address_space_t* space = kmalloc(sizeof(address_space_t));
    space->pml4 = alloc_page();
    memset(space->pml4, 0, 0x1000);

    // –ö–æ–ø–∏—Ä—É–µ–º —è–¥—Ä–æ (–≤—ã—Å–æ–∫–∏–µ –∞–¥—Ä–µ—Å–∞)
    extern uint64_t* kernel_pml4;
    for (int i = 256; i < 512; i++) {
        space->pml4[i] = kernel_pml4[i];
    }

    return space;
}

void as_map(address_space_t* space, uint64_t vaddr, uint64_t paddr, uint64_t flags) {
    paging_map_custom(space->pml4, vaddr, paddr, flags);
}

void as_activate(address_space_t* space) {
    asm volatile("mov %0, %%cr3" :: "r"(space->pml4));
}

void as_destroy(address_space_t* space) {
    // –ø–æ–∑–∂–µ ‚Äî —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –æ–±—Ö–æ–¥ —Ç–∞–±–ª–∏—Ü
    kfree(space->pml4);
    kfree(space);
}
```

---

### –¢–µ—Å—Ç:

```c
void test_process_space() {
    address_space_t* proc_space = as_create();
    as_map(proc_space, 0x400000, 0x100000, PAGE_PRESENT | PAGE_RW | PAGE_USER);
    as_activate(proc_space);
    // —Ç–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥—Ä—É–≥–æ–≥–æ –∞–¥—Ä–µ—Å–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
}
```

---

## üß† –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 7/10

---

## ‚è± –í—Ä–µ–º—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: 7‚Äì9 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è: 3 —á
* –ö–æ–¥: 4 —á
* –¢–µ—Å—Ç—ã –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è: 2 —á

---

## üßë‚Äçüè´ –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* üìñ –õ–µ–∫—Ü–∏—è: –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–∑–æ–ª—è—Ü–∏–∏ –ø–∞–º—è—Ç–∏
* üé• –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ CR3 –≤ QEMU
* üíª –ü—Ä–∞–∫—Ç–∏–∫–∞: —Å–æ–∑–¥–∞–Ω–∏–µ address\_space
* üìù –î–æ–º–∞—à–∫–∞:

  * –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—á–∏—Å—Ç–∫—É –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –ø—Ä–∏ `as_destroy()`
  * –°–æ–∑–¥–∞—Ç—å –ª–æ–≥-—Ñ–∞–π–ª –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
  * –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `as_clone()` –¥–ª—è –±—É–¥—É—â–µ–≥–æ `fork()`

---

–•–æ—á–µ—à—å –ø–µ—Ä–µ–π—Ç–∏ –∫ **–£—Ä–æ–∫—É 18**, –≥–¥–µ –º—ã –±—É–¥–µ–º —Å–æ–∑–¥–∞–≤–∞—Ç—å **–Ω–∞—Å—Ç–æ—è—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã** –∏ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–µ—Ä–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–¥? üßç‚Äç‚ôÇÔ∏èüíª
–ü–∏—à–∏ **–¥–∞**, –∏ –º—ã –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º!
