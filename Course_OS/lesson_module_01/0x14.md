–û—Ç–ª–∏—á–Ω–æ, –¥–≤–∏–≥–∞–µ–º—Å—è –¥–∞–ª—å—à–µ! üåü
**–£—Ä–æ–∫ 14** ‚Äî —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π, –≤–µ–¥—å –º—ã –Ω–∞—á–Ω—ë–º –ø–∏—Å–∞—Ç—å **–ø–∞–º—è—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —è–¥—Ä–∞**. –ü–æ–≥–Ω–∞–ª–∏! üöÄ

---

# üîπ –£—Ä–æ–∫ 14. –§–∏–∑–∏—á–µ—Å–∫–∞—è –ø–∞–º—è—Ç—å –∏ –º–µ–Ω–µ–¥–∂–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏ —è–¥—Ä–∞

---

## üìö –¢–µ–º–∞ —É—Ä–æ–∫–∞:

–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã —É–∑–Ω–∞–µ–º, –∫–∞–∫ —è–¥—Ä–æ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –Ω–∞—Ö–æ–¥–∏—Ç, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç **—Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç—å—é**. –ú—ã —Ä–µ–∞–ª–∏–∑—É–µ–º **–º–µ–Ω–µ–¥–∂–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü (PMM)** ‚Äî –≤–∞–∂–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –≤—ã–¥–µ–ª—è—Ç—å –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç–∏. –≠—Ç–æ –±–∞–∑–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –±—É–¥–µ—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω –∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –ø–∞–º—è—Ç–∏, –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏.

---

## üß† –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (‚âà2500‚Äì3000 —Å–ª–æ–≤)

### üîç –ß—Ç–æ —Ç–∞–∫–æ–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è –ø–∞–º—è—Ç—å?

–§–∏–∑–∏—á–µ—Å–∫–∞—è –ø–∞–º—è—Ç—å ‚Äî —ç—Ç–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ RAM-—è—á–µ–π–∫–∏. –ß—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—ë –±–µ–∑–æ–ø–∞—Å–Ω–æ, –û–° –¥–æ–ª–∂–Ω–∞ –∑–Ω–∞—Ç—å:

* –ö–∞–∫–∏–µ —É—á–∞—Å—Ç–∫–∏ –ø–∞–º—è—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã
* –ö–∞–∫–∏–µ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –∏–ª–∏ BIOS
* –ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —è–¥—Ä–æ
* –ì–¥–µ —Å–≤–æ–±–æ–¥–Ω–∞—è –ø–∞–º—è—Ç—å

---

### üß© Multiboot / UEFI –∏ –∫–∞—Ä—Ç–∞ –ø–∞–º—è—Ç–∏

–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, **–∑–∞–≥—Ä—É–∑—á–∏–∫** (–Ω–∞–ø—Ä–∏–º–µ—Ä, GRUB2) –ø–µ—Ä–µ–¥–∞—ë—Ç —è–¥—Ä—É –∫–∞—Ä—Ç—É –ø–∞–º—è—Ç–∏ (Memory Map), —Å–æ–¥–µ—Ä–∂–∞—â—É—é —Å–ø–∏—Å–æ–∫ —Ä–µ–≥–∏–æ–Ω–æ–≤:

* `available`
* `reserved`
* `ACPI`
* `NVS`
* `bad memory`

–§–æ—Ä–º–∞—Ç –∫–∞—Ä—Ç—ã –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –¥–ª—è UEFI –∏ BIOS. –ù–∞ —Å—Ç–∞—Ä—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö ‚Äî **E820 Map**, –Ω–∞ –Ω–æ–≤—ã—Ö ‚Äî **UEFI Memory Map**.

---

### üß† –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä –ø–∞–º—è—Ç–∏?

–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–∞–º—è—Ç–∏ (Physical Memory Manager ‚Äî PMM) –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞:

* —É—á—ë—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü (4 –ö–ë)
* –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ —Å–≤–æ–±–æ–¥–Ω—ã—Ö
* –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –∑–∞–Ω—è—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
* –≤—ã–¥–µ–ª–µ–Ω–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è —Ç–∞–±–ª–∏—Ü —Å—Ç—Ä–∞–Ω–∏—Ü)

---

### üß± –ê–ª–≥–æ—Ä–∏—Ç–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è:

* **Bitmap** ‚Äî –∫–∞–∂–¥–æ–º—É 4 –ö–ë –±–ª–æ–∫—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç 1 –±–∏—Ç
* **Stack** ‚Äî —Å–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
* **Buddy system** ‚Äî —Å–ª–∏—è–Ω–∏–µ —Å–æ—Å–µ–¥–Ω–∏—Ö –±–ª–æ–∫–æ–≤ (–¥–ª—è –±–æ–ª—å—à–∏—Ö —É—á–∞—Å—Ç–∫–æ–≤)

---

### üß∞ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è bitmap-–º–µ–Ω–µ–¥–∂–µ—Ä–∞

–ï—Å–ª–∏ —É –Ω–∞—Å 1 –ì–ë –ø–∞–º—è—Ç–∏:

* –í—Å–µ–≥–æ —Å—Ç—Ä–∞–Ω–∏—Ü: 1 –ì–ë / 4 –ö–ë = **262144**
* Bitmap –∑–∞–π–º—ë—Ç 262144 –±–∏—Ç = **32768 –±–∞–π—Ç**

–û–±—ã—á–Ω–æ —Ä–∞–∑–º–µ—â–∞–µ—Ç—Å—è –≤ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ —è–¥—Ä–∞.

---

### üí° –ß—Ç–æ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å:

* –í—ã–¥–µ–ª–µ–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–∞–∫ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –∞–¥—Ä–µ—Å (64-–±–∏—Ç–Ω—ã–π)
* –í—ã –¥–æ–ª–∂–Ω—ã —É–º–µ—Ç—å –ø—Ä–æ–≤–µ—Ä—è—Ç—å: "–ê —ç—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–Ω—è—Ç–∞?"
* –Ø–¥—Ä–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Å–∞–º–æ —Å–µ–±—è üò±
* –ù—É–∂–Ω–æ —É—á–µ—Å—Ç—å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ, –¥–æ—Å—Ç—É–ø –∫ —Ñ–∏–∑. –∞–¥—Ä–µ—Å–∞–º –≤—ã—à–µ 4 –ì–ë

---

## üìò –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:

* OSDev: [Physical Memory Management](https://wiki.osdev.org/Physical_Memory_Management)
* Intel SDM: Memory Map –∏ Paging
* Linux Source Code: `mm/page_alloc.c`

---

## üí° –¶–µ–ª—å –ø—Ä–∞–∫—Ç–∏–∫–∏:

* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å bitmap-–º–µ–Ω–µ–¥–∂–µ—Ä
* –£–º–µ—Ç—å –≤—ã–¥–µ–ª—è—Ç—å –∏ –æ—Å–≤–æ–±–æ–∂–¥–∞—Ç—å –ø–∞–º—è—Ç—å
* –ù–µ —Ç—Ä–æ–≥–∞—Ç—å –ø–∞–º—è—Ç—å, –∑–∞–Ω—è—Ç—É—é —è–¥—Ä–æ–º

---

## üíª –ü—Ä–∏–º–µ—Ä –Ω–∞ —è–∑—ã–∫–µ C (C23)

---

### `pmm.c`

```c
#include <stdint.h>
#include <stddef.h>
#include <stdbool.h>

#define PAGE_SIZE 4096
#define MAX_PAGES 262144 // 1 –ì–ë

static uint8_t memory_bitmap[MAX_PAGES / 8];

#define BITMAP_INDEX(page) ((page) / 8)
#define BITMAP_OFFSET(page) ((page) % 8)

static inline void bitmap_set(uint32_t page) {
    memory_bitmap[BITMAP_INDEX(page)] |= (1 << BITMAP_OFFSET(page));
}

static inline void bitmap_clear(uint32_t page) {
    memory_bitmap[BITMAP_INDEX(page)] &= ~(1 << BITMAP_OFFSET(page));
}

static inline bool bitmap_test(uint32_t page) {
    return memory_bitmap[BITMAP_INDEX(page)] & (1 << BITMAP_OFFSET(page));
}

void* pmm_alloc_page() {
    for (uint32_t i = 0; i < MAX_PAGES; i++) {
        if (!bitmap_test(i)) {
            bitmap_set(i);
            return (void*)(i * PAGE_SIZE);
        }
    }
    return NULL; // –ü–∞–º—è—Ç—å –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å
}

void pmm_free_page(void* addr) {
    uint32_t page = (uint64_t)addr / PAGE_SIZE;
    bitmap_clear(page);
}
```

---

### `pmm_init.c`

```c
extern void* kernel_end; // –°–∏–º–≤–æ–ª –∫–æ–Ω—Ü–∞ —è–¥—Ä–∞

void pmm_init() {
    // –ó–∞–Ω–∏–º–∞–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –ø–æ—Ç–æ–º –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º "—Ö–æ—Ä–æ—à–∏–µ"
    for (uint32_t i = 0; i < MAX_PAGES; i++) {
        bitmap_set(i);
    }

    // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ Memory Map (–∑–∞–≥–ª—É—à–∫–∞)
    pmm_free_page((void*)0x100000); // –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ —è–¥—Ä–∞

    // –ó–∞–Ω–∏–º–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –∑–∞–Ω—è—Ç—ã–µ —è–¥—Ä–æ–º
    uint64_t kernel_pages = ((uint64_t)&kernel_end) / PAGE_SIZE;
    for (uint64_t i = 0; i <= kernel_pages; i++) {
        bitmap_set(i);
    }
}
```

---

## üß† –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 7/10

---

## ‚è± –í—Ä–µ–º—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: 8 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è: 3 —á
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: 5 —á

---

## üßë‚Äçüè´ –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* üìñ –õ–µ–∫—Ü–∏—è: Memory Map, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è bitmap
* üë®‚Äçüî¨ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –≤ QEMU: –æ—Ç–ª–∞–¥–∫–∞ bitmap
* üîß –ü—Ä–∞–∫—Ç–∏–∫–∞: —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
* üìù –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ:

  * –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—ã–≤–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
  * –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–∞–º—è—Ç–∏

---

–•–æ—á–µ—à—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫ **–£—Ä–æ–∫—É 15**? –ù–∞–ø–∏—à–∏ –ø—Ä–æ—Å—Ç–æ **¬´–¥–∞¬ª** üí¨
(—Ç–∞–º –Ω–∞—á–Ω—ë–º –¥–æ–±–∞–≤–ª—è—Ç—å **–≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –∞–ª–ª–æ–∫–∞—Ü–∏—é** –∏ `malloc`) üß†üì¶
