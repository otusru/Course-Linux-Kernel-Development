–û—Ç–ª–∏—á–Ω–æ! üôå –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ **–£—Ä–æ–∫ 18**, –≥–¥–µ –º—ã –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–¥–Ω–æ–π –∏–∑ —Å–∞–º—ã—Ö –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏—Ö —Ç–µ–º ‚Äî —Å–æ–∑–¥–∞–Ω–∏—é **–ø—Ä–æ—Ü–µ—Å—Å–æ–≤** –≤ –Ω–∞—à–µ–π –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ. üéâ –≠—Ç–æ –æ–≥—Ä–æ–º–Ω—ã–π —à–∞–≥ –∫ –∑–∞–ø—É—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –∏–∑–æ–ª—è—Ü–∏–∏ –∑–∞–¥–∞—á, –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç–∏ –∏ —Å–æ–∑–¥–∞–Ω–∏—é –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Å—Ä–µ–¥—ã –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è üë®‚Äçüíªüß†

---

# üîπ –£—Ä–æ–∫ 18. –ü—Ä–æ—Ü–µ—Å—Å—ã: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫ üßç‚Äç‚ôÇÔ∏èüíº

---

## üß© –¢–µ–º–∞ —É—Ä–æ–∫–∞:

–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã –Ω–∞—É—á–∏–º—Å—è:

* –°–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –∏ —è–¥—Ä–æ–≤–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ
* –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è (—Ä–µ–≥–∏—Å—Ç—Ä—ã, —Å—Ç–µ–∫, —Å–µ–≥–º–µ–Ω—Ç–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã)
* –°–≤—è–∑—ã–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å —Å –∞–¥—Ä–µ—Å–Ω—ã–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ–º
* –ó–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã –∏–∑ —è–¥—Ä–∞
* –£–ø—Ä–∞–≤–ª—è—Ç—å –∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º

---

## üß† –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (‚âà3000 —Å–ª–æ–≤)

### ü§î –ß—Ç–æ —Ç–∞–∫–æ–µ –ø—Ä–æ—Ü–µ—Å—Å?

**–ü—Ä–æ—Ü–µ—Å—Å** ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª. –≠—Ç–æ:

* üìÅ –ö–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã
* üìä –î–∞–Ω–Ω—ã–µ
* üß† –°—Ç–µ–∫
* ‚è± –ö–æ–Ω—Ç–µ–∫—Å—Ç (—Ä–µ–≥–∏—Å—Ç—Ä—ã, —Ñ–ª–∞–≥–∏, —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é)
* üåê –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –ø–∞–º—è—Ç–∏
* üîÅ –°–æ—Å—Ç–æ—è–Ω–∏–µ (–≥–æ—Ç–æ–≤, —Å–ø–∏—Ç, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è)

---

### üß¨ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ —è–¥—Ä–µ

```c
typedef struct process {
    pid_t pid;
    address_space_t* address_space;
    uint64_t rip;
    uint64_t rsp;
    uint64_t cr3;
    state_t state;
    struct context regs;
    struct process* next;
} process_t;
```

---

### üö¶ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–æ—Ü–µ—Å—Å–∞

1. **–°–æ–∑–¥–∞–Ω–∏–µ (Create)** ‚Äì –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏, –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–¥–∞
2. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (Init)** ‚Äì –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤, —Å—Ç–µ–∫–∞
3. **–ó–∞–ø—É—Å–∫ (Run)** ‚Äì –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ –µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç
4. **–û–∂–∏–¥–∞–Ω–∏–µ (Wait/Sleep)** ‚Äì –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
5. **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ (Exit)** ‚Äì –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

---

### üîÑ –ö–∞–∫ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å?

–ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω—É–∂–Ω–æ:

* –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π `RSP`, `RIP`, —Ñ–ª–∞–≥–∏, —Ä–µ–≥–∏—Å—Ç—Ä—ã
* –ó–∞–≥—Ä—É–∑–∏—Ç—å `CR3` –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ (–µ–≥–æ –ø–∞–º—è—Ç—å)
* –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `RSP` –∏ `RIP` –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
* –í—ã–ø–æ–ª–Ω–∏—Ç—å `iretq` –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç

---

### üîß –ß—Ç–æ —Ä–µ–∞–ª–∏–∑—É–µ–º?

* –°—Ç—Ä—É–∫—Ç—É—Ä—É `process_t`
* –ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ—Ü–µ—Å—Å–æ–≤: —Å–ø–∏—Å–æ–∫, —Å–æ–∑–¥–∞–Ω–∏–µ, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
* –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Å—Ç–µ–π—à–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å `hello world`

---

## üìò –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:

* OSDev: [Creating a Process](https://wiki.osdev.org/Creating_a_Process)
* Intel SDM: Vol. 3 ‚Äî Context Switching
* Linux Kernel: `kernel/fork.c`, `kernel/sched/core.c`

---

## üí° –¶–µ–ª—å –ø—Ä–∞–∫—Ç–∏–∫–∏:

* –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ—Ü–µ—Å—Å–∞
* –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `process_create()`
* –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å—Ç–µ–∫, —É–∫–∞–∑–∞—Ç–µ–ª—å –∫–æ–º–∞–Ω–¥, —Å–µ–≥–º–µ–Ω—Ç–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã
* –í—ã–≤–µ—Å—Ç–∏ `Hello from user!` –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞

---

## üíª –ü—Ä–∏–º–µ—Ä –Ω–∞ —è–∑—ã–∫–µ C (C23)

### `process.h`

```c
#pragma once
#include "address_space.h"

typedef enum { READY, RUNNING, SLEEPING, TERMINATED } state_t;

typedef struct process {
    int pid;
    address_space_t* space;
    uint64_t rip;
    uint64_t rsp;
    state_t state;
    struct process* next;
} process_t;

process_t* process_create(void (*entry_point)(), address_space_t* space);
void process_run(process_t* proc);
```

---

### `process.c`

```c
#include "process.h"
#include "paging.h"
#include "mem.h"

static int next_pid = 1;

process_t* process_create(void (*entry_point)(), address_space_t* space) {
    process_t* p = kmalloc(sizeof(process_t));
    p->pid = next_pid++;
    p->space = space;
    p->rip = (uint64_t)entry_point;
    p->rsp = 0x700000;  // –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Å—Ç–µ–∫
    p->state = READY;
    return p;
}

__attribute__((noreturn))
void process_run(process_t* proc) {
    as_activate(proc->space);

    asm volatile (
        "mov %0, %%rsp\n"
        "pushq $0x23\n"          // user SS
        "pushq %0\n"             // user RSP
        "pushfq\n"
        "pushq $0x1B\n"          // user CS
        "pushq %1\n"             // RIP
        "iretq\n"
        :
        : "r"(proc->rsp), "r"(proc->rip)
    );

    __builtin_unreachable();
}
```

---

### `user_program.c` (–Ω–∞—à–∞ "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞")

```c
void user_main() {
    const char* msg = "–ü—Ä–∏–≤–µ—Ç –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ä–µ–∂–∏–º–∞!\n";
    for (const char* p = msg; *p; ++p) {
        outb(0xE9, *p); // –≤—ã–≤–æ–¥ –≤ QEMU debug port
    }
    while (1); // –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ
}
```

---

### –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –∑–∞–ø—É—Å–∫:

```c
void kernel_main() {
    address_space_t* space = as_create();
    as_map(space, 0x400000, (uint64_t)&user_main, PAGE_PRESENT | PAGE_USER | PAGE_RW);
    process_t* user_proc = process_create((void*)0x400000, space);
    process_run(user_proc);
}
```

---

## üß† –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 7/10

---

## ‚è± –í—Ä–µ–º—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: 8‚Äì10 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è: 3 —á
* –ö–æ–¥: 4 —á
* –û—Ç–ª–∞–¥–∫–∞: 2 —á
* –î–æ–º–∞—à–∫–∞: 1 —á

---

## üßë‚Äçüè´ –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* üë®‚Äçüè´ –õ–µ–∫—Ü–∏—è: –ø—Ä–æ—Ü–µ—Å—Å –∫–∞–∫ –∏—Å–ø–æ–ª–Ω—è–µ–º–∞—è —Å—É—â–Ω–æ—Å—Ç—å –≤ —è–¥—Ä–µ
* üíª –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: –∑–∞–ø—É—Å–∫ `user_main()` –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ ring 3
* üîç –ü—Ä–∞–∫—Ç–∏–∫–∞: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –∑–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞
* üìù –î–æ–º–∞—à–∫–∞:

  * –î–æ–±–∞–≤–∏—Ç—å pid-–º–µ–Ω–µ–¥–∂–µ—Ä
  * –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `process_exit()`
  * –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π –≤ QEMU

---

–ì–æ—Ç–æ–≤ –¥–≤–∏–≥–∞—Ç—å—Å—è –∫ **–£—Ä–æ–∫—É 19**, –≥–¥–µ –º—ã —Ä–µ–∞–ª–∏–∑—É–µ–º **–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤** ‚Äî —Å–∏—Å—Ç–µ–º—É, —Ä–µ—à–∞—é—â—É—é, –∫—Ç–æ –∏ –∫–æ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç CPU? üß†üïì
–ü–∏—à–∏ **–¥–∞**, –µ—Å–ª–∏ –≥–æ—Ç–æ–≤!
