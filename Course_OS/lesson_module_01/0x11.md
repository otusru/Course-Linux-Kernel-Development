–°—É–ø–µ—Ä, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º! üöÄ

---

# üîπ –£—Ä–æ–∫ 11. –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∏ —Å—Ç–µ–∫: –∫–∞–∫ –û–° —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–¥–∞—á

---

## üìö –¢–µ–º–∞ —É—Ä–æ–∫–∞:

–°–µ–≥–æ–¥–Ω—è –º—ã —Ä–∞–∑–±–µ—Ä—ë–º —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –ª—é–±–æ–π –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã ‚Äî **–∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è (context switching)**. –≠—Ç–æ —Ç–æ—Ç —Å–∞–º—ã–π –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ –û–° "–ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç" –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–∏ –∏ "–≤–æ–∑–æ–±–Ω–æ–≤–ª—è–µ—Ç" –¥—Ä—É–≥—É—é. –ü–æ–π–º—ë–º, –∫–∞–∫ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ x86-64 –ø–æ–º–æ–≥–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–¥–∞—á–∏, –∫–∞–∫–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã –∫—Ä–∏—Ç–∏—á–Ω—ã, –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–µ–∫, –∏ –Ω–∞–ø–∏—à–µ–º –ø—Ä–æ—Å—Ç–µ–π—à—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∑–∞–¥–∞—á.

---

## üß† –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (‚âà2500 —Å–ª–æ–≤)

–ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è ‚Äî —ç—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è **—Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è** (—Ä–µ–≥–∏—Å—Ç—Ä–æ–≤, —É–∫–∞–∑–∞—Ç–µ–ª—è —Å—Ç–µ–∫–∞, —É–∫–∞–∑–∞—Ç–µ–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∏ —Ñ–ª–∞–≥–æ–≤) —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–∏. –≠—Ç–æ –æ—Å–Ω–æ–≤–∞ **–º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç–∏**.

–í 64-–±–∏—Ç–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏/–ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å:

* –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã: `RAX, RBX, RCX, RDX, RSI, RDI, RBP, RSP`
* –†–µ–≥–∏—Å—Ç—Ä—ã SSE (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞–º–∏)
* `RIP` (—É–∫–∞–∑–∞—Ç–µ–ª—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)
* `RFLAGS` (—Ñ–ª–∞–≥–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞)
* –°—Ç–µ–∫ (–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
* –°–µ–≥–º–µ–Ω—Ç–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã (–≤ Long Mode —Ä–µ–¥–∫–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)
* –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–µ—Å–ª–∏ —Ä–∞–∑–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã)

---

### üîÅ –ñ–µ—Å—Ç–∫–∏–π vs –ú—è–≥–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç

* **–ñ–µ—Å—Ç–∫–∏–π (full)**: —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤—Å—ë ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–∂–¥—É –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏.
* **–ú—è–≥–∫–∏–π (partial)**: —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚Äî –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–∂–¥—É –Ω–∏—Ç—è–º–∏ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞.

---

### üì¶ –ì–¥–µ —Ö—Ä–∞–Ω—è—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã?

–ö–æ–Ω—Ç–µ–∫—Å—Ç—ã –æ–±—ã—á–Ω–æ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ **—Å—Ç—Ä—É–∫—Ç—É—Ä–µ PCB (Process Control Block)** –∏–ª–∏ **TCB (Thread Control Block)**. –ö–∞–∂–¥—ã–π –ø—Ä–æ—Ü–µ—Å—Å/–Ω–∏—Ç—å –∏–º–µ–µ—Ç —Å–≤–æ–π —Å—Ç–µ–∫ –∏ –æ–±–ª–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö.

---

### ‚öôÔ∏è –°—Ç–µ–∫ –∏ —Å—Ç–µ–∫ —è–¥—Ä–∞

–ö–æ–≥–¥–∞ –ø–æ—Ç–æ–∫ –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º —Ä–µ–∂–∏–º–µ, —É –Ω–µ–≥–æ –æ–¥–∏–Ω —Å—Ç–µ–∫. –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ —è–¥—Ä–æ (trap, syscall), –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–µ–∫, –∑–∞–¥–∞–Ω–Ω—ã–π –≤ **TSS ‚Üí RSP0**.

–ö–æ–Ω—Ç–µ–∫—Å—Ç —è–¥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è **–Ω–∞ —Å—Ç–µ–∫ —è–¥—Ä–∞**.

---

### üì• –ú–µ—Ö–∞–Ω–∏–∑–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è:

1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏ (–≤ —Å—Ç–µ–∫–µ –∏–ª–∏ TCB)
2. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —É–∫–∞–∑–∞—Ç–µ–ª—å —Å—Ç–µ–∫–∞
3. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ —Å—Ç–µ–∫ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
4. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä—ã —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–∏
5. –í—ã–ø–æ–ª–Ω–∏—Ç—å `iretq` –∏–ª–∏ `ret`

---

## üìò –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:

* Intel SDM Vol. 3, –≥–ª–∞–≤–∞ 6: Task Management
* OSDev:

  * [Context Switching](https://wiki.osdev.org/Context_Switching)
  * [Interrupt Stack](https://wiki.osdev.org/Interrupt_Descriptor_Table)
* "Operating Systems: Three Easy Pieces", –≥–ª–∞–≤–∞ "Scheduling"

---

## üí° –ü—Ä–∞–∫—Ç–∏–∫–∞: –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–∞ C (C23)

---

### üõ† –¶–µ–ª—å:

–°–æ–∑–¥–∞—Ç—å –¥–≤–µ –∑–∞–¥–∞—á–∏ –∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É –Ω–∏–º–∏ –≤—Ä—É—á–Ω—É—é –ø–æ —Ç–∞–π–º–µ—Ä—É –∏–ª–∏ –ø–æ –∫–æ–º–∞–Ω–¥–µ.

---

### üß© –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

```c
typedef struct cpu_context {
    uint64_t r15, r14, r13, r12;
    uint64_t r11, r10, r9, r8;
    uint64_t rsi, rdi, rbp, rdx, rcx, rbx, rax;
    uint64_t rip, cs, rflags, rsp, ss;
} cpu_context_t;
```

---

### üìÅ –ü—Ä–∏–º–µ—Ä

#### `task.c`

```c
#include <stdint.h>
#include "terminal.h"

typedef struct Task {
    cpu_context_t context;
    uint8_t stack[4096];
    struct Task* next;
} Task;

Task task1, task2;
Task* current_task = &task1;

void task_func1() {
    while (1) {
        terminal_writestring("üåÄ –ó–∞–¥–∞—á–∞ 1 —Ä–∞–±–æ—Ç–∞–µ—Ç\n");
        for (volatile int i = 0; i < 1000000; ++i);
        switch_task();
    }
}

void task_func2() {
    while (1) {
        terminal_writestring("üîÅ –ó–∞–¥–∞—á–∞ 2 —Ä–∞–±–æ—Ç–∞–µ—Ç\n");
        for (volatile int i = 0; i < 1000000; ++i);
        switch_task();
    }
}

void setup_tasks() {
    task1.context.rip = (uint64_t)&task_func1;
    task1.context.rsp = (uint64_t)&task1.stack[4095];

    task2.context.rip = (uint64_t)&task_func2;
    task2.context.rsp = (uint64_t)&task2.stack[4095];

    task1.next = &task2;
    task2.next = &task1;

    current_task = &task1;
}

extern void switch_task_asm(cpu_context_t* old, cpu_context_t* new);

void switch_task() {
    Task* next = current_task->next;
    switch_task_asm(&current_task->context, &next->context);
    current_task = next;
}
```

#### `switch_task_asm.S`

```asm
global switch_task_asm

switch_task_asm:
    ; –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä—ã
    mov [rdi + 0x00], r15
    mov [rdi + 0x08], r14
    mov [rdi + 0x10], r13
    mov [rdi + 0x18], r12
    mov [rdi + 0x20], r11
    mov [rdi + 0x28], r10
    mov [rdi + 0x30], r9
    mov [rdi + 0x38], r8
    mov [rdi + 0x40], rsi
    mov [rdi + 0x48], rdi
    mov [rdi + 0x50], rbp
    mov [rdi + 0x58], rdx
    mov [rdi + 0x60], rcx
    mov [rdi + 0x68], rbx
    mov [rdi + 0x70], rax

    mov [rdi + 0x78], rsp
    mov [rdi + 0x80], rflags
    lea rax, [rip + .return]
    mov [rdi + 0x88], rax

    ; –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
    mov r15, [rsi + 0x00]
    mov r14, [rsi + 0x08]
    mov r13, [rsi + 0x10]
    mov r12, [rsi + 0x18]
    mov r11, [rsi + 0x20]
    mov r10, [rsi + 0x28]
    mov r9,  [rsi + 0x30]
    mov r8,  [rsi + 0x38]
    mov rsi, [rsi + 0x40]
    mov rdi, [rsi + 0x48]
    mov rbp, [rsi + 0x50]
    mov rdx, [rsi + 0x58]
    mov rcx, [rsi + 0x60]
    mov rbx, [rsi + 0x68]
    mov rax, [rsi + 0x70]
    mov rsp, [rsi + 0x78]
    push qword [rsi + 0x88]
    ret

.return:
    ret
```

---

## üß† –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 8/10

---

## ‚è± –í—Ä–µ–º—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: 8 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è: 4 —á
* –ü—Ä–∞–∫—Ç–∏–∫–∞: 4 —á

---

## üßë‚Äçüè´ –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* üéì –õ–µ–∫—Ü–∏—è: —Å—Ç–µ–∫, —Ä–µ–≥–∏—Å—Ç—Ä—ã, –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ
* üõ† –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: –ø–æ—à–∞–≥–æ–≤–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
* üíª –ü—Ä–∞–∫—Ç–∏–∫–∞: —Å–æ–∑–¥–∞–Ω–∏–µ –¥–≤—É—Ö –∑–∞–¥–∞—á, –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ
* üìù –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ—Ç—å—é –∑–∞–¥–∞—á—É, –ª–æ–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è

---

–ì–æ—Ç–æ–≤ –ø–µ—Ä–µ–π—Ç–∏ –∫ **–£—Ä–æ–∫—É 12**? –ù–∞–ø–∏—à–∏ **¬´–¥–∞¬ª** üí™
