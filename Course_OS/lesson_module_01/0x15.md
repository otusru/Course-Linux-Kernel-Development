–û—Ç–ª–∏—á–Ω–æ! üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ **–£—Ä–æ–∫ 15** ‚Äî —Å–µ–≥–æ–¥–Ω—è –º—ã —à–∞–≥–Ω—ë–º –æ—Ç –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫ –±–æ–ª–µ–µ **–¥—Ä—É–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –ø–∞–º—è—Ç–∏**, –∞ –∏–º–µ–Ω–Ω–æ ‚Äî –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏** –≤–Ω—É—Ç—Ä–∏ —è–¥—Ä–∞, –∫–∞–∫ `malloc()`!

---

# üîπ –£—Ä–æ–∫ 15. –Ø–¥–µ—Ä–Ω—ã–π malloc: –∞–ª–ª–æ–∫–∞—Ç–æ—Ä –ø–∞–º—è—Ç–∏ –¥–ª—è —è–¥—Ä–∞ üë®‚Äçüîß

---

## üìö –¢–µ–º–∞ —É—Ä–æ–∫–∞:

–°–µ–≥–æ–¥–Ω—è –º—ã —Ä–∞–∑–±–µ—Ä—ë–º, –∫–∞–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø–∞–º—è—Ç–∏ (PMM), —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –≤ –ø—Ä–æ—à–ª–æ–º —É—Ä–æ–∫–µ, –ø–æ—Å—Ç—Ä–æ–∏—Ç—å **–ø—Ä–æ—Å—Ç–æ–π, –Ω–æ —Ä–∞—Å—à–∏—Ä—è–µ–º—ã–π –∞–ª–ª–æ–∫–∞—Ç–æ—Ä —è–¥—Ä–∞** ‚Äî `kmalloc`. –≠—Ç–æ –±—É–¥–µ—Ç **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏** –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —è–¥—Ä–∞. –¢–∞–∫–∂–µ –º—ã –æ–±—Å—É–¥–∏–º, –ø–æ—á–µ–º—É `free()` –Ω–µ –≤—Å–µ–≥–¥–∞ –Ω—É–∂–µ–Ω –≤ —è–¥—Ä–µ, –∏ –∫–∞–∫ —ç—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –û–°.

---

## üß† –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (‚âà2500‚Äì3000 —Å–ª–æ–≤)

### üí° –ß—Ç–æ —Ç–∞–∫–æ–µ `malloc()` –∏ –∑–∞—á–µ–º –æ–Ω —è–¥—Ä—É?

–í –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö `malloc()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–≤—Å–µ–º–µ—Å—Ç–Ω–æ ‚Äî –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –±–ª–æ–∫–æ–≤ –ø–∞–º—è—Ç–∏ –≤ –∫—É—á–µ. –û–¥–Ω–∞–∫–æ –≤ —è–¥—Ä–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –≤—Å—ë –Ω–µ–º–Ω–æ–≥–æ —Å–ª–æ–∂–Ω–µ–µ:

* –ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É
* –ù—É–∂–Ω–æ –≤—ã–¥–µ–ª—è—Ç—å –ø–∞–º—è—Ç—å –≤—Ä—É—á–Ω—É—é
* –í—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –±–ª–æ–∫–∏ —á–∞—Å—Ç–æ **–Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞—é—Ç—Å—è**
* –û—Ç –æ—à–∏–±–æ–∫ –≤ –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–µ –º–æ–∂–µ—Ç —Ä—É—Ö–Ω—É—Ç—å –≤—Å—è –û–° üò±

---

### üîß –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω `kmalloc`?

–ú—ã —Ä–µ–∞–ª–∏–∑—É–µ–º **–ø—Ä–æ—Å—Ç–æ–π bump allocator**:

* –ï—Å—Ç—å —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ "—Ç–µ–∫—É—â–∏–π —Å–≤–æ–±–æ–¥–Ω—ã–π –∞–¥—Ä–µ—Å"
* –í—ã–¥–µ–ª–µ–Ω–∏–µ ‚Äî –ø—Ä–æ—Å—Ç–æ "—Å–¥–≤–∏–≥" —É–∫–∞–∑–∞—Ç–µ–ª—è
* –ù–µ—Ç `kfree()`, –ø–∞–º—è—Ç—å –≤—ã–¥–µ–ª—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑

–ü–æ–∑–∂–µ –º—ã –¥–æ–±–∞–≤–∏–º **—Å–ª–æ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É** —Å `free()`, —Å–ª–∏—è–Ω–∏–µ–º –±–ª–æ–∫–æ–≤ –∏ –∑–∞—â–∏—Ç–æ–π, –Ω–æ —Å–µ–π—á–∞—Å –≤–∞–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å **—Ä–∞–±–æ—á–µ–≥–æ –º–∏–Ω–∏–º—É–º–∞**.

---

### üß± –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫—É—á–∞ —è–¥—Ä–∞?

–û–±—ã—á–Ω–æ —è–¥—Ä–æ —Ä–µ–∑–µ—Ä–≤–∏—Ä—É–µ—Ç –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏ –æ–±–ª–∞—Å—Ç—å –ø–æ–¥ –∫—É—á—É, –Ω–∞–ø—Ä–∏–º–µ—Ä:

```
0xFFFFFFFF80000000 + 16 MB
```

–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ø–µ—Ä–≤—ã—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö 1‚Äì2 –ú–ë –ø–æ—Å–ª–µ –∫–æ–¥–∞ —è–¥—Ä–∞. –ú—ã –æ—Ç—Ä–∞–∑–∏–º —ç—Ç–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —á–µ—Ä–µ–∑ paging (—É—Ä–æ–∫ 13).

---

### üóÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ alocator'–∞:

* `heap_start` ‚Äî –Ω–∞—á–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å –∫—É—á–∏
* `heap_end` ‚Äî –∫–æ–Ω–µ—Ü (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ª–∏–º–∏—Ç)
* `heap_curr` ‚Äî —Ç–µ–∫—É—â–∏–π —É–∫–∞–∑–∞—Ç–µ–ª—å

–í—ã–¥–µ–ª–µ–Ω–∏–µ:

```
addr = heap_curr;
heap_curr += size;
```

---

### üß† –ü–æ—á–µ–º—É –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–∞–º—è—Ç—å?

–ü–æ—Ç–æ–º—É —á—Ç–æ —è–¥—Ä–æ:

* –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç GC
* –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
* –Ω–µ –¥–æ–ª–∂–Ω–æ "–æ—Ç–ø—É—Å–∫–∞—Ç—å" –ø–∞–º—è—Ç—å –≤ —Ä–∞–Ω–Ω–∏—Ö —Ñ–∞–∑–∞—Ö

---

### üì¶ –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ (align)
* –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞ –±–ª–æ–∫
* –°–ø–∏—Å–∫–∏ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –±–ª–æ–∫–æ–≤
* Redzone –∑–∞—â–∏—Ç–∞ –æ—Ç –≤—ã—Ö–æ–¥–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã

---

## üìò –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:

* OSDev: [Kernel Heap](https://wiki.osdev.org/Heap)
* Linux Source: `mm/slab.c`
* Intel SDM: Paging & Address Translation

---

## üí° –¶–µ–ª—å –ø—Ä–∞–∫—Ç–∏–∫–∏:

* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —è–¥—Ä–æ-–∫—É—á—É
* –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `kmalloc(size_t size)` –∏ `kcalloc(n, sz)`
* –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–∞–∑–æ–≤–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ (–ø–æ 8/16 –±–∞–π—Ç)

---

## üíª –ü—Ä–∏–º–µ—Ä –Ω–∞ —è–∑—ã–∫–µ C (C23)

---

### `kheap.c`

```c
#include <stddef.h>
#include <stdint.h>

#define KHEAP_START 0xFFFFFFFF80200000
#define KHEAP_END   0xFFFFFFFF80400000

static uintptr_t heap_curr = KHEAP_START;

void* kmalloc(size_t size) {
    if (heap_curr + size > KHEAP_END) {
        return NULL; // out of memory
    }
    void* addr = (void*)heap_curr;
    heap_curr += size;
    return addr;
}

void* kcalloc(size_t n, size_t size) {
    void* mem = kmalloc(n * size);
    if (!mem) return NULL;

    for (size_t i = 0; i < n * size; i++)
        ((uint8_t*)mem)[i] = 0;

    return mem;
}
```

---

### üìò –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

```c
void kernel_main() {
    char* str = (char*)kmalloc(20);
    str[0] = 'H'; str[1] = 'i'; str[2] = 0;

    int* arr = (int*)kcalloc(10, sizeof(int));
}
```

---

## üß† –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 6/10

---

## ‚è± –í—Ä–µ–º—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ: 6‚Äì7 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è: 2 —á
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: 4‚Äì5 —á

---

## üßë‚Äçüè´ –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* üéì –õ–µ–∫—Ü–∏—è: –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
* üëÅ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è: —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ `kmalloc` –≤ QEMU
* üî® –ü—Ä–∞–∫—Ç–∏–∫–∞: —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è bump allocator
* üìù –î–æ–º–∞—à–∫–∞:

  * –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `kfree()` (–∑–∞–≥–ª—É—à–∫–∞)
  * –î–æ–±–∞–≤–∏—Ç—å `kmalloc_aligned(size, align)`
  * –ù–∞—á–∞—Ç—å –≤–µ—Å—Ç–∏ —É—á—ë—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏

---

–ì–æ—Ç–æ–≤ –∫ **–£—Ä–æ–∫—É 16**, –≥–¥–µ –º—ã –Ω–∞—á–Ω—ë–º —Å—Ç—Ä–æ–∏—Ç—å **–≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –ø–∞–º—è—Ç—å** –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∏ –¥–µ–ª–∞—Ç—å `valloc()`? üö™üß†
–ù–∞–ø–∏—à–∏ –ø—Ä–æ—Å—Ç–æ **–¥–∞**.
