–û—Ç–ª–∏—á–Ω–æ, –¥–≤–∏–≥–∞–µ–º—Å—è –¥–∞–ª—å—à–µ! üöÄ

---

# üîπ –£—Ä–æ–∫ 8. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –≤ Long Mode (x86-64): –ø—É—Ç—å –∫ 64-–±–∏—Ç–Ω–æ–π –û–°

---

## –ö—Ä–∞—Ç–∫–æ–µ —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (‚âà2500 —Å–ª–æ–≤)

64-–±–∏—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã —Å–µ–≥–æ–¥–Ω—è ‚Äî —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç. –ü–æ—á—Ç–∏ –≤—Å–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ–º–ø—å—é—Ç–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É x86-64 (–∏–ª–∏ AMD64), –∏ —á—Ç–æ–±—ã –û–° –º–æ–≥–ª–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ 64-–±–∏—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ, –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ (Real Mode) ‚Üí –≤ –∑–∞—â–∏—â—ë–Ω–Ω—ã–π (Protected Mode) ‚Üí –∏ –¥–∞–ª–µ–µ –≤ —Ç–∞–∫ –Ω–∞–∑—ã–≤–∞–µ–º—ã–π Long Mode.

–≠—Ç–æ—Ç —É—Ä–æ–∫ –ø–æ—Å–≤—è—â—ë–Ω –æ–¥–Ω–æ–º—É –∏–∑ —Å–∞–º—ã—Ö –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ 64-–±–∏—Ç–Ω–æ–π –û–° ‚Äî –ø–µ—Ä–µ—Ö–æ–¥—É –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –≤ Long Mode. –≠—Ç–æ –≤–∞–∂–Ω–æ –ø–æ—Ç–æ–º—É, —á—Ç–æ —Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ –¥–æ—Å—Ç—É–ø–Ω—ã 64-–±–∏—Ç–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã, –∞–¥—Ä–µ—Å–∞—Ü–∏—è –±–æ–ª—å—à–æ–≥–æ –æ–±—ä—ë–º–∞ –ø–∞–º—è—Ç–∏ (–±–æ–ª–µ–µ 4 –ì–ë), –∞ —Ç–∞–∫–∂–µ –∞–ø–ø–∞—Ä–∞—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π, —Ç–∞–∫–∏—Ö –∫–∞–∫ NX bit, –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è, SMEP, SMAP –∏ –ø—Ä–æ—á–∏–µ.

---

### –≠—Ç–∞–ø—ã –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ Long Mode

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ x86 —Ç—Ä–µ–±—É–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ä–µ–∂–∏–º–æ–≤:

1. **Real Mode (16 –±–∏—Ç)** ‚Äî —Ä–µ–∂–∏–º –ø–æ—Å–ª–µ –≤–∫–ª—é—á–µ–Ω–∏—è –ø–∏—Ç–∞–Ω–∏—è.
2. **Protected Mode (32 –±–∏—Ç)** ‚Äî –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–µ–≥–º–µ–Ω—Ç–Ω—É—é –∑–∞—â–∏—Ç—É –∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –ø–∞–º—è—Ç—å.
3. **Long Mode (64 –±–∏—Ç)** ‚Äî –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç 64-–±–∏—Ç–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã –∏ –ª–∏–Ω–µ–π–Ω—É—é –ø–∞–º—è—Ç—å.

–î–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ Long Mode:

* –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å **Page Tables**, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–µ 64-–±–∏—Ç–Ω—É—é –∞–¥—Ä–µ—Å–∞—Ü–∏—é.
* –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å **Physical Address Extension (PAE)**.
* –ù–∞—Å—Ç—Ä–æ–∏—Ç—å GDT —Å 64-–±–∏—Ç–Ω—ã–º–∏ —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏.
* –í–∫–ª—é—á–∏—Ç—å **LME (Long Mode Enable)** —á–µ—Ä–µ–∑ MSR (Model-Specific Register).
* –ó–∞—Ç–µ–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –±–∏—Ç PG (Paging) –∏ PE (Protection Enable) –≤ CR0.

---

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ Long Mode

* **–°–µ–≥–º–µ–Ω—Ç–Ω–∞—è –º–æ–¥–µ–ª—å** –≤ Long Mode –ø–æ—á—Ç–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è. –°–µ–≥–º–µ–Ω—Ç—ã –∏–º–µ—é—Ç –±–∞–∑—É = 0 –∏ –¥–ª–∏–Ω—É = –≤—Å—è –ø–∞–º—è—Ç—å.
* –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–æ–≤—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã: RAX, RSP, RBP, RDI, RSI, –∏ —Ç.–¥.
* –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è 64-–±–∏—Ç–Ω—ã–µ –∞–¥—Ä–µ—Å–∞: –¥–æ 256 –¢–ë –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –∞–¥—Ä–µ—Å–∞—Ü–∏–∏.
* –ù–µ–æ–±—Ö–æ–¥–∏–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–∞–±–ª–∏—Ü —Å—Ç—Ä–∞–Ω–∏—Ü: **PML4 ‚Üí PDPTE ‚Üí PDE ‚Üí PTE**.

---

### –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ?

–ü–µ—Ä–µ—Ö–æ–¥ –≤ Long Mode ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —à–∞–≥ –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –û–°. –ë–µ–∑ –Ω–µ–≥–æ –≤—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã 32-–±–∏—Ç–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º 4 –ì–ë –û–ó–£ –∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏.

---

### –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–µ–∞–ª–∏–∏ (2025)

* **–í—Å–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç Long Mode.**
* **Secure Boot –∏ UEFI** —Ç—Ä–µ–±—É—é—Ç –∑–∞–≥—Ä—É–∑—á–∏–∫–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π 64-–±–∏—Ç.
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SMEP/SMAP –∏ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤ Long Mode.
* –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥—Ä–∞–π–≤–µ—Ä—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–∏—à—É—Ç—Å—è –¥–ª—è 64-–±–∏—Ç–Ω–æ–π –û–°.

---

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:

* Intel SDM Vol. 3A ‚Äî –≥–ª–∞–≤—ã –ø–æ Long Mode, Paging, MSR.

* OSDev Wiki: [Entering Long Mode](https://wiki.osdev.org/Entering_Long_Mode)

* UEFI Specification 2.10 ‚Äî —Ä–∞–∑–¥–µ–ª—ã –ø—Ä–æ 64-bit PEI –∏ –∑–∞–≥—Ä—É–∑–∫—É 64-–±–∏—Ç–Ω—ã—Ö –û–°.

* –ö–Ω–∏–≥–∞: "Systems Programming for Linux and Unix" ‚Äî –≥–ª–∞–≤–∞ –ø—Ä–æ —Å–∏—Å—Ç–µ–º–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É.

---

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å: –ü–µ—Ä–µ—Ö–æ–¥ –≤ Long Mode

### –ó–∞–¥–∞—á–∞:

* –ù–∞—Å—Ç—Ä–æ–∏—Ç—å 64-–±–∏—Ç–Ω—ã–µ Page Tables (PML4).
* –í–∫–ª—é—á–∏—Ç—å PAE –∏ Long Mode.
* –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –≤ Long Mode –∏ –≤—ã–∑–≤–∞—Ç—å 64-–±–∏—Ç–Ω—É—é C-—Ñ—É–Ω–∫—Ü–∏—é `kernel_main64`.

---

### –ö–æ–¥: –ê—Å—Å–µ–º–±–ª–µ—Ä–Ω—ã–π –∑–∞–≥—Ä—É–∑—á–∏–∫ (—á–∞—Å—Ç–∏—á–Ω–æ —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π)

```nasm
; longmode.asm ‚Äî –ü–µ—Ä–µ—Ö–æ–¥ –≤ Long Mode (—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º NASM)
BITS 16
ORG 0x7C00

start:
    cli
    xor ax, ax
    mov ds, ax
    mov es, ax
    mov ss, ax
    mov sp, 0x7C00

    ; –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GDT, –∞–∫—Ç–∏–≤–∞—Ü–∏—è Protected Mode
    lgdt [gdt_descriptor]
    mov eax, cr0
    or eax, 1           ; PE = 1
    mov cr0, eax
    jmp 0x08:pm32_start

; Protected Mode (32 –±–∏—Ç)
[BITS 32]
pm32_start:
    mov ax, 0x10
    mov ds, ax
    mov ss, ax

    ; –í–∫–ª—é—á–∞–µ–º PAE
    mov ecx, 0xC0000080         ; MSR_EFER
    rdmsr
    or eax, 1 << 8              ; LME
    wrmsr

    ; –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º CR4 (PAE)
    mov eax, cr4
    or eax, 1 << 5              ; PAE
    mov cr4, eax

    ; –ó–∞–≥—Ä—É–∑–∫–∞ PML4 —Ç–∞–±–ª–∏—Ü
    mov eax, pml4_table
    mov cr3, eax

    ; –í–∫–ª—é—á–∞–µ–º Paging + Protection
    mov eax, cr0
    or eax, 0x80000001
    mov cr0, eax

    ; –ü–µ—Ä–µ—Ö–æ–¥ –≤ Long Mode
    jmp 0x08:long_mode_entry

; –¢–∞–±–ª–∏—Ü–∞ GDT –∏ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç—Ä–∞–Ω–∏—Ü
align 4096
pml4_table:
    dq pdpt | 0x03

pdpt:
    dq pd | 0x03

pd:
    dq 0x0000000000000000 | 0x83    ; 1G mapping (present, rw, 1GB)

; GDT
gdt_start:
    dq 0                        ; Null descriptor
    dq 0x00AF9A000000FFFF       ; Code 64-bit
    dq 0x00AF92000000FFFF       ; Data
gdt_end:

gdt_descriptor:
    dw gdt_end - gdt_start - 1
    dd gdt_start

[BITS 64]
long_mode_entry:
    mov ax, 0x10
    mov ds, ax
    mov ss, ax

    ; –í—ã–∑–æ–≤ 64-–±–∏—Ç–Ω–æ–π C —Ñ—É–Ω–∫—Ü–∏–∏ —è–¥—Ä–∞
    extern kernel_main64
    call kernel_main64

    hlt
    jmp $

```

---

```c
// kernel64.c ‚Äî –ø—Ä–æ—Å—Ç–æ–π 64-–±–∏—Ç–Ω—ã–π C-–∫–æ–¥ —è–¥—Ä–∞
#include <stdint.h>

void kernel_main64() {
    const char *msg = "–û–° –≤ Long Mode!";
    volatile char *video = (volatile char *)0xB8000;
    for (int i = 0; msg[i]; ++i) {
        video[i*2] = msg[i];
        video[i*2+1] = 0x0F;
    }

    while (1) { __asm__("hlt"); }
}
```

---

### –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:

* –í—ã –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –æ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –∫ Protected Mode, –∞ –∑–∞—Ç–µ–º –∫ Long Mode.

* –ó–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω—ã MSR-—Ä–µ–≥–∏—Å—Ç—Ä—ã –∏ 64-–±–∏—Ç–Ω–∞—è –∞–¥—Ä–µ—Å–∞—Ü–∏—è.

* –í—ã–∑–æ–≤ `kernel_main64` –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É 64-–±–∏—Ç–Ω–æ–π —á–∞—Å—Ç–∏ –û–°.

---

## –û—Ü–µ–Ω–∫–∞ —É—Ä–æ–≤–Ω—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: 9/10

–†–∞–±–æ—Ç–∞ —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞–º–∏, MSR, —Ç–∞–±–ª–∏—Ü–∞–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü —Ç—Ä–µ–±—É–µ—Ç –≥–ª—É–±–æ–∫–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.

---

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –≤—Ä–µ–º—è: 10 —á–∞—Å–æ–≤

* –¢–µ–æ—Ä–∏—è: 5 —á
* –ü—Ä–∞–∫—Ç–∏–∫–∞: 5 —á

---

## –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* –ü–æ–¥—Ä–æ–±–Ω–∞—è –ª–µ–∫—Ü–∏—è —Å –ø–æ—à–∞–≥–æ–≤—ã–º–∏ —Å—Ö–µ–º–∞–º–∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏.

* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ QEMU: –æ—Ç–ª–∞–¥–∫–∞ –≤ `gdb` + –¥–∏–∑–∞—Å—Å–µ–º–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ.

* –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞: —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ Long Mode.

* –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Ö–æ–¥ –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–∑–æ–≤ 64-–±–∏—Ç–Ω–æ–≥–æ –∫–æ–¥–∞.

---

üì¶ –ì–æ—Ç–æ–≤ –ø–µ—Ä–µ–π—Ç–∏ –∫ **–£—Ä–æ–∫—É 9**?
