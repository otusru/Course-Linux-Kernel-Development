–û—Ç–ª–∏—á–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º! üöÄ

---

### üîπ –£—Ä–æ–∫ 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PIC (Programmable Interrupt Controller) –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã—Ö –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π

---

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –º—ã –∑–Ω–∞–µ–º, –∫–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π (IDT), –ø—Ä–∏—à–ª–æ –≤—Ä–µ–º—è –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π ‚Äî PIC. –û–Ω —É–ø—Ä–∞–≤–ª—è–µ—Ç –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–º–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è–º–∏ –æ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã, —Ç–∞–π–º–µ—Ä–∞) –∏ –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä. –í —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö PIC –æ–±—ã—á–Ω–æ –∑–∞–º–µ–Ω—ë–Ω APIC, –Ω–æ –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å QEMU –º—ã –∏–∑—É—á–∏–º –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π PIC.

–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã –Ω–∞—É—á–∏–º—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞—Ç—å PIC, –º–∞—Å–∫–∏—Ä–æ–≤–∞—Ç—å –∏ —Ä–∞–∑—Ä–µ—à–∞—Ç—å –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è, –∞ —Ç–∞–∫–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –æ—Ç –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤.

---

### –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ (interrupts/pic.c)

```c
#include <stdint.h>

#define PIC1_COMMAND 0x20
#define PIC1_DATA    0x21
#define PIC2_COMMAND 0xA0
#define PIC2_DATA    0xA1

#define PIC_EOI      0x20 // End of interrupt command code

void io_wait(void)
{
    asm volatile ("outb %%al, $0x80" : : "a"(0));
}

void pic_remap(int offset1, int offset2)
{
    uint8_t a1, a2;

    a1 = inb(PIC1_DATA); // save masks
    a2 = inb(PIC2_DATA);

    outb(PIC1_COMMAND, 0x11); // start initialization
    io_wait();
    outb(PIC2_COMMAND, 0x11);
    io_wait();

    outb(PIC1_DATA, offset1); // remap offset
    io_wait();
    outb(PIC2_DATA, offset2);
    io_wait();

    outb(PIC1_DATA, 0x04); // tell master about slave at IRQ2
    io_wait();
    outb(PIC2_DATA, 0x02); // tell slave its cascade identity
    io_wait();

    outb(PIC1_DATA, 0x01); // environment info
    io_wait();
    outb(PIC2_DATA, 0x01);
    io_wait();

    outb(PIC1_DATA, a1); // restore saved masks
    outb(PIC2_DATA, a2);
}

void pic_send_eoi(unsigned char irq)
{
    if(irq >= 8)
        outb(PIC2_COMMAND, PIC_EOI);

    outb(PIC1_COMMAND, PIC_EOI);
}
```

---

### –ü–æ—è—Å–Ω–µ–Ω–∏—è:

* PIC —É–ø—Ä–∞–≤–ª—è–µ—Ç 16 –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–º–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è–º–∏ (IRQ0‚ÄìIRQ15).
* `pic_remap` –º–µ–Ω—è–µ—Ç —Å–º–µ—â–µ–Ω–∏–µ IRQ –≤ IDT, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è–º–∏ CPU.
* –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å EOI-–∫–æ–º–∞–Ω–¥—É –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π.
* –§—É–Ω–∫—Ü–∏–∏ `inb` –∏ `outb` ‚Äî –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–≤–æ–¥–∞-–≤—ã–≤–æ–¥–∞, —á–∏—Ç–∞—é—Ç –∏ –ø–∏—à—É—Ç –≤ –ø–æ—Ä—Ç—ã.

---

### –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ:

* –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `pic_remap` –∏ –≤—ã–∑–≤–∞—Ç—å –µ—ë –≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –û–°.
* –ù–∞—Å—Ç—Ä–æ–∏—Ç—å IDT –¥–ª—è –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã—Ö IRQ –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–∞–π–º–µ—Ä–Ω–æ–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ (IRQ0).
* –ó–∞–ø—É—Å—Ç–∏—Ç—å –û–° –≤ QEMU, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–≥–æ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞.
* –î–æ–±–∞–≤–∏—Ç—å –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.

---

### –í—Ä–µ–º—è –Ω–∞ –∏–∑—É—á–µ–Ω–∏–µ –∏ –ø—Ä–∞–∫—Ç–∏–∫—É:

* –¢–µ–æ—Ä–∏—è: 3 —á–∞—Å–∞
* –ü—Ä–∞–∫—Ç–∏–∫–∞: 6 —á–∞—Å–æ–≤

---

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:

* OSDev Wiki: PIC ([https://wiki.osdev.org/PIC](https://wiki.osdev.org/PIC))
* Intel SDM (–≥–ª–∞–≤—ã –ø—Ä–æ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è)
* –ö–Ω–∏–≥–∏ –ø–æ —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ x86

---

### –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* –û–±—ä—è—Å–Ω–∏—Ç—å —Ä–æ–ª—å PIC –∏ IRQ –≤ —Å–∏—Å—Ç–µ–º–µ
* –ü–æ–∫–∞–∑–∞—Ç—å, –ø–æ—á–µ–º—É –Ω—É–∂–Ω–∞ –ø–µ—Ä–µ–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–º–µ—â–µ–Ω–∏–π
* –ü–æ—à–∞–≥–æ–≤–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É PIC
* –ü—Ä–∞–∫—Ç–∏–∫–∞ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–º–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è–º–∏ –≤ —ç–º—É–ª—è—Ç–æ—Ä–µ

---

–ü—Ä–æ–¥–æ–ª–∂–∏–º —Å —É—Ä–æ–∫–æ–º –ø—Ä–æ —Ç–∞–π–º–µ—Ä—ã –∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è? üòâ
