–û—Ç–ª–∏—á–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º! üöÄ

---

### üîπ –£—Ä–æ–∫ 2. –°–æ–∑–¥–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ GDT (Global Descriptor Table) ‚Äî –æ—Å–Ω–æ–≤–∞ Protected Mode

---

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –º—ã –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –≤ protected mode, –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–æ–ª–∂–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫ —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–∞–º—è—Ç—å—é –∏ —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏. –î–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–±–ª–∏—Ü–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤ (GDT) ‚Äî —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –æ–ø–∏—Å—ã–≤–∞—é—â–∞—è —Å–µ–≥–º–µ–Ω—Ç—ã –ø–∞–º—è—Ç–∏ –∏ –∏—Ö –∞—Ç—Ä–∏–±—É—Ç—ã.

–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã –Ω–∞—É—á–∏–º—Å—è —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é GDT, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª–∏—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—É –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∞–¥—Ä–µ—Å–æ–≤–∞—Ç—å –ø–∞–º—è—Ç—å –≤ protected mode. –≠—Ç–æ –±–∞–∑–∏—Å –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∏ –≥–∏–±–∫–æ–π —Ä–∞–±–æ—Ç—ã —Å –ø–∞–º—è—Ç—å—é, –≤–∞–∂–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –û–°.

---

### –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ (boot/gdt.asm –∏ boot/gdt.c)

```asm
; gdt.asm ‚Äî –ê—Å—Å–µ–º–±–ª–µ—Ä–Ω—ã–π –∫–æ–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ GDT –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤

[bits 32]

gdt_start:
    ; Null descriptor (–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω)
    dd 0x0
    dd 0x0

    ; –ö–æ–¥–æ–≤—ã–π —Å–µ–≥–º–µ–Ω—Ç: base=0, limit=4GB, executable, readable
    dd 0x0000FFFF         ; limit_low –∏ base_low
    dd 0x00CF9A00         ; base_mid, flags, limit_high, base_high

    ; –î–∞–Ω–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç: base=0, limit=4GB, writable
    dd 0x0000FFFF
    dd 0x00CF9200

gdt_end:

gdt_descriptor:
    dw gdt_end - gdt_start - 1 ; limit (—Ä–∞–∑–º–µ—Ä GDT - 1)
    dd gdt_start               ; base (–∞–¥—Ä–µ—Å –Ω–∞—á–∞–ª–∞ GDT)

; –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ GDT –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤
load_gdt:
    lgdt [gdt_descriptor]      ; –ó–∞–≥—Ä—É–∑–∏—Ç—å GDT –≤ —Ä–µ–≥–∏—Å—Ç—Ä GDTR

    mov ax, 0x10               ; –°–µ–ª–µ–∫—Ç–æ—Ä –¥–∞–Ω–Ω—ã—Ö (–∏–Ω–¥–µ–∫—Å 2 –≤ —Ç–∞–±–ª–∏—Ü–µ)
    mov ds, ax
    mov es, ax
    mov fs, ax
    mov gs, ax
    mov ss, ax

    jmp 0x08:protected_mode_start ; –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –∫–æ–¥–æ–≤—ã–π —Å–µ–≥–º–µ–Ω—Ç –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å

; –ó–¥–µ—Å—å –∫–æ–¥ –¥–ª—è protected_mode_start –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ C –∏–ª–∏ asm –¥–∞–ª–µ–µ

```

```c
// gdt.c ‚Äî –ø—Ä–∏–º–µ—Ä —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ GDT –∏–∑ C (–¥–ª—è —É—á–µ–±–Ω—ã—Ö —Ü–µ–ª–µ–π)

#include <stdint.h>

struct gdt_entry {
    uint16_t limit_low;           // –ú–ª–∞–¥—à–∏–µ 16 –±–∏—Ç –ª–∏–º–∏—Ç–∞
    uint16_t base_low;            // –ú–ª–∞–¥—à–∏–µ 16 –±–∏—Ç –±–∞–∑—ã
    uint8_t  base_middle;         // –°–ª–µ–¥—É—é—â–∏–µ 8 –±–∏—Ç –±–∞–∑—ã
    uint8_t  access;              // –ë–∞–π—Ç –¥–æ—Å—Ç—É–ø–∞ (—Ç–∏–ø —Å–µ–≥–º–µ–Ω—Ç–∞)
    uint8_t  granularity;         // –õ–∏–º–∏—Ç –∏ —Ñ–ª–∞–≥–∏
    uint8_t  base_high;           // –°—Ç–∞—Ä—à–∏–µ 8 –±–∏—Ç –±–∞–∑—ã
} __attribute__((packed));

struct gdt_ptr {
    uint16_t limit;               // –†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã
    uint64_t base;                // –ê–¥—Ä–µ—Å —Ç–∞–±–ª–∏—Ü—ã (64-–±–∏—Ç –¥–ª—è x86-64)
} __attribute__((packed));

struct gdt_entry gdt[3];
struct gdt_ptr gp;

void set_gdt_entry(int num, uint32_t base, uint32_t limit, uint8_t access, uint8_t gran)
{
    gdt[num].base_low    = (base & 0xFFFF);
    gdt[num].base_middle = (base >> 16) & 0xFF;
    gdt[num].base_high   = (base >> 24) & 0xFF;

    gdt[num].limit_low   = (limit & 0xFFFF);
    gdt[num].granularity = (limit >> 16) & 0x0F;

    gdt[num].granularity |= (gran & 0xF0);
    gdt[num].access      = access;
}

extern void gdt_flush(uint64_t);

void gdt_install()
{
    gp.limit = (sizeof(struct gdt_entry) * 3) - 1;
    gp.base  = (uint64_t)&gdt;

    set_gdt_entry(0, 0, 0, 0, 0);                // Null —Å–µ–≥–º–µ–Ω—Ç
    set_gdt_entry(1, 0, 0xFFFFFFFF, 0x9A, 0xA0); // –ö–æ–¥–æ–≤—ã–π —Å–µ–≥–º–µ–Ω—Ç
    set_gdt_entry(2, 0, 0xFFFFFFFF, 0x92, 0xA0); // –î–∞–Ω–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç

    gdt_flush((uint64_t)&gp);
}
```

---

### –ü–æ—è—Å–Ω–µ–Ω–∏—è:

* GDT –æ–ø–∏—Å—ã–≤–∞–µ—Ç 3 —Å–µ–≥–º–µ–Ω—Ç–∞: null, –∫–æ–¥–æ–≤—ã–π –∏ –¥–∞–Ω–Ω—ã–µ.
* Null-—Å–µ–≥–º–µ–Ω—Ç –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω ‚Äî –æ–Ω –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –Ω–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤.
* –ö–æ–¥–æ–≤—ã–π —Å–µ–≥–º–µ–Ω—Ç ‚Äî —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ —á—Ç–µ–Ω–∏–µ.
* –î–∞–Ω–Ω—ã–µ ‚Äî –¥–ª—è —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏.
* –ê—Å—Å–µ–º–±–ª–µ—Ä–Ω—ã–π –∫–æ–¥ –∑–∞–≥—Ä—É–∂–∞–µ—Ç GDT –≤ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å–µ–≥–º–µ–Ω—Ç–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã.
* –í C –ø–æ–∫–∞–∑–∞–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ GDT, –∞ —Ç–∞–∫–∂–µ –≤—ã–∑–æ–≤ –≤–Ω–µ—à–Ω–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ `gdt_flush`, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω–∏—Ç asm-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é `lgdt`.

---

### –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ:

* –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏ —Å–æ–±—Ä–∞—Ç—å –∑–∞–≥—Ä—É–∑—á–∏–∫ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π GDT.
* –î–æ–±–∞–≤–∏—Ç—å –∫–æ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤.
* –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ —ç–º—É–ª—è—Ç–æ—Ä–µ (QEMU) –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ protected mode (–º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —á–µ—Ä–µ–∑ –æ—Ç–ª–∞–¥—á–∏–∫).
* –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å–µ–≥–º–µ–Ω—Ç—ã –∏ –Ω–∞–±–ª—é–¥–∞—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ.

---

### –í—Ä–µ–º—è –Ω–∞ –∏–∑—É—á–µ–Ω–∏–µ –∏ –ø—Ä–∞–∫—Ç–∏–∫—É:

* –¢–µ–æ—Ä–∏—è: 3 —á–∞—Å–∞
* –ü—Ä–∞–∫—Ç–∏–∫–∞: 5 —á–∞—Å–æ–≤

---

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:

* Intel SDM (Vol 3, –≥–ª–∞–≤–∞ –ø—Ä–æ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—é)
* OSDev Wiki: GDT ([https://wiki.osdev.org/Global\_Descriptor\_Table](https://wiki.osdev.org/Global_Descriptor_Table))
* –í–∏–¥–µ–æ—É—Ä–æ–∫–∏ –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ x86

---

### –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* –û–±—ä—è—Å–Ω–µ–Ω–∏–µ, –∑–∞—á–µ–º –Ω—É–∂–Ω–∞ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è
* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∞ –∏ —á—Ç–æ –æ–∑–Ω–∞—á–∞—é—Ç –±–∏—Ç—ã
* –ü–æ—à–∞–≥–æ–≤—ã–π —Ä–∞–∑–±–æ—Ä –∞—Å—Å–µ–º–±–ª–µ—Ä–Ω–æ–≥–æ –∫–æ–¥–∞
* –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞ —Å QEMU –∏ gdb –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

---

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —Å—Ä–∞–∑—É —Å–¥–µ–ª–∞—é —É—Ä–æ–∫ 3 ‚Äî –ø—Ä–æ IDT –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π?
–ò–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –µ—Å—Ç—å? üòä
