–û—Ç–ª–∏—á–Ω–æ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º! üöÄ

---

### üîπ –£—Ä–æ–∫ 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ IDT (Interrupt Descriptor Table) –∏ –±–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π

---

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –º—ã –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ GDT –∏ –≤–æ—à–ª–∏ –≤ protected mode, –Ω–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–º–µ—Ç—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è ‚Äî –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –∏ –ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∑–≤–æ–ª—è—é—Ç –û–° —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ —Å–∏–≥–Ω–∞–ª—ã, –æ—à–∏–±–∫–∏ –∏–ª–∏ –∑–∞–ø—Ä–æ—Å—ã. –î–ª—è —ç—Ç–æ–≥–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π ‚Äî IDT.

–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã –∏–∑—É—á–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É IDT, –Ω–∞—É—á–∏–º—Å—è —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å –µ—ë, –∞ —Ç–∞–∫–∂–µ —Ä–µ–∞–ª–∏–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–π —Å–º–æ–∂–µ—Ç —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–∞–π–º–µ—Ä.

---

### –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ (interrupts/idt.asm –∏ interrupts/idt.c)

```asm
; idt.asm ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è IDT

[bits 32]

section .data
idt_start:
    times 256 dq 0             ; 256 –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤, –∫–∞–∂–¥—ã–π –ø–æ 8 –±–∞–π—Ç
idt_end:

idt_descriptor:
    dw idt_end - idt_start - 1 ; —Ä–∞–∑–º–µ—Ä IDT - 1
    dd idt_start               ; –∞–¥—Ä–µ—Å –Ω–∞—á–∞–ª–∞ IDT

section .text

; –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ IDT
load_idt:
    lidt [idt_descriptor]
    ret

; –ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (ISR 0)
isr0:
    pusha
    ; –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
    popa
    iretd
```

```c
// idt.c ‚Äî –ø—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ IDT –Ω–∞ C

#include <stdint.h>

struct idt_entry {
    uint16_t base_low;
    uint16_t sel;
    uint8_t  always0;
    uint8_t  flags;
    uint16_t base_high;
} __attribute__((packed));

struct idt_ptr {
    uint16_t limit;
    uint32_t base;
} __attribute__((packed));

struct idt_entry idt[256];
struct idt_ptr idtp;

extern void idt_load();

void set_idt_gate(int n, uint32_t handler)
{
    idt[n].base_low = handler & 0xFFFF;
    idt[n].sel = 0x08;  // –ö–æ–¥–æ–≤—ã–π —Å–µ–≥–º–µ–Ω—Ç
    idt[n].always0 = 0;
    idt[n].flags = 0x8E; // –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ, –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    idt[n].base_high = (handler >> 16) & 0xFFFF;
}

void idt_install()
{
    idtp.limit = sizeof(struct idt_entry) * 256 -1;
    idtp.base = (uint32_t)&idt;

    for(int i = 0; i < 256; i++)
        set_idt_gate(i, 0); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω—É–ª—è–º–∏

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤–∞–∂–Ω—ã—Ö –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π
    extern void isr0();
    set_idt_gate(0, (uint32_t)isr0);

    idt_load();
}
```

---

### –ü–æ—è—Å–Ω–µ–Ω–∏—è:

* IDT —Å–æ–¥–µ—Ä–∂–∏—Ç 256 –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π. –ö–∞–∂–¥—ã–π –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∞–¥—Ä–µ—Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞.
* –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–¥—Ä–µ—Å, —Å–µ–≥–º–µ–Ω—Ç–Ω—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä, –∏ —Ñ–ª–∞–≥–∏.
* –í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã —Å–æ–∑–¥–∞–ª–∏ –±–∞–∑–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É –∏ –æ–¥–∏–Ω –ø—Ä–æ—Å—Ç–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ (ISR0).
* –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ IDT –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –±—É–¥–µ—Ç –∑–Ω–∞—Ç—å, –∫—É–¥–∞ –ø—Ä—ã–≥–∞—Ç—å –ø—Ä–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è—Ö.

---

### –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ:

* –°–æ–∑–¥–∞—Ç—å –∏ —Å–æ–±—Ä–∞—Ç—å –∫–æ–¥ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π IDT.
* –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–∞–∑–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä—ã.
* –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ QEMU, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å –ø–æ–º–æ—â—å—é –æ—Ç–ª–∞–¥—á–∏–∫–∞.
* –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤—ã–∑–≤–∞—Ç—å –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `int 0`), –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç.

---

### –í—Ä–µ–º—è –Ω–∞ –∏–∑—É—á–µ–Ω–∏–µ –∏ –ø—Ä–∞–∫—Ç–∏–∫—É:

* –¢–µ–æ—Ä–∏—è: 3 —á–∞—Å–∞
* –ü—Ä–∞–∫—Ç–∏–∫–∞: 5 —á–∞—Å–æ–≤

---

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:

* Intel SDM (Vol 3, –≥–ª–∞–≤–∞ –æ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è—Ö)
* OSDev Wiki: Interrupt Descriptor Table ([https://wiki.osdev.org/IDT](https://wiki.osdev.org/IDT))
* –í–∏–¥–µ–æ—É—Ä–æ–∫–∏ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π

---

### –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* –ü–æ—è—Å–Ω–µ–Ω–∏–µ –≤–∞–∂–Ω–æ—Å—Ç–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π –∏ –∏—Ö —Ä–æ–ª—å
* –ü–æ—à–∞–≥–æ–≤—ã–π —Ä–∞–∑–±–æ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã IDT
* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∏ IDT –≤ —ç–º—É–ª—è—Ç–æ—Ä–µ
* –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π –≤ QEMU + GDB

---

–ì–æ—Ç–æ–≤ –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ? –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫ ‚Äî **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ PIC –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã—Ö –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π**? üòâ
