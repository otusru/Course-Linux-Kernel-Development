–û—Ç–ª–∏—á–Ω–æ! –ü–æ–≥—Ä—É–∂–∞–µ–º—Å—è –¥–∞–ª—å—à–µ –≤ —Å–µ—Ç–µ–≤—ã–µ –≥–ª—É–±–∏–Ω—ã! üåê‚ö°Ô∏è

---

### üîπ –£—Ä–æ–∫ 15. –ü—Ä–æ—Ç–æ–∫–æ–ª IP: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è

---

**–û–ø–∏—Å–∞–Ω–∏–µ:**
IP (Internet Protocol) ‚Äî —ç—Ç–æ –æ—Å–Ω–æ–≤–∞ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–π, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∞—è –∞–¥—Ä–µ—Å–∞—Ü–∏—é –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é –ø–∞–∫–µ—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–µ—Ç–∏. –í —ç—Ç–æ–º —É—Ä–æ–∫–µ –º—ã –ø–æ–¥—Ä–æ–±–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º —Ñ–æ—Ä–º–∞—Ç IP-–ø–∞–∫–µ—Ç–∞, —Ä–∞–±–æ—Ç—É —Å IP-–∞–¥—Ä–µ—Å–∞–º–∏, —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—é –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é, –∞ —Ç–∞–∫–∂–µ —Ä–µ–∞–ª–∏–∑—É–µ–º –±–∞–∑–æ–≤—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É IP-–ø–∞–∫–µ—Ç–æ–≤ –≤ –Ω–∞—à–µ–π –û–°.

–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã:

* –§–æ—Ä–º–∞—Ç IPv4-–ø–∞–∫–µ—Ç–∞: –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ø–æ–ª—è
* –ê–¥—Ä–µ—Å–∞—Ü–∏—è: IPv4 –∏ –≤–≤–µ–¥–µ–Ω–∏–µ –≤ IPv6
* –§—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Å–±–æ—Ä–∫–∞ –ø–∞–∫–µ—Ç–æ–≤
* –û—Å–Ω–æ–≤—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∏ —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ä—à—Ä—É—Ç–æ–≤
* –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –∏ –∏—Å—Ö–æ–¥—è—â–∏—Ö IP-–ø–∞–∫–µ—Ç–æ–≤

---

### –ü—Ä–∏–º–µ—Ä –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ (network/ip.c)

```c
#include <stdint.h>
#include <string.h>

typedef struct {
    uint8_t  version_ihl;
    uint8_t  tos;
    uint16_t total_length;
    uint16_t identification;
    uint16_t flags_fragment_offset;
    uint8_t  ttl;
    uint8_t  protocol;
    uint16_t header_checksum;
    uint32_t src_addr;
    uint32_t dst_addr;
} __attribute__((packed)) ipv4_header_t;

uint16_t calculate_checksum(uint16_t* data, int length)
{
    uint32_t sum = 0;
    for(int i = 0; i < length / 2; i++) {
        sum += data[i];
    }
    while(sum >> 16) {
        sum = (sum & 0xFFFF) + (sum >> 16);
    }
    return (uint16_t)(~sum);
}

void handle_ip_packet(uint8_t* packet)
{
    ipv4_header_t* ip_hdr = (ipv4_header_t*)packet;

    if((ip_hdr->version_ihl >> 4) != 4) return; // –ü—Ä–æ–≤–µ—Ä–∫–∞ IPv4

    uint16_t checksum = calculate_checksum((uint16_t*)ip_hdr, (ip_hdr->version_ihl & 0x0F)*4);
    if(checksum != 0) return; // –û—à–∏–±–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º—ã

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É (TCP/UDP)
    switch(ip_hdr->protocol) {
        case 6: // TCP
            handle_tcp_packet(packet + (ip_hdr->version_ihl & 0x0F)*4);
            break;
        case 17: // UDP
            handle_udp_packet(packet + (ip_hdr->version_ihl & 0x0F)*4);
            break;
        default:
            // –ü—Ä–æ—Ç–æ–∫–æ–ª –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
            break;
    }
}
```

---

### –ü–æ—è—Å–Ω–µ–Ω–∏—è:

* –ó–∞–≥–æ–ª–æ–≤–æ–∫ IPv4 —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–∂–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–∫–µ—Ç–∞–º–∏.
* –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞—â–∏—â–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç –æ—à–∏–±–æ–∫ –ø–µ—Ä–µ–¥–∞—á–∏.
* –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ —É—Ä–æ–≤–Ω—è –≤—ã—à–µ (TCP, UDP).
* –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø–∞–∫–µ—Ç—ã —á–µ—Ä–µ–∑ –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å–µ—Ç–µ–π.

---

### –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ:

* –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∑–∞–≥–æ–ª–æ–≤–∫–∞ IP-–ø–∞–∫–µ—Ç–∞.
* –ù–∞–ø–∏—Å–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º—ã.
* –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –±–∞–∑–æ–≤—ã–µ —Ç–∏–ø—ã –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤ (TCP/UDP).
* –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É IP-–ø–∞–∫–µ—Ç–æ–≤ –≤ —ç–º—É–ª—è—Ç–æ—Ä–µ —Å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π —Å–µ—Ç—å—é.

---

### –í—Ä–µ–º—è –Ω–∞ –∏–∑—É—á–µ–Ω–∏–µ –∏ –ø—Ä–∞–∫—Ç–∏–∫—É:

* –¢–µ–æ—Ä–∏—è: 5 —á–∞—Å–æ–≤
* –ü—Ä–∞–∫—Ç–∏–∫–∞: 8 —á–∞—Å–æ–≤

---

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:

* RFC 791 ‚Äî IPv4
* OSDev Wiki: IP Networking ([https://wiki.osdev.org/IP](https://wiki.osdev.org/IP))
* –ö–Ω–∏–≥–∏ –ø–æ —Å–µ—Ç–µ–≤—ã–º –ø—Ä–æ—Ç–æ–∫–æ–ª–∞–º –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

---

### –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* –†–∞–∑–±–æ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã IP-–ø–∞–∫–µ—Ç–∞ —Å –¥–∏–∞–≥—Ä–∞–º–º–∞–º–∏
* –ü–æ—à–∞–≥–æ–≤–æ–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –∫–æ–¥–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
* –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã –∏ –æ—Ç–ª–∞–¥–∫–∞
* –û–±—Å—É–∂–¥–µ–Ω–∏–µ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤ IPv6

---

–ì–æ—Ç–æ–≤ –∫ —É—Ä–æ–∫—É 16 ‚Äî TCP –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏? üõ†Ô∏è

