–°—É–ø–µ—Ä! –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–≥—Ä—É–∂–∞—Ç—å—Å—è –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é! üíæ‚ú®

---

### üîπ –£—Ä–æ–∫ 8. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é: –ê–ª–ª–æ–∫–∞—Ç–æ—Ä—ã –ø–∞–º—è—Ç–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ page fault (–∏—Å–∫–ª—é—á–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã)

---

**–û–ø–∏—Å–∞–Ω–∏–µ:**
–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏, —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º —è–≤–ª—è–µ—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ–º –ø–∞–º—è—Ç–∏. –ê–ª–ª–æ–∫–∞—Ç–æ—Ä—ã —É–ø—Ä–∞–≤–ª—è—é—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –ø–∞–º—è—Ç—å—é –≤ —è–¥—Ä–µ –û–°, –ø–æ–∑–≤–æ–ª—è—è –±–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã–¥–µ–ª—è—Ç—å –æ–±–ª–∞—Å—Ç–∏ –ø–æ–¥ –¥–∞–Ω–Ω—ã–µ –∏ –∫–æ–¥. –í–∞–∂–Ω–æ–π —á–∞—Å—Ç—å—é —Ä–∞–±–æ—Ç—ã —Å –ø–∞–º—è—Ç—å—é —è–≤–ª—è—é—Ç—Å—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã (page faults) ‚Äî –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è, –≤–æ–∑–Ω–∏–∫–∞—é—â–∏–µ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–µ—Ä–∞–∑—Ä–µ—à—ë–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.

–í —ç—Ç–æ–º —É—Ä–æ–∫–µ –≤—ã —Ä–µ–∞–ª–∏–∑—É–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ–π –∞–ª–ª–æ–∫–∞—Ç–æ—Ä –ø–∞–º—è—Ç–∏ –¥–ª—è —è–¥—Ä–∞, –∏–∑—É—á–∏—Ç–µ –º–µ—Ö–∞–Ω–∏–∑–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ page fault, –Ω–∞—É—á–∏—Ç–µ—Å—å –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—ã–¥–µ–ª—è—Ç—å –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É, –≤—ã–¥–∞–≤–∞—Ç—å –æ—à–∏–±–∫—É, –∑–∞–≤–µ—Ä—à–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å).

---

### –ü—Ä–∏–º–µ—Ä –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ (memory/alloc.c + exceptions/pagefault.c)

```c
#include <stdint.h>

#define PAGE_SIZE 4096
#define KERNEL_HEAP_START 0x1000000
#define KERNEL_HEAP_SIZE  0x1000000

static uint8_t kernel_heap[KERNEL_HEAP_SIZE];
static uint8_t* heap_ptr = kernel_heap;

void* kmalloc(uint64_t size)
{
    if(heap_ptr + size > kernel_heap + KERNEL_HEAP_SIZE)
        return 0; // –ù–µ—Ç –ø–∞–º—è—Ç–∏

    void* ptr = heap_ptr;
    heap_ptr += size;
    return ptr;
}
```

```c
#include <stdint.h>
#include <stdbool.h>

extern void panic(const char* msg);

void pagefault_handler(uint64_t error_code, uint64_t faulting_address)
{
    // error_code –±–∏—Ç—ã:
    // bit 0 - present (0 = –Ω–µ present)
    // bit 1 - write (1 = –∑–∞–ø–∏—Å—å)
    // bit 2 - user (1 = –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ä–µ–∂–∏–º)
    
    bool present = error_code & 0x1;
    bool write = error_code & 0x2;
    bool user = error_code & 0x4;

    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏—á–∏–Ω—É –æ—à–∏–±–∫–∏
    if(!present) {
        // –ü–æ–ø—ã—Ç–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–µ–≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ ‚Äî –º–æ–∂–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –ø–∞–Ω–∏–∫–æ–≤–∞—Ç—å
        panic("Page fault: –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç");
    } else if(write) {
        panic("Page fault: –ó–∞–ø–∏—Å—å –≤ –∑–∞—â–∏—â—ë–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É");
    } else {
        panic("Page fault: –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞");
    }
}
```

---

### –ü–æ—è—Å–Ω–µ–Ω–∏—è:

* –ü—Ä–æ—Å—Ç–æ–π –ª–∏–Ω–µ–π–Ω—ã–π –∞–ª–ª–æ–∫–∞—Ç–æ—Ä –¥–ª—è —è–¥—Ä–∞ (–±–µ–∑ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è) ‚Äî –æ—Å–Ω–æ–≤–∞ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è.
* –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî –∫—Ä–∏—Ç–∏—á–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –û–°.
* –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ –æ—à–∏–±–∫–∏ –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å, –∫–∞–∫–∞—è –∏–º–µ–Ω–Ω–æ –æ—à–∏–±–∫–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞.
* –í —Ä–µ–∞–ª—å–Ω—ã—Ö –û–° –≤–æ–∑–º–æ–∂–Ω–∞ –ø–æ–¥–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é (demand paging).

---

### –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ:

* –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π –∞–ª–ª–æ–∫–∞—Ç–æ—Ä kmalloc.
* –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –≤—ã–≤–æ–¥–æ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
* –í—ã–∑–≤–∞—Ç—å page fault, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ø—ã—Ç–∫–æ–π –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–µ–≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏.
* –†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –±–∞–∑–æ–≤—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã.

---

### –í—Ä–µ–º—è –Ω–∞ –∏–∑—É—á–µ–Ω–∏–µ –∏ –ø—Ä–∞–∫—Ç–∏–∫—É:

* –¢–µ–æ—Ä–∏—è: 3 —á–∞—Å–∞
* –ü—Ä–∞–∫—Ç–∏–∫–∞: 6 —á–∞—Å–æ–≤

---

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã:

* OSDev Wiki: Page Fault ([https://wiki.osdev.org/Page\_Fault](https://wiki.osdev.org/Page_Fault))
* Intel SDM ‚Äî —Ä–∞–∑–¥–µ–ª –∏—Å–∫–ª—é—á–µ–Ω–∏–π –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–º—è—Ç—å—é
* –ö–Ω–∏–≥–∏ –ø–æ –û–° –∏ –ø–∞–º—è—Ç–∏

---

### –ú–µ—Ç–æ–¥–∏–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞–Ω–∏—è:

* –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ page fault –∏ –∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è
* –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–∞ –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ
* –û—Ç–ª–∞–¥–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –≤ —ç–º—É–ª—è—Ç–æ—Ä–µ QEMU
* –î–∏—Å–∫—É—Å—Å–∏—è –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–æ–≤ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

---

–ì–æ—Ç–æ–≤ –∫ —É—Ä–æ–∫—É 9 ‚Äî –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á –∏ –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å? üòé

